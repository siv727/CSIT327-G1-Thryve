{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thryve ‚Ä¢ Marketplace</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            sky: '#83e6f5', /* landing page sky blue */
                            leaf: '#3ac363', /* landing page light green */
                            ink: '#0f172a'
                        }
                    },
                    boxShadow: {
                        soft: '0 10px 28px rgba(2, 8, 23, .06)'
                    },
                    fontFamily: {
                        inter: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    borderRadius: {
                        xl2: '1rem'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-inter bg-[#f7fbfd] text-brand-ink">

    <header class="bg-[#23d3ee] text-white shadow">
        <div class="max-w-7xl mx-auto h-16 px-6 flex items-center justify-between">

            <a href="{% url 'home' %}" class="flex items-center gap-2">
                <span
                    class="inline-flex items-center justify-center w-8 h-8 rounded-md bg-white font-black text-[#23d3ee]">T</span>
                <span class="text-[22px] font-extrabold tracking-tight">Thryve</span>
            </a>

            {% with active=request.resolver_match.url_name %}
            <nav class="flex items-center gap-8 text-[15px] font-medium">
                <a href="{% url 'home' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h18l-1.68 9.39a2 2 0 01-1.98 1.61H6.66a2 2 0 01-1.98-1.61L3 3zM16 16a3 3 0 11-6 0"></path>
                    </svg>
                    <span class="leading-none">Marketplace</span>
                    {% if active == 'home' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'thryve_app:my_listings' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="leading-none">My Listings</span>
                    {% if active == 'my_listings' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="#" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V4H2v16h5M17 8l-5 5-5-5" />
                    </svg>
                    <span class="leading-none">Community</span>
                    {% if active == 'community' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

        <!-- Bookings -->
        <a href="{% url 'bookings' %}" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z" />
          </svg>
          <span class="leading-none">Bookings</span>
          {% if active == 'bookings' %}
          <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
          {% endif %}
        </a>

                <a href="{% url 'business_profile' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 21a8 8 0 10-16 0m8-9a4 4 0 100-8 4 4 0 000 8z" />
                    </svg>
                    <span class="leading-none">Profile</span>
                    {% if active == 'business_profile' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>
            </nav>
            {% endwith %}

      <!-- Right: Logout -->
      <button onclick="openLogoutModal()" type="button"
        class="flex items-center gap-2 font-medium text-white/90 hover:text-white transition-all text-[15px]">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H5a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1" />
        </svg>
        <span class="leading-none">Logout</span>
      </button>

    </div>
  </header>





  <!-- Main -->
  <main class="max-w-[1200px] mx-auto px-5 py-8">
    <!-- Page header -->
    <div class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-[38px] leading-[1.1] font-extrabold">Marketplace</h1>
        <p class="text-slate-600 mt-1">Buy, sell, or swap equipment and services with confidence.</p>
      </div>
      <a href="#"
        class="inline-flex items-center gap-2 rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold px-4 py-2.5 shadow-soft transition">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-width="2" d="M12 5v14M5 12h14" />
        </svg>
        Add Listing
      </a>
    </div>

        <section class="bg-white/90 backdrop-blur rounded-xl shadow-soft border border-slate-100 p-5 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Search</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="11" cy="11" r="7" stroke-width="2" />
                                <path stroke-width="2" d="M21 21l-4.3-4.3" />
                            </svg>
                        </span>
                        <input
                            class="w-full rounded-lg border border-slate-200 pl-10 pr-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                            placeholder="Search items, services, or locations‚Ä¶" />
                    </div>
                </div>

                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Category</label>
                    <div class="relative">
                        <select
                            class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium appearance-none focus:outline-none focus:ring-2 focus:ring-brand-sky">
                            <option>All Categories</option>
                            <option>Electronics</option>
                            <option>Furniture</option>
                            <option>Tools & Equipment</option>
                            <option>Raw Materials</option>
                            <option>Services</option>
                            <option>Other</option>
                        </select>
                        <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">‚ñæ</span>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="text-slate-700 font-semibold mb-3">Type</div>
                <div class="flex flex-wrap items-center gap-2">
                    <button
                        class="px-4 py-2 rounded-full bg-brand-sky text-slate-900 font-semibold hover:brightness-105 transition">All</button>
                    <button class="px-4 py-2 rounded-full border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10">For
                        Sale</button>
                    <button
                        class="px-4 py-2 rounded-full border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10">Swap</button>
                    <button
                        class="px-4 py-2 rounded-full border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10">Wanted</button>
                </div>
            </div>
        </section>

        <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% for listing in listings %}
            <article class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col hover:-translate-y-2 hover:shadow-lg transition-all duration-300" data-listing-id="{{ listing.id }}" data-images="{% for image in listing.images.all %}{{ image.image.url }}{% if not forloop.last %},{% endif %}{% endfor %}" data-title="{{ listing.title }}" data-description="{{ listing.description|safe }}" data-price="{% if listing.listing_type == 'sale' and listing.price %}‚Ç±{{ listing.price }}{% endif %}" data-swap-for="{% if listing.listing_type == 'swap' and listing.swap_for %}{{ listing.swap_for }}{% endif %}" data-budget="{% if listing.listing_type == 'buy' and listing.budget %}‚Ç±{{ listing.budget }}{% endif %}" data-location="{{ listing.location }}" data-created-at="{{ listing.created_at|date:'m/d/Y' }}" data-your-name="{{ listing.your_name }}" data-company="{{ listing.company }}" data-listing-type="{{ listing.listing_type }}" data-category="{% if listing.category %}{{ listing.category }}{% endif %}" data-subcategory="{% if listing.subcategory %}{{ listing.subcategory }}{% endif %}">
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4 cursor-pointer" onclick="openImageGallery('{{ listing.id }}')">
                    {% if listing.main_image %}
                        <img src="{{ listing.main_image.image.url }}" alt="{{ listing.title }}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                    {% else %}
                        <img src="{% static 'thryve_app/images/listing-placeholder.png' %}" alt="No image available" class="w-full h-full object-cover">
                    {% endif %}
                </div>

                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        {% if listing.listing_type == 'sale' %}
                            <span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                SALE
                            </span>
                        {% elif listing.listing_type == 'swap' %}
                            <span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                                SWAP
                            </span>
                        {% elif listing.listing_type == 'buy' %}
                            <span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                                BUY
                            </span>
                        {% endif %}
                        {% if listing.category %}
                            {% if listing.subcategory %}
                                <span class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                                    {% if listing.category == 'electronics' %}
                                        {% if listing.subcategory == 'computers' %}Computers{% elif listing.subcategory == 'phones' %}Phones{% elif listing.subcategory == 'tablets' %}Tablets{% elif listing.subcategory == 'audio_video' %}Audio/Video Equipment{% elif listing.subcategory == 'cameras' %}Cameras{% else %}Other Electronics{% endif %}
                                    {% elif listing.category == 'furniture' %}
                                        {% if listing.subcategory == 'office_chairs' %}Office Chairs{% elif listing.subcategory == 'desks' %}Desks{% elif listing.subcategory == 'cabinets' %}Cabinets{% elif listing.subcategory == 'tables' %}Tables{% elif listing.subcategory == 'seating' %}Seating{% else %}Other Furniture{% endif %}
                                    {% elif listing.category == 'tools_equipment' %}
                                        {% if listing.subcategory == 'power_tools' %}Power Tools{% elif listing.subcategory == 'hand_tools' %}Hand Tools{% elif listing.subcategory == 'machinery' %}Machinery{% elif listing.subcategory == 'safety_equipment' %}Safety Equipment{% elif listing.subcategory == 'measuring_tools' %}Measuring Tools{% else %}Other Tools & Equipment{% endif %}
                                    {% elif listing.category == 'raw_materials' %}
                                        {% if listing.subcategory == 'metals' %}Metals{% elif listing.subcategory == 'plastics' %}Plastics{% elif listing.subcategory == 'woods' %}Woods{% elif listing.subcategory == 'chemicals' %}Chemicals{% elif listing.subcategory == 'fabrics' %}Fabrics{% else %}Other Raw Materials{% endif %}
                                    {% elif listing.category == 'services' %}
                                        {% if listing.subcategory == 'consulting' %}Consulting{% elif listing.subcategory == 'maintenance' %}Maintenance{% elif listing.subcategory == 'installation' %}Installation{% elif listing.subcategory == 'training' %}Training{% elif listing.subcategory == 'design' %}Design{% else %}Other Services{% endif %}
                                    {% else %}
                                        Miscellaneous
                                    {% endif %}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                                    {% if listing.category == 'electronics' %}Electronics{% elif listing.category == 'furniture' %}Furniture{% elif listing.category == 'tools_equipment' %}Tools & Equipment{% elif listing.category == 'raw_materials' %}Raw Materials{% elif listing.category == 'services' %}Services{% else %}Other{% endif %}
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center gap-1 text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Available
                    </span>
                </div>
                {% if listing.title|length > 25 %}
                <div class="title-scroll-container relative">
                    <div class="title-scroll-text whitespace-nowrap">
                        <h3 class="text-lg font-bold inline-block">{{ listing.title }}</h3>
                        <span class="title-spacer text-lg font-bold inline-block" aria-hidden="true">{{ listing.title }}</span>
                    </div>
                </div>
                {% else %}
                <h3 class="text-lg font-bold truncate">{{ listing.title }}</h3>
                {% endif %}
                <div class="mt-0.5 text-slate-500 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <strong>{{ listing.your_name }}</strong> | {{ listing.company }}
                </div>
                <div class="relative mt-3 text-slate-700 h-[1.5rem] overflow-hidden">
                    {% with stripped_desc=listing.description|striptags %}
                        {% if stripped_desc|length > 120 %}

                            <p class="whitespace-nowrap inline-block pr-16">
                                 {{ stripped_desc|slice:":95" }}
                            </p>

                            <span class="absolute right-0 bottom-0 bg-white pl-2 z-10 cursor-pointer" onclick="openListingDetailsModal('{{ listing.id }}')">
                                <span class="font-semibold text-slate-700 hover:text-brand-leaf transition-colors duration-200">... See More</span>
                            </span>
                        {% else %}
                            <div class="description-preview">{{ listing.description|safe }}</div>
                        {% endif %}
                    {% endwith %}
                </div>

                {% if listing.listing_type == 'sale' and listing.price %}
                    <div class="mt-4 text-[22px] font-extrabold text-brand-leaf">‚Ç±{{ listing.price }}</div>
                {% elif listing.listing_type == 'swap' and listing.swap_for %}
                    <div class="mt-4 text-[22px] font-extrabold"><span class="text-slate-700">Looking for:</span> <span class="text-brand-leaf">{{ listing.swap_for }}</span></div>
                {% elif listing.listing_type == 'buy' and listing.budget %}
                    <div class="mt-4 text-[22px] font-extrabold"><span class="text-slate-700">Budget:</span> <span class="text-brand-leaf">‚Ç±{{ listing.budget }}</span></div>
                {% endif %}

                <div class="mt-2 flex items-center justify-between text-sm text-slate-500 font-medium">
                    <span class="flex items-center gap-1 max-w-[60%]">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        {% if listing.location|length > 20 %}
                        <div class="location-scroll-container">
                            <div class="location-scroll-text whitespace-nowrap">
                                <span class="inline-block">{{ listing.location }}</span>
                                <span class="location-spacer inline-block" aria-hidden="true">{{ listing.location }}</span>
                            </div>
                        </div>
                        {% else %}
                        <span class="truncate">{{ listing.location }}</span>
                        {% endif %}
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ listing.created_at|date:"m/d/Y" }}
                    </span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    {% if is_my_listings %}
                        <button onclick="openEditListingModal('{{ listing.id }}')" class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">Edit Details</button>
                        <button onclick="openDeleteListingModal('{{ listing.id }}')" class="text-center rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5">Delete</button>
                    {% else %}
                        <button onclick="openListingDetailsModal('{{ listing.id }}')" class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View Details</button>
                        <button onclick="openBookNowModal('{{ listing.id }}')" class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book Now</button>
                    {% endif %}
                </div>
            </article>
            {% empty %}
            <article class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col">
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4">
                    <img src="{% static 'thryve_app/images/listing-placeholder.jpg' %}" alt="No image available" class="w-full h-full object-cover">
                </div>

                <div class="flex items-center justify-between mb-3">
                    <span
                        class="inline-flex items-center gap-2 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full">SALE</span>
                    <span
                        class="text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">available</span>
                </div>
                <h3 class="text-lg font-bold">Industrial 3D Printer</h3>
                <div class="mt-0.5 text-slate-500 font-medium">TechFab Solutions</div>
                <p class="mt-3 text-slate-700">High-precision industrial 3D printer, barely used. Ideal for prototyping and
                    small-scale production.</p>
                <div class="mt-4 text-[22px] font-extrabold text-brand-leaf">‚Ç±8,500</div>
                <div class="mt-2 flex items-center justify-between text-sm text-slate-500 font-medium">
                    <span>üìç New York, NY</span>
                    <span>üìÖ 1/15/2024</span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    <a href="#" class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View Details</a>
                    <a href="#"
                        class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book Now</a>
                </div>
            </article>

            <article class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col">
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4">
                    <img src="{% static 'thryve_app/images/listing-placeholder.jpg' %}" alt="No image available" class="w-full h-full object-cover">
                </div>

                <div class="flex items-center justify-between mb-3">
                    <span
                        class="inline-flex items-center gap-2 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full">SWAP</span>
                    <span
                        class="text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">available</span>
                </div>
                <h3 class="text-lg font-bold">Office Furniture Set</h3>
                <div class="mt-0.5 text-slate-500 font-medium">Creative Spaces Inc</div>
                <p class="mt-3 text-slate-700">Complete set including 10 desks, chairs, and storage units. Modern design,
                    excellent condition.</p>
                <p class="mt-2 text-slate-700">Looking for: <span class="font-semibold">IT equipment or professional
                        services</span></p>
                <div class="mt-2 flex items-center justify-between text-sm text-slate-500 font-medium">
                    <span>üìç Los Angeles, CA</span>
                    <span>üìÖ 1/14/2024</span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    <a href="#" class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View Details</a>
                    <a href="#"
                        class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book Now</a>
                </div>
            </article>
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4">
                    <img src="{% static 'thryve_app/images/listing-placeholder.png' %}" alt="No image available" class="w-full h-full object-cover">
                </div>

                <div class="flex items-center justify-between mb-3">
                    <span
                        class="inline-flex items-center gap-2 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full">BUY</span>
                    <span
                        class="text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">available</span>
                </div>
                <h3 class="text-lg font-bold">Looking for CNC Machine</h3>
                <div class="mt-0.5 text-slate-500 font-medium">MetalWorks Ltd</div>
                <p class="mt-3 text-slate-700">We need a CNC machine for metal fabrication. Budget up to ‚Ç±15,000 for the right
                    fit.</p>
                <div class="mt-2 text-slate-700">Budget: <span class="font-semibold">‚Ç±15,000</span></div>
                <div class="mt-2 flex items-center justify-between text-sm text-slate-500">
                    <span>üìç Chicago, IL</span>
                    <span>üìÖ 1/13/2024</span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    <a href="#" class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View Details</a>
                    <a href="#"
                        class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book Now</a>
                </div>
            </article>
            {% endfor %}
        </section>
    </main>

    <!-- Listing Details Modal -->
    <div id="listing-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900" id="details-modal-title">Listing Details</h2>
                    <button id="close-details-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Main Image -->
                <div class="w-full h-64 bg-slate-100 rounded-lg overflow-hidden mb-6" id="details-main-image-container">
                    <img id="details-main-image" src="" alt="Listing image" class="w-full h-full object-cover">
                </div>

                <!-- Listing Type and Category Badges -->
                <div class="flex items-center gap-2 mb-4" id="details-badges">
                    <!-- Badges will be populated by JavaScript -->
                </div>

                <!-- Title -->
                <h3 class="text-2xl font-bold text-slate-900 mb-2" id="details-title"></h3>

                <!-- Seller Info -->
                <div class="flex items-center gap-2 text-slate-600 font-medium mb-4" id="details-seller">
                    <!-- Seller info will be populated by JavaScript -->
                </div>

                <!-- Description -->
                <div class="text-slate-700 mb-6" id="details-description">
                    <!-- Description will be populated by JavaScript -->
                </div>

                <!-- Price/Swap/Budget -->
                <div class="text-3xl font-extrabold text-brand-leaf mb-6" id="details-price">
                    <!-- Price info will be populated by JavaScript -->
                </div>

                <!-- Location and Date -->
                <div class="flex items-center justify-between text-sm text-slate-500 mb-6" id="details-meta">
                    <!-- Meta info will be populated by JavaScript -->
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button class="flex-1 text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-3">Book Now</button>
                    <button id="view-gallery-btn" class="flex-1 text-center rounded-lg border border-brand-sky text-brand-sky font-semibold py-3 hover:bg-brand-sky/10">View Gallery</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="image-gallery-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center">
        <div class="relative w-full max-w-4xl mx-4 flex flex-col items-center">
            <!-- Close button -->
            <button id="close-gallery" class="absolute -top-12 right-0 text-white hover:text-slate-300 text-2xl font-bold z-10">
                ‚úï
            </button>

            <!-- Main image container -->
            <div class="relative w-full h-[70vh] flex items-center justify-center bg-transparent rounded-lg overflow-hidden">
                <img id="gallery-main-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg transition-transform duration-300 ease-out cursor-grab" style="transform: scale(1) translate(0, 0); transform-origin: center center;" onwheel="handleWheelZoom(event)">

                <!-- Navigation arrows -->
                <button id="prev-image" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ‚Äπ
                </button>
                <button id="next-image" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ‚Ä∫
                </button>

                <!-- Zoom controls -->
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                    <button id="zoom-out" class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all" title="Zoom Out">
                        ‚àí
                    </button>
                    <button id="zoom-reset" class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm transition-all" title="Reset Zoom">
                        1:1
                    </button>
                    <button id="zoom-in" class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all" title="Zoom In">
                        +
                    </button>
                </div>
            </div>

                <!-- Image counter -->
                <div class="text-center mt-4">
                    <span id="image-counter" class="text-white text-sm bg-black bg-opacity-50 px-3 py-1 rounded-full"></span>
                </div>

                <!-- Thumbnail strip -->
                <div id="thumbnail-strip" class="flex justify-center gap-2 mt-4 max-w-full overflow-x-auto">
                    <!-- Thumbnails will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-listing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Delete Listing</h2>
                    <button id="close-delete-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-slate-700">Are you sure you want to delete this listing? This action cannot be undone.</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                    <button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition">Delete Listing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div id="edit-listing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Edit Listing</h2>
                        <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="edit-listing-form" method="post" action="" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_category" class="block text-slate-700 font-semibold mb-2">Category *</label>
                            <div class="relative">
                                <input type="hidden" name="category" id="edit_id_category" value="">
                                <div id="edit-category-selector-trigger" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="edit-category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">‚ñæ</span>
                                </div>

                                <div id="edit-category-selector" class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES</div>
                                                <div id="edit-main-categories" class="space-y-1">
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="electronics">Electronics</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="furniture">Furniture</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="tools_equipment">Tools & Equipment</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="raw_materials">Raw Materials</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="services">Services</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="other">Other</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES</div>
                                                <div id="edit-subcategories" class="space-y-1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_title" class="block text-slate-700 font-semibold mb-2">Title *</label>
                            <input type="text" name="title" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" placeholder="Enter listing title" id="edit_id_title">
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_description" class="block text-slate-700 font-semibold mb-2">Description *</label>
                            <div id="edit-description-editor" class="rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-brand-sky">
                                <div id="edit-description-toolbar" class="bg-gray-50 border-b border-slate-200 p-1 rounded-t-lg">
                                    <button type="button" class="ql-bold text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Bold"></button>
                                    <button type="button" class="ql-italic text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Italicize"></button>
                                    <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded" value="bullet" title="Bullet List"></button>
                                    <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded" value="ordered" title="Numbered List"></button>
                                    <button type="button" class="ql-link text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Link"></button>
                                </div>
                                <div id="edit-description-editor-content" class="min-h-[120px] p-3 font-medium text-slate-900" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;"></div>
                            </div>
                            <input type="hidden" name="description" id="edit_id_description">
                        </div>

                        <div class="mb-4" id="edit-dynamic-field-container">
                            <label id="edit-dynamic-field-label" for="edit_id_price" class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="edit-price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">‚Ç±</span>
                                <input type="text" name="price" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" placeholder="0.00" id="edit_id_price">
                            </div>
                            <div class="hidden" id="edit-swap-container">
                                <input type="text" name="swap_for" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky" placeholder="What are you looking to swap for?" id="edit_id_swap_for">
                            </div>
                            <div class="relative hidden" id="edit-budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">‚Ç±</span>
                                <input type="text" name="budget" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky" placeholder="0.00" id="edit_id_budget">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_location" class="block text-slate-700 font-semibold mb-2">Location *</label>
                            <div class="relative">
                                <input type="text" name="location" id="edit_id_location" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" placeholder="City, State/Country">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_images" class="block text-slate-700 font-semibold mb-2">Listing Images</label>

                            <!-- All Images Display (Current + New) -->
                            <div id="edit-all-images" class="mb-4">
                                <!-- Current images will be populated by JavaScript -->
                            </div>

                            <!-- Upload Area -->
                            <div id="edit-upload-area" class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="edit-upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </div>
                                    <div id="edit-upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="edit-image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp" id="edit_id_images" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            </div>

                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="edit-cancel-btn" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="button" id="edit-submit-btn" onclick="submitEditListingForm()" class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="add-listing-modal" class="fixed inset-0 bg-black bg-opacity-50 {% if show_modal %}flex{% else %}hidden{% endif %} z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Create New Listing</h2>
                        <button id="close-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="listing-form" method="post" action="{% url 'thryve_app:create_listing' %}" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy" class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.category.id_for_label }}" class="block text-slate-700 font-semibold mb-2">Category *</label>
                            <div class="relative">
                                <!-- Hidden input to store the selected value -->
                                <input type="hidden" name="category" id="id_category" value="">

                                <!-- Custom category selector trigger -->
                                <div id="category-selector-trigger" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">‚ñæ</span>
                                </div>

                                <!-- Two-column category selector -->
                                <div id="category-selector" class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <!-- Left Column: Main Categories -->
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES</div>
                                                <div id="main-categories" class="space-y-1">
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn active" data-category="electronics">Electronics</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="furniture">Furniture</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="tools_equipment">Tools & Equipment</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="raw_materials">Raw Materials</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="services">Services</button>
                                                    <button type="button" class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn" data-category="other">Other</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Subcategories -->
                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES</div>
                                                <div id="subcategories" class="space-y-1">
                                                    <!-- Subcategories will be populated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="block text-slate-700 font-semibold mb-2">Title *</label>
                            {{ form.title }}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="block text-slate-700 font-semibold mb-2">Description *</label>
                            <div id="description-editor" class="rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-brand-sky">
                                <div id="description-toolbar" class="bg-gray-50 border-b border-slate-200 p-1 rounded-t-lg">
                                    <button type="button" class="ql-bold text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Bold"></button>
                                    <button type="button" class="ql-italic text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Italicize"></button>
                                    <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded" value="bullet" title="Bullet List"></button>
                                    <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded" value="ordered" title="Numbered List"></button>
                                    <button type="button" class="ql-link text-slate-700 hover:text-slate-900 px-2 py-1 rounded" title="Link"></button>
                                </div>
                                <div id="description-editor-content" class="min-h-[120px] p-3 font-medium text-slate-900" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;"></div>
                            </div>
                            <input type="hidden" name="description" id="id_description">
                        </div>

                        <div class="mb-4" id="dynamic-field-container">
                            <label id="dynamic-field-label" for="id_price" class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">‚Ç±</span>
                                <input type="text" name="price" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" placeholder="0.00" id="id_price">
                            </div>
                            <div class="hidden" id="swap-container">
                                <input type="text" name="swap_for" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky" placeholder="What are you looking to swap for?" id="id_swap_for">
                            </div>
                            <div class="relative hidden" id="budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">‚Ç±</span>
                                <input type="text" name="budget" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky" placeholder="0.00" id="id_budget">
                            </div>
                        </div>


                        <div class="mb-4">
                            <label for="id_location" class="block text-slate-700 font-semibold mb-2">Location *</label>
                            <div class="relative">
                                <input type="text" name="location" id="id_location"
                                       class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                       placeholder="City, State/Country">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="id_images" class="block text-slate-700 font-semibold mb-2">Listing Images</label>

                            <!-- Drag and Drop Upload Area -->
                            <div id="upload-area" class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                    </div>
                                    <div id="upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp" id="id_images" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            </div>

                            <!-- Upload Info -->
                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>

                            <!-- Image Previews Container -->
                            <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                <!-- Thumbnails will be added here dynamically -->
                            </div>

                            <!-- Drag and Drop Instructions -->
                            <div id="reorder-instructions" class="mt-2 text-xs text-slate-500 text-center hidden">
                                Drag thumbnails to reorder ‚Ä¢ First image becomes the main photo
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="cancel-btn" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="submit" id="submit-btn" class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Create Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Nominatim Geocoder Implementation - OPTIMIZED
        function initLocationAutocomplete() {
            const locationInput = document.getElementById('id_location');

            if (!locationInput || locationInput.dataset.geocoderInitialized === 'true') {
                return;
            }

            locationInput.dataset.geocoderInitialized = 'true';

            // Cache for previous searches
            const searchCache = new Map();

            // Common Philippine locations for instant results
            const commonLocations = {
                'cebu': [
                    { display_name: 'Cebu City, Cebu, Philippines' },
                    { display_name: 'Mandaue City, Cebu, Philippines' },
                    { display_name: 'Lapu-Lapu City, Cebu, Philippines' },
                    { display_name: 'Talisay City, Cebu, Philippines' }
                ],
                'manila': [
                    { display_name: 'Manila, Metro Manila, Philippines' },
                    { display_name: 'Quezon City, Metro Manila, Philippines' },
                    { display_name: 'Makati, Metro Manila, Philippines' },
                    { display_name: 'Taguig, Metro Manila, Philippines' }
                ],
                'davao': [
                    { display_name: 'Davao City, Davao del Sur, Philippines' }
                ],
                'cebu city': [
                    { display_name: 'Cebu City, Cebu, Philippines' }
                ]
            };

            let geocodeTimeout;
            let currentDropdown = null;
            let lastQuery = '';

            locationInput.addEventListener('input', function() {
                clearTimeout(geocodeTimeout);
                const query = this.value.trim();

                // Don't search if same query or too short
                if (query === lastQuery || query.length < 2) {
                    removeDropdown();
                    return;
                }

                lastQuery = query;

                // Reduced debounce for faster response
                geocodeTimeout = setTimeout(() => {
                    searchLocations(query, locationInput);
                }, 150); // Much faster response
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!locationInput.parentNode.contains(e.target)) {
                    removeDropdown();
                }
            });

            function searchLocations(query, input) {
                const lowerQuery = query.toLowerCase();

                // 1. Check common locations first (INSTANT)
                if (commonLocations[lowerQuery]) {
                    showLocationSuggestions(commonLocations[lowerQuery], input);
                    return;
                }

                // 2. Check cache
                if (searchCache.has(query)) {
                    showLocationSuggestions(searchCache.get(query), input);
                    return;
                }

                // 3. API call with optimized parameters
                const searchUrl = `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}+Philippines&` + // Add Philippines for better results
                    `countrycodes=ph&` +
                    `limit=4&` + // Fewer results = faster
                    `addressdetails=1&` +
                    `dedupe=1`;

                fetch(searchUrl)
                    .then(response => response.json())
                    .then(data => {
                        searchCache.set(query, data);
                        showLocationSuggestions(data, input);
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        removeDropdown();
                    });
            }

            function showLocationSuggestions(suggestions, input) {
                removeDropdown();

                if (suggestions.length === 0) return;

                const dropdown = document.createElement('div');
                dropdown.className = 'suggestions-dropdown absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg z-50 mt-1 max-h-48 overflow-y-auto';

                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'px-3 py-2 hover:bg-slate-100 cursor-pointer text-sm border-b border-slate-100 last:border-b-0 transition-colors';

                    const displayName = formatDisplayName(suggestion.display_name);
                    item.textContent = displayName;

                    item.addEventListener('click', () => {
                        input.value = displayName;
                        removeDropdown();
                    });
                    dropdown.appendChild(item);
                });

                input.parentNode.appendChild(dropdown);
                currentDropdown = dropdown;
            }

            function formatDisplayName(fullName) {
                const parts = fullName.split(',');
                if (parts.length > 3) {
                    return parts.slice(0, 3).join(', ').trim();
                }
                return fullName;
            }

            function removeDropdown() {
                if (currentDropdown) {
                    currentDropdown.remove();
                    currentDropdown = null;
                }
            }
        }

        // Delete listing modal variables
        let currentDeleteListingId = null;

        // Edit listing modal variables
        let currentEditListingId = null;

        // Edit category selector functionality
        const editCategorySelector = {
            trigger: document.getElementById('edit-category-selector-trigger'),
            selector: document.getElementById('edit-category-selector'),
            displayText: document.getElementById('edit-category-display-text'),
            hiddenInput: document.getElementById('edit_id_category'),
            mainCategories: document.getElementById('edit-main-categories'),
            subcategories: document.getElementById('edit-subcategories'),
            activeCategory: null,
            selectedSubcategory: null,

            subcategoriesData: {
                'electronics': [
                    {value: 'computers', label: 'Computers'},
                    {value: 'phones', label: 'Phones'},
                    {value: 'tablets', label: 'Tablets'},
                    {value: 'audio_video', label: 'Audio/Video Equipment'},
                    {value: 'cameras', label: 'Cameras'},
                    {value: 'other_electronics', label: 'Other Electronics'},
                ],
                'furniture': [
                    {value: 'office_chairs', label: 'Office Chairs'},
                    {value: 'desks', label: 'Desks'},
                    {value: 'cabinets', label: 'Cabinets'},
                    {value: 'tables', label: 'Tables'},
                    {value: 'seating', label: 'Seating'},
                    {value: 'other_furniture', label: 'Other Furniture'},
                ],
                'tools_equipment': [
                    {value: 'power_tools', label: 'Power Tools'},
                    {value: 'hand_tools', label: 'Hand Tools'},
                    {value: 'machinery', label: 'Machinery'},
                    {value: 'safety_equipment', label: 'Safety Equipment'},
                    {value: 'measuring_tools', label: 'Measuring Tools'},
                    {value: 'other_tools', label: 'Other Tools & Equipment'},
                ],
                'raw_materials': [
                    {value: 'metals', label: 'Metals'},
                    {value: 'plastics', label: 'Plastics'},
                    {value: 'woods', label: 'Woods'},
                    {value: 'chemicals', label: 'Chemicals'},
                    {value: 'fabrics', label: 'Fabrics'},
                    {value: 'other_materials', label: 'Other Raw Materials'},
                ],
                'services': [
                    {value: 'consulting', label: 'Consulting'},
                    {value: 'maintenance', label: 'Maintenance'},
                    {value: 'installation', label: 'Installation'},
                    {value: 'training', label: 'Training'},
                    {value: 'design', label: 'Design'},
                    {value: 'other_services', label: 'Other Services'},
                ],
                'other': [
                    {value: 'miscellaneous', label: 'Miscellaneous'},
                ],
            },

            init() {
                if (this.trigger && this.selector) {
                    this.setupEventListeners();
                }
            },

            setupEventListeners() {
                this.trigger.addEventListener('click', () => {
                    this.toggleSelector();
                });

                document.addEventListener('click', (e) => {
                    if (!this.trigger.contains(e.target) && !this.selector.contains(e.target)) {
                        this.closeSelector();
                    }
                });

                this.mainCategories.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-btn')) {
                        const category = e.target.dataset.category;
                        this.selectCategory(category);
                    }
                });

                this.subcategories.addEventListener('click', (e) => {
                    if (e.target.classList.contains('subcategory-btn')) {
                        const value = e.target.dataset.value;
                        const label = e.target.textContent;
                        this.selectSubcategory(value, label);
                    }
                });
            },

            selectCategory(category) {
                this.mainCategories.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('bg-brand-sky', 'text-white');
                    btn.classList.add('hover:bg-brand-sky/10');
                });

                const activeBtn = this.mainCategories.querySelector(`[data-category="${category}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('bg-brand-sky', 'text-white');
                    activeBtn.classList.remove('hover:bg-brand-sky/10');
                }

                this.activeCategory = category;
                this.updateSubcategories(category);
            },

            updateSubcategories(category) {
                this.subcategories.innerHTML = '';
                const subs = this.subcategoriesData[category] || [];

                subs.forEach(sub => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded subcategory-btn';
                    btn.dataset.value = `${category}-${sub.value}`;
                    btn.textContent = sub.label;
                    this.subcategories.appendChild(btn);
                });
            },

            selectSubcategory(value, label) {
                this.subcategories.querySelectorAll('.subcategory-btn').forEach(btn => {
                    btn.classList.remove('bg-brand-leaf', 'text-white');
                    btn.classList.add('hover:bg-brand-sky/10');
                });

                const selectedBtn = this.subcategories.querySelector(`[data-value="${value}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('bg-brand-leaf', 'text-white');
                    selectedBtn.classList.remove('hover:bg-brand-sky/10');
                }

                this.displayText.textContent = label;
                this.displayText.classList.remove('text-slate-500');
                this.displayText.classList.add('text-slate-900');
                this.hiddenInput.value = value;

                this.selectedSubcategory = value.split('-')[1];
                this.closeSelector();
            },

            toggleSelector() {
                if (this.selector.classList.contains('hidden')) {
                    this.openSelector();
                } else {
                    this.closeSelector();
                }
            },

            openSelector() {
                this.selector.classList.remove('hidden');
                this.selector.classList.add('flex');
                this.trigger.classList.add('ring-2', 'ring-brand-sky');
            },

            closeSelector() {
                this.selector.classList.add('hidden');
                this.selector.classList.remove('flex');
                this.trigger.classList.remove('ring-2', 'ring-brand-sky');
            },

            setCategory(category, subcategory) {
                this.activeCategory = category;
                this.selectedSubcategory = subcategory;

                // Update visual state
                this.selectCategory(category);
                if (subcategory) {
                    const subcategoryValue = `${category}-${subcategory}`;
                    const label = this.getSubcategoryLabel(subcategory);
                    this.selectSubcategory(subcategoryValue, label);
                }
            },

            getSubcategoryLabel(subcategory) {
                const subs = this.subcategoriesData[this.activeCategory] || [];
                const sub = subs.find(s => s.value === subcategory);
                return sub ? sub.label : subcategory;
            }
        };

        // Delete modal event listeners
        document.getElementById('close-delete-modal').addEventListener('click', closeDeleteListingModal);
        document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteListingModal);
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            if (currentDeleteListingId) {
                // Create a form to submit DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/listings/delete-listing/${currentDeleteListingId}/`;

                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken.value;
                    form.appendChild(csrfInput);
                }

                document.body.appendChild(form);
                form.submit();
            }
        });

        // Close delete modal when clicking outside
        document.getElementById('delete-listing-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('delete-listing-modal')) {
                closeDeleteListingModal();
            }
        });

        // Edit modal event listeners
        document.getElementById('close-edit-modal').addEventListener('click', closeEditListingModal);
        document.getElementById('edit-cancel-btn').addEventListener('click', closeEditListingModal);

        // Close edit modal when clicking outside
        document.getElementById('edit-listing-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('edit-listing-modal')) {
                closeEditListingModal();
            }
        });

        // Edit listing type change handler
        document.querySelectorAll('#edit-listing-modal input[name="listing_type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateEditDynamicField(e.target.value);
            });
        });

        // Modal functionality
        const modal = document.getElementById('add-listing-modal');
        const addListingBtn = document.getElementById('add-listing-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const submitBtn = document.getElementById('submit-btn');
        const form = document.getElementById('listing-form');

        // Open modal
        addListingBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Initialize geocoder after a short delay to ensure DOM is ready
            setTimeout(() => {
                console.log('Modal opened, initializing geocoder...');
                initLocationAutocomplete();
            }, 300);
        });

        // Close modal functions
        const closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Dynamic form fields based on listing type
        const listingTypeRadios = form.querySelectorAll('input[name="listing_type"]');
        const dynamicFieldLabel = document.getElementById('dynamic-field-label');
        const priceContainer = document.getElementById('price-container');
        const swapContainer = document.getElementById('swap-container');
        const budgetContainer = document.getElementById('budget-container');

        function updateDynamicField(selectedType) {
            // Clear any existing errors for dynamic fields
            document.querySelectorAll('.error-message').forEach(el => {
                if (el.closest('#dynamic-field-container')) {
                    el.remove();
                }
            });

            // Hide all containers first
            priceContainer.classList.add('hidden');
            swapContainer.classList.add('hidden');
            budgetContainer.classList.add('hidden');

            // Show the appropriate container and update label
            if (selectedType === 'sale') {
                priceContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Price *';
                dynamicFieldLabel.setAttribute('for', 'id_price');
            } else if (selectedType === 'swap') {
                swapContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Looking to Swap For *';
                dynamicFieldLabel.setAttribute('for', 'id_swap_for');
            } else if (selectedType === 'buy') {
                budgetContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Budget *';
                dynamicFieldLabel.setAttribute('for', 'id_budget');
            }
        }

        listingTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateDynamicField(e.target.value);
            });
        });


        // Category selector functionality
        const categorySelector = {
            trigger: document.getElementById('category-selector-trigger'),
            selector: document.getElementById('category-selector'),
            displayText: document.getElementById('category-display-text'),
            hiddenInput: document.getElementById('id_category'),
            mainCategories: document.getElementById('main-categories'),
            subcategories: document.getElementById('subcategories'),
            activeCategory: null,
            selectedSubcategory: null,

            subcategoriesData: {
                'electronics': [
                    {value: 'computers', label: 'Computers'},
                    {value: 'phones', label: 'Phones'},
                    {value: 'tablets', label: 'Tablets'},
                    {value: 'audio_video', label: 'Audio/Video Equipment'},
                    {value: 'cameras', label: 'Cameras'},
                    {value: 'other_electronics', label: 'Other Electronics'},
                ],
                'furniture': [
                    {value: 'office_chairs', label: 'Office Chairs'},
                    {value: 'desks', label: 'Desks'},
                    {value: 'cabinets', label: 'Cabinets'},
                    {value: 'tables', label: 'Tables'},
                    {value: 'seating', label: 'Seating'},
                    {value: 'other_furniture', label: 'Other Furniture'},
                ],
                'tools_equipment': [
                    {value: 'power_tools', label: 'Power Tools'},
                    {value: 'hand_tools', label: 'Hand Tools'},
                    {value: 'machinery', label: 'Machinery'},
                    {value: 'safety_equipment', label: 'Safety Equipment'},
                    {value: 'measuring_tools', label: 'Measuring Tools'},
                    {value: 'other_tools', label: 'Other Tools & Equipment'},
                ],
                'raw_materials': [
                    {value: 'metals', label: 'Metals'},
                    {value: 'plastics', label: 'Plastics'},
                    {value: 'woods', label: 'Woods'},
                    {value: 'chemicals', label: 'Chemicals'},
                    {value: 'fabrics', label: 'Fabrics'},
                    {value: 'other_materials', label: 'Other Raw Materials'},
                ],
                'services': [
                    {value: 'consulting', label: 'Consulting'},
                    {value: 'maintenance', label: 'Maintenance'},
                    {value: 'installation', label: 'Installation'},
                    {value: 'training', label: 'Training'},
                    {value: 'design', label: 'Design'},
                    {value: 'other_services', label: 'Other Services'},
                ],
                'other': [
                    {value: 'miscellaneous', label: 'Miscellaneous'},
                ],
            },

            init() {
                this.setupEventListeners();
                this.setDefaultCategory();
            },

            setupEventListeners() {
                // Toggle selector visibility
                this.trigger.addEventListener('click', () => {
                    this.toggleSelector();
                });

                // Close selector when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.trigger.contains(e.target) && !this.selector.contains(e.target)) {
                        this.closeSelector();
                    }
                });

                // Category button clicks
                this.mainCategories.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-btn')) {
                        const category = e.target.dataset.category;
                        this.selectCategory(category);
                    }
                });

                // Subcategory selection
                this.subcategories.addEventListener('click', (e) => {
                    if (e.target.classList.contains('subcategory-btn')) {
                        const value = e.target.dataset.value;
                        const label = e.target.textContent;
                        this.selectSubcategory(value, label);
                    }
                });

                // Keyboard navigation
                this.selector.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeSelector();
                    }
                });
            },

            setDefaultCategory() {
                // Default to first category (Electronics)
                const firstCategory = this.mainCategories.querySelector('.category-btn');
                if (firstCategory) {
                    this.selectCategory(firstCategory.dataset.category);
                }
            },

            selectCategory(category) {
                // Update active category visual
                this.mainCategories.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('bg-brand-sky', 'text-white');
                    btn.classList.add('hover:bg-brand-sky/10');
                });

                const activeBtn = this.mainCategories.querySelector(`[data-category="${category}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('bg-brand-sky', 'text-white');
                    activeBtn.classList.remove('hover:bg-brand-sky/10');
                }

                this.activeCategory = category;
                this.updateSubcategories(category);
            },

            updateSubcategories(category) {
                this.subcategories.innerHTML = '';
                const subs = this.subcategoriesData[category] || [];

                subs.forEach(sub => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded subcategory-btn';
                    btn.dataset.value = `${category}-${sub.value}`;
                    btn.textContent = sub.label;
                    this.subcategories.appendChild(btn);
                });
            },

            selectSubcategory(value, label) {
                // Update selected subcategory visual
                this.subcategories.querySelectorAll('.subcategory-btn').forEach(btn => {
                    btn.classList.remove('bg-brand-leaf', 'text-white');
                    btn.classList.add('hover:bg-brand-sky/10');
                });

                const selectedBtn = this.subcategories.querySelector(`[data-value="${value}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('bg-brand-leaf', 'text-white');
                    selectedBtn.classList.remove('hover:bg-brand-sky/10');
                }

                // Update display and hidden input
                this.displayText.textContent = label;
                this.displayText.classList.remove('text-slate-500');
                this.displayText.classList.add('text-slate-900');
                this.hiddenInput.value = value;

                this.selectedSubcategory = value;

                // Clear category error if exists
                clearFieldError('category');

                // Close selector after selection
                setTimeout(() => this.closeSelector(), 150);
            },

            toggleSelector() {
                if (this.selector.classList.contains('hidden')) {
                    this.openSelector();
                } else {
                    this.closeSelector();
                }
            },

            openSelector() {
                this.selector.classList.remove('hidden');
                this.selector.classList.add('flex');
                this.trigger.classList.add('ring-2', 'ring-brand-sky');
            },

            closeSelector() {
                this.selector.classList.add('hidden');
                this.selector.classList.remove('flex');
                this.trigger.classList.remove('ring-2', 'ring-brand-sky');
            }
        };

        // Initialize category selector
        categorySelector.init();

        // Image Gallery Modal functionality
        var currentGalleryImages = [];
        var currentImageIndex = 0;

        function openImageGallery(listingId) {
            // Get all images for this listing dynamically
            currentGalleryImages = [];
            // We'll populate this from data attributes on the listing cards
            const listingCard = document.querySelector(`[data-listing-id="${listingId}"]`);
            if (listingCard) {
                const imagesData = listingCard.dataset.images;
                if (imagesData) {
                    // Split by comma and create image objects
                    const imageUrls = imagesData.split(',');
                    currentGalleryImages = imageUrls.map(url => ({
                        url: url.trim(),
                        alt: 'Listing image'
                    }));
                }
            }

            if (currentGalleryImages.length === 0) {
                // Fallback: show placeholder
                currentGalleryImages = [{
                    url: '{% static "thryve_app/images/listing-placeholder.png" %}',
                    alt: 'No image available'
                }];
            }

            currentImageIndex = 0;
            updateGalleryDisplay();
            document.getElementById('image-gallery-modal').classList.remove('hidden');
            document.getElementById('image-gallery-modal').classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        let currentZoom = 1;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        const minZoom = 0.5;
        const maxZoom = 3;
        const zoomStep = 0.1;
        let isDragging = false;
        let startX, startY, startTranslateX, startTranslateY;

        function updateGalleryDisplay() {
            const mainImage = document.getElementById('gallery-main-image');
            const counter = document.getElementById('image-counter');
            const thumbnailStrip = document.getElementById('thumbnail-strip');

            // Reset zoom and position when changing images
            currentZoom = 1;
            currentTranslateX = 0;
            currentTranslateY = 0;
            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
            mainImage.style.cursor = 'grab';

            // Update main image
            mainImage.src = currentGalleryImages[currentImageIndex].url;
            mainImage.alt = currentGalleryImages[currentImageIndex].alt;

            // Update counter
            counter.textContent = `${currentImageIndex + 1} / ${currentGalleryImages.length}`;

            // Update navigation buttons
            const prevBtn = document.getElementById('prev-image');
            const nextBtn = document.getElementById('next-image');

            prevBtn.style.opacity = currentImageIndex === 0 ? '0.3' : '1';
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.style.opacity = currentImageIndex === currentGalleryImages.length - 1 ? '0.3' : '1';
            nextBtn.disabled = currentImageIndex === currentGalleryImages.length - 1;

            // Update thumbnails
            thumbnailStrip.innerHTML = '';
            currentGalleryImages.forEach((image, index) => {
                const thumb = document.createElement('img');
                thumb.src = image.url;
                thumb.alt = image.alt;
                thumb.className = `w-16 h-16 object-cover rounded cursor-pointer border-2 ${index === currentImageIndex ? 'border-brand-sky' : 'border-transparent'} hover:border-slate-400 transition-all`;
                thumb.onclick = () => {
                    currentImageIndex = index;
                    updateGalleryDisplay();
                };
                thumbnailStrip.appendChild(thumb);
            });
        }

        function zoomImage(direction, event = null) {
            const mainImage = document.getElementById('gallery-main-image');
            const container = mainImage.parentElement;
            const containerRect = container.getBoundingClientRect();

            if (direction === 'reset') {
                currentZoom = 1;
                currentTranslateX = 0;
                currentTranslateY = 0;
                mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
                mainImage.style.cursor = 'grab';
                return;
            }

            // Calculate mouse position relative to container center
            let originX = 50; // percentage from left
            let originY = 50; // percentage from top

            if (event) {
                const mouseX = event.clientX - containerRect.left;
                const mouseY = event.clientY - containerRect.top;
                originX = (mouseX / containerRect.width) * 100;
                originY = (mouseY / containerRect.height) * 100;
            }

            // Set transform origin
            mainImage.style.transformOrigin = `${originX}% ${originY}%`;

            const oldZoom = currentZoom;

            if (direction === 'in' && currentZoom < maxZoom) {
                currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
            } else if (direction === 'out' && currentZoom > minZoom) {
                currentZoom = Math.max(currentZoom - zoomStep, minZoom);
            }

            // Update cursor
            mainImage.style.cursor = currentZoom > 1 ? 'grab' : 'grab';

            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
        }

        function handleMouseDown(e) {
            if (currentZoom <= 1) return;

            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startTranslateX = currentTranslateX;
            startTranslateY = currentTranslateY;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.style.cursor = 'grabbing';
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!isDragging || currentZoom <= 1) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            currentTranslateX = startTranslateX + deltaX;
            currentTranslateY = startTranslateY + deltaY;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
        }

        function handleMouseUp() {
            if (isDragging) {
                isDragging = false;
                const mainImage = document.getElementById('gallery-main-image');
                mainImage.style.cursor = currentZoom > 1 ? 'grab' : 'grab';
            }
        }

        function handleWheelZoom(event) {
            event.preventDefault();

            const direction = event.deltaY > 0 ? 'out' : 'in';
            zoomImage(direction, event);
        }

        function closeImageGallery() {
            document.getElementById('image-gallery-modal').classList.add('hidden');
            document.getElementById('image-gallery-modal').classList.remove('flex');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function navigateImage(direction) {
            if (direction === 'prev' && currentImageIndex > 0) {
                currentImageIndex--;
            } else if (direction === 'next' && currentImageIndex < currentGalleryImages.length - 1) {
                currentImageIndex++;
            }
            updateGalleryDisplay();
        }

        // Event listeners for gallery modal
        document.getElementById('close-gallery').addEventListener('click', closeImageGallery);
        document.getElementById('prev-image').addEventListener('click', () => navigateImage('prev'));
        document.getElementById('next-image').addEventListener('click', () => navigateImage('next'));

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', (e) => zoomImage('in', e));
        document.getElementById('zoom-out').addEventListener('click', (e) => zoomImage('out', e));
        document.getElementById('zoom-reset').addEventListener('click', () => zoomImage('reset'));

        // Pan/drag functionality
        const mainImage = document.getElementById('gallery-main-image');
        mainImage.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        // Close gallery on background click
        document.getElementById('image-gallery-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('image-gallery-modal')) {
                closeImageGallery();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('image-gallery-modal').classList.contains('flex')) {
                if (e.key === 'Escape') {
                    closeImageGallery();
                } else if (e.key === 'ArrowLeft') {
                    navigateImage('prev');
                } else if (e.key === 'ArrowRight') {
                    navigateImage('next');
                }
            }
        });

        // Listing Details Modal functionality
        function openListingDetailsModal(listingId) {
            const listingCard = document.querySelector(`[data-listing-id="${listingId}"]`);
            if (!listingCard) return;

            // Get data from attributes
            const title = listingCard.dataset.title;
            const description = listingCard.dataset.description;
            const price = listingCard.dataset.price;
            const swapFor = listingCard.dataset.swapFor;
            const budget = listingCard.dataset.budget;
            const location = listingCard.dataset.location;
            const createdAt = listingCard.dataset.createdAt;
            const yourName = listingCard.dataset.yourName;
            const company = listingCard.dataset.company;
            const listingType = listingCard.dataset.listingType;
            const category = listingCard.dataset.category;
            const subcategory = listingCard.dataset.subcategory;
            const images = listingCard.dataset.images;

            // Populate modal content
            document.getElementById('details-title').textContent = title;
            document.getElementById('details-description').innerHTML = description;

            // Seller info
            const sellerElement = document.getElementById('details-seller');
            sellerElement.innerHTML = `
                <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <strong>${yourName}</strong> | ${company}
            `;

            // Price/Swap/Budget
            const priceElement = document.getElementById('details-price');
            if (listingType === 'sale' && price) {
                priceElement.textContent = price;
            } else if (listingType === 'swap' && swapFor) {
                priceElement.innerHTML = `<span class="text-slate-700">Looking for:</span> <span class="text-brand-leaf">${swapFor}</span>`;
            } else if (listingType === 'buy' && budget) {
                priceElement.innerHTML = `<span class="text-slate-700">Budget:</span> <span class="text-brand-leaf">${budget}</span>`;
            } else {
                priceElement.textContent = '';
            }

            // Meta info
            const metaElement = document.getElementById('details-meta');
            metaElement.innerHTML = `
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    ${location}
                </span>
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"></path>
                    </svg>
                    ${createdAt}
                </span>
            `;

            // Badges
            const badgesElement = document.getElementById('details-badges');
            badgesElement.innerHTML = '';

            // Listing type badge
            let typeBadge = '';
            if (listingType === 'sale') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>SALE</span>';
            } else if (listingType === 'swap') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>SWAP</span>';
            } else if (listingType === 'buy') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>BUY</span>';
            }
            badgesElement.innerHTML += typeBadge;

            // Category badge
            if (category) {
                let categoryDisplay = '';
                if (subcategory) {
                    if (category === 'electronics') {
                        if (subcategory === 'computers') categoryDisplay = 'Computers';
                        else if (subcategory === 'phones') categoryDisplay = 'Phones';
                        else if (subcategory === 'tablets') categoryDisplay = 'Tablets';
                        else if (subcategory === 'audio_video') categoryDisplay = 'Audio/Video Equipment';
                        else if (subcategory === 'cameras') categoryDisplay = 'Cameras';
                        else categoryDisplay = 'Other Electronics';
                    } else if (category === 'furniture') {
                        if (subcategory === 'office_chairs') categoryDisplay = 'Office Chairs';
                        else if (subcategory === 'desks') categoryDisplay = 'Desks';
                        else if (subcategory === 'cabinets') categoryDisplay = 'Cabinets';
                        else if (subcategory === 'tables') categoryDisplay = 'Tables';
                        else if (subcategory === 'seating') categoryDisplay = 'Seating';
                        else categoryDisplay = 'Other Furniture';
                    } else if (category === 'tools_equipment') {
                        if (subcategory === 'power_tools') categoryDisplay = 'Power Tools';
                        else if (subcategory === 'hand_tools') categoryDisplay = 'Hand Tools';
                        else if (subcategory === 'machinery') categoryDisplay = 'Machinery';
                        else if (subcategory === 'safety_equipment') categoryDisplay = 'Safety Equipment';
                        else if (subcategory === 'measuring_tools') categoryDisplay = 'Measuring Tools';
                        else categoryDisplay = 'Other Tools & Equipment';
                    } else if (category === 'raw_materials') {
                        if (subcategory === 'metals') categoryDisplay = 'Metals';
                        else if (subcategory === 'plastics') categoryDisplay = 'Plastics';
                        else if (subcategory === 'woods') categoryDisplay = 'Woods';
                        else if (subcategory === 'chemicals') categoryDisplay = 'Chemicals';
                        else if (subcategory === 'fabrics') categoryDisplay = 'Fabrics';
                        else categoryDisplay = 'Other Raw Materials';
                    } else if (category === 'services') {
                        if (subcategory === 'consulting') categoryDisplay = 'Consulting';
                        else if (subcategory === 'maintenance') categoryDisplay = 'Maintenance';
                        else if (subcategory === 'installation') categoryDisplay = 'Installation';
                        else if (subcategory === 'training') categoryDisplay = 'Training';
                        else if (subcategory === 'design') categoryDisplay = 'Design';
                        else categoryDisplay = 'Other Services';
                    } else {
                        categoryDisplay = 'Miscellaneous';
                    }
                } else {
                    if (category === 'electronics') categoryDisplay = 'Electronics';
                    else if (category === 'furniture') categoryDisplay = 'Furniture';
                    else if (category === 'tools_equipment') categoryDisplay = 'Tools & Equipment';
                    else if (category === 'raw_materials') categoryDisplay = 'Raw Materials';
                    else if (category === 'services') categoryDisplay = 'Services';
                    else categoryDisplay = 'Other';
                }

                badgesElement.innerHTML += `<span class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">${categoryDisplay}</span>`;
            }

            // Main image
            const mainImageContainer = document.getElementById('details-main-image-container');
            const mainImage = document.getElementById('details-main-image');
            if (images && images.split(',').length > 0) {
                mainImage.src = images.split(',')[0].trim();
                mainImageContainer.style.display = 'block';
            } else {
                mainImage.src = '{% static "thryve_app/images/listing-placeholder.png" %}';
                mainImageContainer.style.display = 'block';
            }

            // Show modal
            document.getElementById('listing-details-modal').classList.remove('hidden');
            document.getElementById('listing-details-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';

            // Store listing ID for gallery button
            document.getElementById('view-gallery-btn').onclick = () => {
                closeListingDetailsModal();
                openImageGallery(listingId);
            };
        }

        function closeListingDetailsModal() {
            document.getElementById('listing-details-modal').classList.add('hidden');
            document.getElementById('listing-details-modal').classList.remove('flex');
            document.body.style.overflow = '';
        }

        // Ensure DOM is loaded before adding event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal event listeners
            document.getElementById('close-details-modal').addEventListener('click', closeListingDetailsModal);
            document.getElementById('listing-details-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('listing-details-modal')) {
                    closeListingDetailsModal();
                }
            });
        });

        // Keyboard navigation for details modal
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('listing-details-modal').classList.contains('flex')) {
                if (e.key === 'Escape') {
                    closeListingDetailsModal();
                }
            }
        });

        // Delete listing modal functions
        function openDeleteListingModal(listingId) {
            currentDeleteListingId = listingId;
            document.getElementById('delete-listing-modal').classList.remove('hidden');
            document.getElementById('delete-listing-modal').classList.add('flex');
        }

        function closeDeleteListingModal() {
            document.getElementById('delete-listing-modal').classList.add('hidden');
            document.getElementById('delete-listing-modal').classList.remove('flex');
            currentDeleteListingId = null;
        }

        // Edit listing modal functions
        function openEditListingModal(listingId) {
            currentEditListingId = listingId;

            // Fetch listing data and populate modal
            fetch(`/listings/edit-listing/${listingId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateEditModal(data.listing);
                    document.getElementById('edit-listing-modal').classList.remove('hidden');
                    document.getElementById('edit-listing-modal').classList.add('flex');
                } else {
                    alert('Error loading listing data');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading listing data');
            });
        }

        function openBookNowModal(listingId) {
            // For now, just show an alert. This would need to be implemented with a proper booking system
            alert('Booking functionality would need to be implemented with a proper booking system.');
        }

        function submitEditListingForm() {
            const form = document.getElementById('edit-listing-form');
            const formData = new FormData(form);

            // Add image order to form data
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (imagesGrid) {
                const imageIds = Array.from(imagesGrid.children)
                    .filter(child => child.dataset.imageType === 'existing')
                    .map(child => child.dataset.imageId).join(',');
                formData.append('image_order', imageIds);
            }

            // Remove commas from price and budget fields
            const priceInput = document.getElementById('edit_id_price');
            const budgetInput = document.getElementById('edit_id_budget');

            if (priceInput && priceInput.value) {
                formData.set('price', priceInput.value.replace(/,/g, ''));
            }
            if (budgetInput && budgetInput.value) {
                formData.set('budget', budgetInput.value.replace(/,/g, ''));
            }

            // Submit the form
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditListingModal();
                    // Reload the page to show updated listing
                    window.location.reload();
                } else {
                    // Handle errors
                    console.error('Form errors:', data.errors);
                    alert('Error updating listing. Please check your inputs.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating listing.');
            });
        }

        function closeEditListingModal() {
            document.getElementById('edit-listing-modal').classList.add('hidden');
            document.getElementById('edit-listing-modal').classList.remove('flex');
            currentEditListingId = null;
        }

        function openEditListingModal(listingId) {
            currentEditListingId = listingId;

            // Fetch listing data and populate modal
            fetch(`/listings/edit-listing/${listingId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateEditModal(data.listing);
                    document.getElementById('edit-listing-modal').classList.remove('hidden');
                    document.getElementById('edit-listing-modal').classList.add('flex');
                } else {
                    alert('Error loading listing data');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading listing data');
            });
        }

        function closeEditListingModal() {
            document.getElementById('edit-listing-modal').classList.add('hidden');
            document.getElementById('edit-listing-modal').classList.remove('flex');
            currentEditListingId = null;
        }

        function populateEditModal(listing) {
            // Populate form fields
            document.querySelector(`input[name="listing_type"][value="${listing.listing_type}"]`).checked = true;

            // Set category using the edit category selector
            editCategorySelector.setCategory(listing.category, listing.subcategory);

            document.getElementById('edit_id_title').value = listing.title;
            document.getElementById('edit_id_description').value = listing.description;
            document.getElementById('edit-description-editor-content').innerHTML = listing.description;

            // Set dynamic field
            if (listing.listing_type === 'sale' && listing.price) {
                document.getElementById('edit_id_price').value = listing.price;
            } else if (listing.listing_type === 'swap' && listing.swap_for) {
                document.getElementById('edit_id_swap_for').value = listing.swap_for;
            } else if (listing.listing_type === 'buy' && listing.budget) {
                document.getElementById('edit_id_budget').value = listing.budget;
            }

            document.getElementById('edit_id_location').value = listing.location;

            // Update form action
            document.getElementById('edit-listing-form').action = `/listings/edit-listing/${listing.id}/`;

            // Trigger dynamic field update
            updateEditDynamicField(listing.listing_type);

            // Initialize edit category selector
            editCategorySelector.init();

            // Populate current images
            populateEditCurrentImages(listing.images || []);
        }

        function populateEditCurrentImages(images) {
            const allImagesContainer = document.getElementById('edit-all-images');
            allImagesContainer.innerHTML = '';

            if (images.length > 0) {
                const imagesGrid = document.createElement('div');
                imagesGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4';
                imagesGrid.id = 'edit-all-images-grid';

                images.forEach((image, index) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group cursor-move';
                    imageDiv.draggable = true;
                    imageDiv.dataset.index = index;
                    imageDiv.dataset.imageId = image.id;
                    imageDiv.dataset.imageType = 'existing';

                    const img = document.createElement('img');
                    img.src = image.image;
                    img.alt = 'Current listing image';
                    img.className = 'w-full h-20 object-cover rounded-lg border border-slate-200';

                    // Add "MAIN" indicator for main image
                    if (image.is_main) {
                        const mainBadge = document.createElement('div');
                        mainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                        mainBadge.textContent = 'MAIN';
                        imageDiv.appendChild(mainBadge);
                    }

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10';
                    removeBtn.innerHTML = '√ó';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeEditImage(image.id);
                    };

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(removeBtn);
                    imagesGrid.appendChild(imageDiv);
                });

                allImagesContainer.appendChild(imagesGrid);

                // Add reorder instructions
                const reorderInstructions = document.createElement('div');
                reorderInstructions.className = 'text-xs text-slate-500 text-center mb-4';
                reorderInstructions.textContent = 'Drag to reorder ‚Ä¢ First image becomes the main photo';
                allImagesContainer.appendChild(reorderInstructions);

                // Initialize drag and drop for all images
                initializeEditImageDragDrop();

                // Update counter to reflect current images
                const remainingSlots = 5 - images.length;
                document.getElementById('edit-image-counter').textContent = `Photos: 0/${remainingSlots}`;
            } else {
                document.getElementById('edit-image-counter').textContent = 'Photos: 0/5';
            }
        }

        function initializeEditImageDragDrop() {
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (!imagesGrid) return;

            let draggedElement = null;

            imagesGrid.addEventListener('dragstart', function(e) {
                if (e.target.closest('.cursor-move')) {
                    draggedElement = e.target.closest('.cursor-move');
                    draggedElement.classList.add('opacity-50');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            imagesGrid.addEventListener('dragend', function(e) {
                if (draggedElement) {
                    draggedElement.classList.remove('opacity-50');
                    draggedElement = null;

                    // Clear all drag over styling
                    imagesGrid.querySelectorAll('.cursor-move').forEach(div => {
                        div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                    });
                }
            });

            imagesGrid.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const target = e.target.closest('.cursor-move');
                if (target && target !== draggedElement) {
                    // Clear feedback from all except the dragged element
                    imagesGrid.querySelectorAll('.cursor-move:not(.opacity-50)').forEach(div => {
                        div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                    });

                    // Add visual indicator to the element you are hovering over
                    target.classList.add('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                }
            });

            imagesGrid.addEventListener('drop', function(e) {
                e.preventDefault();

                const dropTarget = e.target.closest('.cursor-move');
                if (!dropTarget || dropTarget === draggedElement) return;

                // Remove the dragged element from its current position
                const draggedParent = draggedElement.parentNode;
                if (draggedParent) {
                    draggedParent.removeChild(draggedElement);
                }

                // Get all remaining elements to determine insertion point
                const allElements = Array.from(imagesGrid.children);
                const targetIndex = allElements.indexOf(dropTarget);

                // Determine if we should insert before or after the target
                const rect = dropTarget.getBoundingClientRect();
                const dropX = e.clientX;

                if (dropX < rect.left + rect.width / 2) {
                    // Insert before target
                    imagesGrid.insertBefore(draggedElement, dropTarget);
                } else {
                    // Insert after target
                    imagesGrid.insertBefore(draggedElement, dropTarget.nextSibling);
                }

                // Update indices and main image indicators
                updateEditImageOrder();

                // Clear drag styling
                imagesGrid.querySelectorAll('.cursor-move').forEach(div => {
                    div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                });
            });
        }

        function updateEditImageOrder() {
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (!imagesGrid) return;

            const imageElements = imagesGrid.querySelectorAll('.cursor-move');

            imageElements.forEach((element, index) => {
                element.dataset.index = index;

                // Update main image indicator
                const mainBadge = element.querySelector('.bg-brand-leaf');
                if (index === 0) {
                    if (!mainBadge) {
                        const newMainBadge = document.createElement('div');
                        newMainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                        newMainBadge.textContent = 'MAIN';
                        element.insertBefore(newMainBadge, element.firstChild);
                    }
                } else {
                    if (mainBadge) {
                        mainBadge.remove();
                    }
                }
            });
        }

        function removeEditImage(imageId) {
            if (confirm('Are you sure you want to remove this image?')) {
                // This would need a separate view/URL for removing images
                // For now, just show an alert
                alert('Image removal functionality would need to be implemented with a separate endpoint.');
            }
        }


        function updateEditDynamicField(selectedType) {
            const priceContainer = document.getElementById('edit-price-container');
            const swapContainer = document.getElementById('edit-swap-container');
            const budgetContainer = document.getElementById('edit-budget-container');
            const label = document.getElementById('edit-dynamic-field-label');

            priceContainer.classList.add('hidden');
            swapContainer.classList.add('hidden');
            budgetContainer.classList.add('hidden');

            if (selectedType === 'sale') {
                priceContainer.classList.remove('hidden');
                label.textContent = 'Price *';
            } else if (selectedType === 'swap') {
                swapContainer.classList.remove('hidden');
                label.textContent = 'Looking to Swap For *';
            } else if (selectedType === 'buy') {
                budgetContainer.classList.remove('hidden');
                label.textContent = 'Budget *';
            }
        }

        // Initialize Quill Rich Text Editor with snow theme
        const quill = new Quill('#description-editor-content', {
            theme: 'snow',
            placeholder: 'Describe your item or service',
            modules: {
                toolbar: '#description-toolbar'
            }
        });

        // Initialize Quill for edit modal
        const editQuill = new Quill('#edit-description-editor-content', {
            theme: 'snow',
            placeholder: 'Describe your item or service',
            modules: {
                toolbar: '#edit-description-toolbar'
            }
        });

        // Sync edit Quill content to hidden input
        editQuill.on('text-change', function() {
            const html = editQuill.root.innerHTML;
            document.getElementById('edit_id_description').value = html;
        });

        // Function to format number with commas
        function formatNumberWithCommas(value) {
            // Remove any existing commas and non-numeric characters except decimal point
            const numericValue = value.replace(/[^\d.]/g, '');
            // Split into integer and decimal parts
            const parts = numericValue.split('.');
            // Add commas to integer part
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            // Rejoin with decimal part if it exists
            return parts.join('.');
        }

        // Function to handle price input formatting
        function handlePriceInput(event) {
            const input = event.target;
            const cursorPosition = input.selectionStart;
            const originalValue = input.value;

            // Format the value
            const formattedValue = formatNumberWithCommas(originalValue);

            // Only update if the value changed
            if (formattedValue !== originalValue) {
                input.value = formattedValue;

                // Adjust cursor position to account for added commas
                const commaCountDiff = (formattedValue.match(/,/g) || []).length - (originalValue.match(/,/g) || []).length;
                input.setSelectionRange(cursorPosition + commaCountDiff, cursorPosition + commaCountDiff);
            }
        }

        // Add event listeners to price and budget inputs
        const priceInput = document.getElementById('id_price');
        const budgetInput = document.getElementById('id_budget');

        if (priceInput) {
            priceInput.addEventListener('input', handlePriceInput);
        }

        if (budgetInput) {
            budgetInput.addEventListener('input', handlePriceInput);
        }

        // Sync Quill content to hidden input
        quill.on('text-change', function() {
            const html = quill.root.innerHTML;
            document.getElementById('id_description').value = html;
            clearFieldError('description');
        });

        // Apply custom styling to match Thryve theme
        const style = document.createElement('style');
        style.textContent = `
            /* --- Base Quill Overrides (No changes needed for animation) --- */
            .ql-toolbar.ql-snow { border: none; padding: 0; background-color: transparent; border-radius: 0; }
            .ql-container.ql-snow { border: none; }
            .ql-snow .ql-toolbar:after { content: none; }
            .ql-snow .ql-toolbar button { padding: 6px 8px; border-radius: 0.25rem; border: none; background: transparent; transition: background-color 0.15s; min-height: 36px; }
            .ql-snow .ql-toolbar button svg { width: 24px; height: 24px; transform: none; }
            .ql-snow .ql-toolbar button:hover, .ql-snow .ql-toolbar button:focus { background-color: #e2e8f0 !important; color: #1e293b; }
            .ql-snow .ql-toolbar button.ql-active { background-color: #83e6f5 !important; color: #0f172a !important; }
            .ql-snow .ql-editor { font-size: 16px; line-height: 1.5; }
            .ql-snow .ql-editor ul, .ql-snow .ql-editor ol { padding-left: 1.5em; }
            .ql-snow .ql-editor.ql-blank::before { color: #94a3b8 !important; left: 0.75rem !important; padding-left: 0 !important; font-style: normal; font-size: 16px; }
            .ql-container .ql-editor { padding: 0; }
            .ql-editor strong, .ql-editor b { font-weight: 800; }
            .ql-editor em, .ql-editor i { font-style: italic; }
            .ql-editor a { color: #3b82f6; text-decoration: underline; }
            .suggestions-dropdown { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
            .suggestions-dropdown::-webkit-scrollbar { width: 6px; }
            .suggestions-dropdown::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 0 0 8px 0; }
            .suggestions-dropdown::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
            .suggestions-dropdown::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

            /* List styling for description display */
            #details-description ul, #details-description ol {
                padding-left: 1.5rem;
                margin: 0.5rem 0;
            }
            #details-description li {
                margin: 0.25rem 0;
                line-height: 1.4;
            }
            #details-description ul {
                list-style-type: disc;
            }
            #details-description ol {
                list-style-type: decimal;
            }
            #details-description strong, #details-description b {
                font-weight: 700;
            }
            #details-description em, #details-description i {
                font-style: italic;
            }

            /* List styling for card previews */
            .description-preview ul, .description-preview ol {
                padding-left: 1rem;
                margin: 0.25rem 0;
            }
            .description-preview li {
                margin: 0.125rem 0;
                line-height: 1.3;
            }
            .description-preview ul {
                list-style-type: disc;
            }
            .description-preview ol {
                list-style-type: decimal;
            }
            .description-preview strong, .description-preview b {
                font-weight: 600;
            }
            .description-preview em, .description-preview i {
                font-style: italic;
            }

            /* --- ENHANCED ANIMATION CONTAINERS --- */

            /* Title scrolling animation */
            .title-scroll-container {
                width: 100%;
                overflow: hidden;
                position: relative;
                max-width: 100%; /* Prevent container from expanding */
            }

            .title-spacer {
                margin-left: 2rem;
            }

            .title-scroll-text {
                display: inline-flex;
                width: max-content;
                transition: transform 0.5s ease-out;
                transform: translateX(0);
                -webkit-transform: translateX(0);
            }

            /* Trigger animation on parent article hover */
            article:hover .title-scroll-text {
                animation: scroll-left-title 8s linear infinite;
                -webkit-animation: scroll-left-title 8s linear infinite;
                animation-delay: 1s;
                -webkit-animation-delay: 1s;
            }

            /* Location scrolling animation */
            .location-scroll-container {
                width: 100%;
                overflow: hidden;
                position: relative;
                display: inline-block;
                max-width: 100%; /* Prevent container from expanding */
            }

            .location-spacer {
                margin-left: 3rem;
            }

            .location-scroll-text {
                display: inline-flex;
                width: max-content;
                transition: transform 0.5s ease-out;
                transform: translateX(0);
                -webkit-transform: translateX(0);
            }

            /* Trigger animation on parent article hover */
            article:hover .location-scroll-text {
                animation: scroll-left-location 15s linear infinite;
                -webkit-animation: scroll-left-location 15s linear infinite;
                animation-delay: 1s;
                -webkit-animation-delay: 1s;
            }

            /* Keyframes remain the same */
            @keyframes scroll-left-location {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1.5rem)); }
            }

            @-webkit-keyframes scroll-left-location {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1.5rem)); }
            }

            @keyframes scroll-left-title {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-title {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }

            /* CRITICAL FIX: Force containers to not expand beyond parent */
            article .title-scroll-container,
            article .location-scroll-container {
                max-width: 100%;
                overflow: hidden;
            }

            /* Ensure parent containers have proper width constraints */
            article h3,
            article .text-lg.font-bold {
                max-width: 100%;
            }

            article .flex.items-center.gap-1.max-w-\[60\%\] {
                overflow: hidden;
            }

            /* Separate keyframes for each animation type (CRITICAL: Needs prefixes) */
            @keyframes scroll-left-location {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1.5rem)); }
            }

            @-webkit-keyframes scroll-left-location {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1.5rem)); }
            }

            @keyframes scroll-left-title {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-title {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }

            @keyframes scroll-left-description {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-description {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }
        `;
        document.head.appendChild(style);

        // Real-time validation - clear errors when user starts typing
        function setupRealTimeValidation() {
            const allInputs = form.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                if (input.id !== 'id_category') { // Skip our custom category input
                    input.addEventListener('input', (e) => {
                        const fieldName = e.target.id.replace('id_', '');
                        clearFieldError(fieldName);
                    });
                }
            });
        }

        // Clear error for a specific field
        function clearFieldError(fieldName) {
            let fieldContainer;

            if (fieldName === 'listing_type') {
                fieldContainer = form.querySelector('.space-y-2').parentElement;
            } else if (fieldName === 'price' || fieldName === 'swap_for' || fieldName === 'budget') {
                fieldContainer = document.getElementById('dynamic-field-container');
            } else {
                const field = form.querySelector(`#id_${fieldName}`);
                if (field) {
                    fieldContainer = field.closest('.mb-4') || field.closest('.mb-6');
                }
            }

            if (fieldContainer) {
                const errorMsg = fieldContainer.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }

                // Remove red border
                const field = form.querySelector(`#id_${fieldName}`);
                if (field) {
                    field.classList.remove('border-red-500');
                }
            }
        }

        // Form validation on submit
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Always prevent default first

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            let hasErrors = false;

            // Check listing type
            const listingType = form.querySelector('input[name="listing_type"]:checked');
            if (!listingType) {
                showError('listing_type', 'Please select a listing type');
                hasErrors = true;
            }

            // Check category
            const category = form.querySelector('#id_category');
            if (!category || !category.value || category.value === '') {
                showError('category', 'Please select a category');
                hasErrors = true;
            }

            // Check required text fields
            const requiredFields = ['title', 'description', 'location'];
            requiredFields.forEach(field => {
                const input = form.querySelector(`#id_${field}`);
                if (!input.value.trim()) {
                    showError(field, `Please enter ${field.replace('_', ' ')}`);
                    hasErrors = true;
                }
            });

            // Check the dynamic field based on listing type
            const selectedType = form.querySelector('input[name="listing_type"]:checked');
            if (selectedType) {
                if (selectedType.value === 'sale') {
                    const priceInput = form.querySelector('#id_price');
                    const priceValue = parseFloat(priceInput.value.replace(/,/g, ''));
                    if (!priceInput.value.trim()) {
                        showError('price', 'Please enter price');
                        hasErrors = true;
                    } else if (priceValue <= 0) {
                        showError('price', 'Price must be greater than 0');
                        hasErrors = true;
                    }
                } else if (selectedType.value === 'swap') {
                    const swapInput = form.querySelector('#id_swap_for');
                    if (!swapInput.value.trim()) {
                        showError('swap_for', 'Please enter what you are looking to swap for');
                        hasErrors = true;
                    }
                } else if (selectedType.value === 'buy') {
                    const budgetInput = form.querySelector('#id_budget');
                    const budgetValue = parseFloat(budgetInput.value.replace(/,/g, ''));
                    if (!budgetInput.value.trim()) {
                        showError('budget', 'Please enter budget');
                        hasErrors = true;
                    } else if (budgetValue <= 0) {
                        showError('budget', 'Budget must be greater than 0');
                        hasErrors = true;
                    }
                }
            } else {
                // If no listing type is selected, default to checking price (since For Sale is default)
                const priceInput = form.querySelector('#id_price');
                const priceValue = parseFloat(priceInput.value.replace(/,/g, ''));
                if (!priceInput.value.trim()) {
                    showError('price', 'Please enter price');
                    hasErrors = true;
                } else if (priceValue <= 0) {
                    showError('price', 'Price must be greater than 0');
                    hasErrors = true;
                }
            }

            if (!hasErrors) {
                // Submit the form via AJAX instead of normal submission
                submitFormViaAjax();
            }
        });

        // Initialize real-time validation
        setupRealTimeValidation();

        // Function to submit form via AJAX
        function submitFormViaAjax() {
            const formData = new FormData(form);

            // Remove commas from price and budget fields before submission
            const priceInput = document.getElementById('id_price');
            const budgetInput = document.getElementById('id_budget');

            if (priceInput && priceInput.value) {
                formData.set('price', priceInput.value.replace(/,/g, ''));
            }
            if (budgetInput && budgetInput.value) {
                formData.set('budget', budgetInput.value.replace(/,/g, ''));
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success: close modal and redirect to home page immediately
                    closeModal();
                    // Use replace to avoid adding to browser history
                    window.location.replace('/home/');
                } else {
                    // Error: show form errors
                    showFormErrors(data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('general', 'An error occurred. Please try again.');
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Listing';
            });
        }

        // Function to refresh listings section (no longer needed)
        function refreshListings() {
            // This function is no longer used since we redirect instead
        }

        // Function to show success message (no longer needed)
        function showSuccessMessage(message) {
            // This function is no longer used since we redirect instead
        }

        // Function to show form errors from AJAX response
        function showFormErrors(errors) {
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            // Show new errors
            for (const [field, messages] of Object.entries(errors)) {
                if (Array.isArray(messages)) {
                    messages.forEach(message => {
                        showError(field, message);
                    });
                } else {
                    showError(field, messages);
                }
            }
        }

        // Initialize drag-and-drop image upload
        const uploadArea = document.getElementById('upload-area');
        const imageInput = document.getElementById('id_images');
        const imageCounter = document.getElementById('image-counter');
        const imagePreviews = document.getElementById('image-previews');
        const reorderInstructions = document.getElementById('reorder-instructions');
        let selectedFiles = [];
        let draggedElement = null;

        // Add this new event listener
        // This prevents the browser from loading the dropped file directly in the window,
        // which is what causes the screen to go blank/images to vanish.
        document.addEventListener('drop', function(e) {
            e.preventDefault();
        }, false);

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('border-brand-sky', 'bg-brand-sky/5');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('border-brand-sky', 'bg-brand-sky/5');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // File input change
        imageInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            // Convert FileList to Array and filter for images
            const imageFiles = Array.from(files).filter(file => {
                return file.type.startsWith('image/') &&
                       ['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type);
            });

            // Add new files to selectedFiles, avoiding duplicates
            imageFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            // Limit to 5 files
            if (selectedFiles.length > 5) {
                selectedFiles = selectedFiles.slice(0, 5);
            }

            updateImageDisplay();
        }

        function updateImageDisplay() {
            // Update counter
            const count = selectedFiles.length;
            imageCounter.textContent = `Photos: ${count}/5`;

            // Change color if over limit
            if (count > 5) {
                imageCounter.classList.add('text-red-500');
                imageCounter.classList.remove('text-slate-600');
            } else {
                imageCounter.classList.remove('text-red-500');
                imageCounter.classList.add('text-slate-600');
            }

            // Update upload area state when max reached
            if (count >= 5) {
                // Disable upload area
                uploadArea.classList.add('opacity-50', 'cursor-not-allowed');
                uploadArea.classList.remove('hover:border-brand-sky', 'hover:bg-slate-100/50', 'cursor-pointer');

                // Update text and icon
                const uploadText = document.getElementById('upload-text');
                const uploadIcon = document.getElementById('upload-icon');
                uploadText.innerHTML = `
                    <p class="text-lg font-medium text-slate-500">You have reached the maximum of 5 photos.</p>
                    <p class="text-sm text-slate-400">Delete a photo below to upload a new one.</p>
                `;
                uploadIcon.classList.add('text-slate-400');
                uploadIcon.classList.remove('text-slate-400'); // Keep it gray

                // Disable file input
                imageInput.disabled = true;
            } else {
                // Re-enable upload area
                uploadArea.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadArea.classList.add('hover:border-brand-sky', 'hover:bg-slate-100/50', 'cursor-pointer');

                // Reset text and icon
                const uploadText = document.getElementById('upload-text');
                const uploadIcon = document.getElementById('upload-icon');
                uploadText.innerHTML = `
                    <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                    <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                `;
                uploadIcon.classList.remove('text-slate-400');
                uploadIcon.classList.add('text-slate-400');

                // Re-enable file input
                imageInput.disabled = false;
            }

            // Clear existing previews
            imagePreviews.innerHTML = '';

            // Create thumbnails
            selectedFiles.forEach((file, index) => {
                const thumbnail = createThumbnail(file, index);
                imagePreviews.appendChild(thumbnail);
            });

            // Show/hide reorder instructions
            if (selectedFiles.length > 1) {
                reorderInstructions.classList.remove('hidden');
            } else {
                reorderInstructions.classList.add('hidden');
            }

            // Update the actual file input with selected files
            updateFileInput();
        }

        function createThumbnail(file, index) {
            const div = document.createElement('div');
            div.className = 'relative group cursor-move';
            div.draggable = true;
            div.dataset.index = index;

            const img = document.createElement('img');
            img.className = 'w-full h-20 object-cover rounded-lg border border-slate-200';

            // Create object URL for preview
            const url = URL.createObjectURL(file);
            img.src = url;

            // Add "MAIN" indicator for first image
            if (index === 0) {
                const mainBadge = document.createElement('div');
                mainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                mainBadge.textContent = 'MAIN';
                div.appendChild(mainBadge);
            }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeImage(index);
            };

            div.appendChild(img);
            div.appendChild(removeBtn);

            // Add drag event listeners
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDropOnThumbnail);

            return div;
        }

        function removeImage(index) {
            selectedFiles.splice(index, 1);
            updateImageDisplay();
        }

        function updateFileInput() {
            // Create a new DataTransfer object to update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
        }

        // --- Start of CORRECTED DRAG & DROP REORDERING SECTION ---

        // Utility function to determine the closest element to drop AFTER
        function getDropAfterElement(container, clientX, clientY, draggedElement) {
            // Get all valid drop targets (thumbnails that aren't the one currently dragging)
            const draggableElements = [...container.querySelectorAll('.cursor-move:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();

                // Calculate the difference from the center line of the child element.
                // We use the center of the child element to define the drop zone boundary.
                const center_x = box.left + box.width / 2;
                const center_y = box.top + box.height / 2;

                // Calculate offset in both dimensions
                // Offset Y is the most important for multi-row grids
                const offset_y = clientY - center_y;

                // Only consider elements that are in the right direction (above/left of the drop point)
                if (offset_y < 0) {
                    // The drop is above the center of this element (valid place to insert before)
                    if (offset_y > closest.offset_y) {
                         return { offset_y: offset_y, element: child };
                    }
                } else if (offset_y >= 0 && clientX < center_x) {
                    // Drop is on the same row, to the left of the center, or past the last element on the row
                    // We rely more on Y, but X provides tie-breaking on the same row.
                    // This logic is complex in a dynamic grid, so we simplify to finding the closest "preceding" element.
                }

                return closest;
            }, { offset_y: Number.NEGATIVE_INFINITY, element: null }).element;
        }


        // Drag and drop reordering functions
        function handleDragStart(e) {
            // Store the original index of the file being dragged
            e.dataTransfer.setData('text/plain', e.currentTarget.dataset.index);
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('opacity-50', 'dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('opacity-50', 'dragging');
            draggedElement = null;

            // Clear all drag over styling
            document.querySelectorAll('#image-previews > div').forEach(div => {
                div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const target = e.currentTarget;

            // Clear feedback from all except the dragged element
            document.querySelectorAll('#image-previews > div:not(.dragging)').forEach(div => {
                div.classList.remove('border-2', 'border-brand-sky', 'bg-brand-sky/10');
            });

            // Add visual indicator to the element you are hovering over
            if (target && target !== draggedElement) {
                target.classList.add('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
            }
        }


        function handleDropOnThumbnail(e) {
            e.preventDefault();
            e.stopPropagation();

            // The element that received the drop
            const dropTarget = e.currentTarget;

            // 1. Get initial indices and data
            const draggedFileOriginalIndex = parseInt(e.dataTransfer.getData('text/plain'));

            // Safety check for dropping on self or invalid file
            if (isNaN(draggedFileOriginalIndex) || draggedFileOriginalIndex < 0 || dropTarget === draggedElement) {
                handleDragEnd(e);
                return false;
            }

            const draggedFile = selectedFiles[draggedFileOriginalIndex];

            // Get the index of the target element in the CURRENT DOM NodeList
            // This correctly gives the visual position (0, 1, 2, 3...)
            const thumbnails = Array.from(imagePreviews.children);
            let targetVisualIndex = thumbnails.indexOf(dropTarget);

            // 2. Calculate Insertion Point
            let newInsertIndex = targetVisualIndex;

            // Use drop position to determine if we should insert BEFORE or AFTER the target thumbnail
            const rect = dropTarget.getBoundingClientRect();
            const dropX = e.clientX;

            // If dropped on the right half of the target, insert AFTER (targetVisualIndex + 1)
            if (dropX > rect.left + rect.width / 2) {
                newInsertIndex++;
            }

            // 3. Reorder the array using a more reliable approach

            // Create a new array without the dragged item
            const remainingFiles = selectedFiles.filter((_, index) => index !== draggedFileOriginalIndex);

            // Insert the dragged file at the new position
            remainingFiles.splice(newInsertIndex, 0, draggedFile);

            // Update the selectedFiles array
            selectedFiles.length = 0;
            selectedFiles.push(...remainingFiles);

            // 4. Re-render and cleanup
            updateImageDisplay();
            handleDragEnd(e);

            return false;
        }

        // --- End of CORRECTED DRAG & DROP REORDERING SECTION ---


        function showError(fieldName, message) {
            let field;
            let fieldContainer;

            if (fieldName === 'listing_type') {
                // For radio buttons, find the container div
                fieldContainer = form.querySelector('.space-y-2').parentElement;
                field = form.querySelector('input[name="listing_type"]'); // Just get first radio for styling
            } else if (fieldName === 'price' || fieldName === 'swap_for' || fieldName === 'budget') {
                // For dynamic fields, use the dynamic field container
                fieldContainer = document.getElementById('dynamic-field-container');
                field = form.querySelector(`#id_${fieldName}`);
            } else {
                field = form.querySelector(`#id_${fieldName}`);
                fieldContainer = field.closest('.mb-4') || field.closest('.mb-6');
            }

            // Remove existing error for this field
            const existingError = fieldContainer.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Add error message
            const errorDiv = document.createElement('p');
            errorDiv.className = 'error-message text-red-500 text-sm mt-1';
            errorDiv.textContent = message;
            fieldContainer.appendChild(errorDiv);

            // Add red border to field (skip for radio buttons)
            if (field && fieldName !== 'listing_type') {
                field.classList.add('border-red-500');
                setTimeout(() => field.classList.remove('border-red-500'), 3000);
            }
        }
    </script>

    {% include 'accounts/logout_modal.html' %}
</body>

</html>
