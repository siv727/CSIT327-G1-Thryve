{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thryve • Marketplace</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Ensure descriptions wrap nicely across the app */
        .description-preview,
        #details-description {
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        /* Reserve space roughly equal to two lines of text
           so cards stay visually aligned even for very short descriptions */
        .card-description {
            min-height: 3.0rem;
        }

        /* Utility: clamp text to 2 lines for uniform cards */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-clamp: 2;
            /* Standard property for future compatibility */
        }

        /* Horizontal marquee-on-hover for long text (title/location/looking-for)
              Title and location always animate when long; looking-for animates
              when long on cards only. */
        .title-scroll-container,
        .location-scroll-container {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            position: relative;
            display: block;
        }

        .title-scroll-text,
        .location-scroll-text {
            display: inline-flex;
            width: max-content;
            transform: translateX(0);
            transition: transform 0.4s ease-out;
            white-space: nowrap;
        }

        .title-spacer {
            margin-left: 2rem;
        }

        .location-spacer {
            margin-left: 3rem;
        }

        /* Run scroll only when hovering a card */
        article:hover .title-scroll-text {
            animation: scroll-left-title 12s linear infinite;
            -webkit-animation: scroll-left-title 12s linear infinite;
        }

        article:hover .location-scroll-text {
            animation: scroll-left-location 14s linear infinite;
            -webkit-animation: scroll-left-location 14s linear infinite;
        }

        /* Looking-for value scroll container (same pattern as title/location) */
        .looking-scroll-container {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            position: relative;
            display: block;
        }

        .looking-scroll-text {
            display: inline-flex;
            width: max-content;
            transform: translateX(0);
            transition: transform 0.4s ease-out;
            white-space: nowrap;
        }

        .looking-spacer {
            margin-left: 2rem;
        }

        article:hover .looking-scroll-text {
            animation: scroll-left-looking 12s linear infinite;
            -webkit-animation: scroll-left-looking 12s linear infinite;
        }

        /* Keyframes (duplicate content required via spacer to loop smoothly) */
        @keyframes scroll-left-title {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @-webkit-keyframes scroll-left-title {
            0% {
                -webkit-transform: translateX(0);
            }

            100% {
                -webkit-transform: translateX(-50%);
            }
        }

        @keyframes scroll-left-location {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @-webkit-keyframes scroll-left-location {
            0% {
                -webkit-transform: translateX(0);
            }

            100% {
                -webkit-transform: translateX(-50%);
            }
        }

        @keyframes scroll-left-looking {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @-webkit-keyframes scroll-left-looking {
            0% {
                -webkit-transform: translateX(0);
            }

            100% {
                -webkit-transform: translateX(-50%);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            sky: '#83e6f5', /* landing page sky blue */
                            leaf: '#3ac363', /* landing page light green */
                            ink: '#0f172a'
                        }
                    },
                    boxShadow: {
                        soft: '0 10px 28px rgba(2, 8, 23, .06)'
                    },
                    fontFamily: {
                        inter: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    borderRadius: {
                        xl2: '1rem'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-inter bg-[#f7fbfd] text-brand-ink">

     <header class="bg-[#23d3ee] text-white shadow">
        <div class="max-w-7xl mx-auto h-16 px-6 flex items-center justify-between">
            <a href="{% url 'dashboard' %}" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
          <span class="leading-none">Dashboard</span>
        </a>
      </nav>
            <a href="{% url 'home' %}" class="flex items-center gap-2">
                <span
                    class="inline-flex items-center justify-center w-8 h-8 rounded-md bg-white font-black text-[#23d3ee]">T</span>
                <span class="text-[22px] font-extrabold tracking-tight">Thryve</span>
            </a>

            {% with active=request.resolver_match.url_name %}
            <nav class="flex items-center gap-8 text-[15px] font-medium">
                <a href="{% url 'home' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h18l-1.68 9.39a2 2 0 01-1.98 1.61H6.66a2 2 0 01-1.98-1.61L3 3zM16 16a3 3 0 11-6 0">
                        </path>
                    </svg>
                    <span class="leading-none">Marketplace</span>
                    {% if active == 'home' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'thryve_app:my_listings' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span class="leading-none">My Listings</span>
                    {% if active == 'my_listings' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'thryve_app:connections' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span class="leading-none">Connections</span>
                    {% if active == 'connections' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="#" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5V4H2v16h5M17 8l-5 5-5-5" />
                    </svg>
                    <span class="leading-none">Community</span>
                    {% if active == 'community' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'bookings' %}" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z" />
                    </svg>
                    <span class="leading-none">Bookings</span>
                    {% if active == 'bookings' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'business_profile' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 21a8 8 0 10-16 0m8-9a4 4 0 100-8 4 4 0 000 8z" />
                    </svg>
                    <span class="leading-none">Profile</span>
                    {% if active == 'business_profile' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>
            </nav>
            {% endwith %}

            <button onclick="openLogoutModal()" type="button"
                class="flex items-center gap-2 font-medium text-white/90 hover:text-white transition-all text-[15px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H5a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1" />
                </svg>
                <span class="leading-none">Logout</span>
            </button>

        </div>
    </header>


    <main class="max-w-[1200px] mx-auto px-5 py-8">
        <div class="flex items-start justify-between gap-4 mb-6">
            <div>
                <h1 class="text-[38px] leading-[1.1] font-extrabold">
                    {% if is_my_listings %}
                    My Listings
                    {% else %}
                    Marketplace
                    {% endif %}
                </h1>
                <p class="text-slate-600 mt-1">
                    {% if is_my_listings %}
                    Manage your equipment and service listings.
                    {% else %}
                    Buy, sell, or swap equipment and services with confidence.
                    {% endif %}
                </p>
            </div>
            {% if not is_my_listings %}
            <button id="add-listing-btn"
                class="inline-flex items-center gap-2 rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold px-4 py-2.5 shadow-soft transition">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-width="2" d="M12 5v14M5 12h14" />
                </svg>
                Add Listing
            </button>
            {% endif %}
        </div>

        <section class="bg-white/90 backdrop-blur rounded-xl shadow-soft border border-slate-100 p-5 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Search</label>
                    <form id="filter-form" method="get" action="{% url 'home' %}">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="11" cy="11" r="7" stroke-width="2" />
                                    <path stroke-width="2" d="M21 21l-4.3-4.3" />
                                </svg>
                            </span>
                            <input
                                class="w-full rounded-lg border border-slate-200 pl-10 pr-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                type="text" name="q" value="{{ search_query }}"
                                placeholder="Search items, services, or locations…" />
                        </div>
                        <!-- Hidden inputs to preserve selected category and type -->
                        <input type="hidden" name="category" id="filter-category-input" value="{{ category_filter }}">
                        <input type="hidden" name="type" id="filter-type-input" value="{{ type_filter }}">
                    </form>
                </div>

                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Category</label>
                    <div class="relative">
                        <select
                            class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium appearance-none focus:outline-none focus:ring-2 focus:ring-brand-sky"
                            id="filter-category-select" onchange="document.getElementById('filter-category-input').value=this.value; document.getElementById('filter-form').submit();">
                            <option value="">All Categories</option>
                            {% for key, data in categories.items %}
                            <option value="{{ key }}" {% if category_filter == key %}selected{% endif %}>{{ data.label }}</option>
                            {% endfor %}
                        </select>
                        <span
                            class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">▾</span>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="text-slate-700 font-semibold mb-3">Type</div>
                <div class="flex flex-wrap items-center gap-2">
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {{ ''|yesno:'bg-brand-sky text-slate-900 hover:brightness-105,border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10' }}"
                        onclick="document.getElementById('filter-type-input').value=''; document.getElementById('filter-form').submit();">
                        All
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'sale' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='sale'; document.getElementById('filter-form').submit();">
                        For Sale
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'swap' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='swap'; document.getElementById('filter-form').submit();">
                        Swap
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'buy' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='buy'; document.getElementById('filter-form').submit();">
                        Wanted
                    </button>
                </div>
            </div>
        </section>

        <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% if not listings %}
            <div class="col-span-full text-center py-16">
                <p class="text-lg font-semibold text-slate-700 mb-2">No matching results</p>
                <p class="text-sm text-slate-500">Try adjusting your search, category, or type filters.</p>
            </div>
            {% else %}
            {% for listing in listings %}
            <article
                class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col hover:-translate-y-2 hover:shadow-lg transition-all duration-300"
                data-listing-id="{{ listing.id }}"
                data-images="{% for image in listing.images.all %}{{ image.image.url }}{% if not forloop.last %},{% endif %}{% endfor %}"
                data-title="{{ listing.title }}" data-description="{{ listing.description|safe }}"
                data-price="{% if listing.listing_type == 'sale' and listing.price %}₱{{ listing.price }}{% endif %}"
                data-swap-for="{% if listing.listing_type == 'swap' and listing.swap_for %}{{ listing.swap_for }}{% endif %}"
                data-budget="{% if listing.listing_type == 'buy' and listing.budget %}₱{{ listing.budget }}{% endif %}"
                data-location="{{ listing.location }}" data-date="{{ listing.date|date:'m/d/Y' }}"
                data-your-name="{{ listing.your_name }}" data-company="{{ listing.company }}"
                data-listing-type="{{ listing.listing_type }}"
                data-category="{% if listing.category %}{{ listing.category }}{% endif %}"
                data-subcategory="{% if listing.subcategory %}{{ listing.subcategory }}{% endif %}">
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4 cursor-pointer"
                    onclick="openImageGallery('{{ listing.id }}')">
                    {% if listing.main_image %}
                    <img src="{{ listing.main_image.image.url }}" alt="{{ listing.title }}"
                        class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                    {% else %}
                    <img src="{% static 'thryve_app/images/listing-placeholder.png' %}" alt="No image available"
                        class="w-full h-full object-cover">
                    {% endif %}
                </div>

                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        {% if listing.listing_type == 'sale' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                </path>
                            </svg>
                            SALE
                        </span>
                        {% elif listing.listing_type == 'swap' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            SWAP
                        </span>
                        {% elif listing.listing_type == 'buy' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            BUY
                        </span>
                        {% endif %}
                        {% if listing.category %}
                        {% if listing.subcategory %}
                        <span
                            class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                            {% if listing.category == 'electronics' %}
                            {% if listing.subcategory == 'computers' %}Computers
                            {% elif listing.subcategory == 'phones' %}Phones
                            {% elif listing.subcategory == 'tablets' %}Tablets
                            {% elif listing.subcategory == 'audio_video' %}Audio/Video Equipment
                            {% elif listing.subcategory == 'cameras' %}Cameras
                            {% else %}Other Electronics{% endif %}
                            {% elif listing.category == 'furniture' %}
                            {% if listing.subcategory == 'office_chairs' %}Office Chairs
                            {% elif listing.subcategory == 'desks' %}Desks
                            {% elif listing.subcategory == 'cabinets' %}Cabinets
                            {% elif listing.subcategory == 'tables' %}Tables
                            {% elif listing.subcategory == 'seating' %}Seating
                            {% else %}Other Furniture{% endif %}
                            {% elif listing.category == 'tools_equipment' %}
                            {% if listing.subcategory == 'power_tools' %}Power Tools
                            {% elif listing.subcategory == 'hand_tools' %}Hand Tools
                            {% elif listing.subcategory == 'machinery' %}Machinery
                            {% elif listing.subcategory == 'safety_equipment' %}Safety Equipment
                            {% elif listing.subcategory == 'measuring_tools' %}Measuring Tools
                            {% else %}Other Tools & Equipment{% endif %}
                            {% elif listing.category == 'raw_materials' %}
                            {% if listing.subcategory == 'metals' %}Metals
                            {% elif listing.subcategory == 'plastics' %}Plastics
                            {% elif listing.subcategory == 'woods' %}Woods
                            {% elif listing.subcategory == 'chemicals' %}Chemicals
                            {% elif listing.subcategory == 'fabrics' %}Fabrics
                            {% else %}Other Raw Materials{% endif %}
                            {% elif listing.category == 'services' %}
                            {% if listing.subcategory == 'consulting' %}Consulting
                            {% elif listing.subcategory == 'maintenance' %}Maintenance
                            {% elif listing.subcategory == 'installation' %}Installation
                            {% elif listing.subcategory == 'training' %}Training
                            {% elif listing.subcategory == 'design' %}Design
                            {% else %}Other Services{% endif %}
                            {% else %}
                            Miscellaneous
                            {% endif %}
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                            {% if listing.category == 'electronics' %}Electronics
                            {% elif listing.category == 'furniture' %}Furniture
                            {% elif listing.category == 'tools_equipment' %}Tools & Equipment
                            {% elif listing.category == 'raw_materials' %}Raw Materials
                            {% elif listing.category == 'services' %}Services
                            {% else %}Other{% endif %}
                        </span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <span
                        class="inline-flex items-center gap-1 text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Available
                    </span>
                </div>
                {% if listing.title|length > 25 %}
                <div class="title-scroll-container relative">
                    <div class="title-scroll-text whitespace-nowrap">
                        <h3 class="text-lg font-bold inline-block">{{ listing.title }}</h3>
                        <span class="title-spacer text-lg font-bold inline-block"
                            aria-hidden="true">{{listing.title}}</span>
                    </div>
                </div>
                {% else %}
                <h3 class="text-lg font-bold truncate">{{ listing.title }}</h3>
                {% endif %}
                <div class="mt-0.5 text-slate-500 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <strong>{{ listing.your_name }}</strong> | {{ listing.company }}
                </div>
                <div class="relative mt-3 text-slate-700 card-description">
                    {% with stripped_desc=listing.description|striptags %}
                    {% if stripped_desc|length > 120 %}
                    <p class="pr-16 break-words whitespace-normal line-clamp-2">
                        {{ stripped_desc|slice:":200" }}
                    </p>
                    <span class="absolute right-0 bottom-0 bg-white pl-2 z-10 cursor-pointer"
                        onclick="openListingDetailsModal('{{ listing.id }}')">
                        <span
                            class="font-semibold text-slate-700 hover:text-brand-leaf transition-colors duration-200">...
                            See More</span>
                    </span>
                    {% else %}
                    <div class="description-preview break-words whitespace-normal line-clamp-2">
                        {{ listing.description|safe }}
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>

                {% if listing.listing_type == 'sale' and listing.price %}
                <div class="mt-4 text-[22px] font-extrabold text-brand-leaf">₱{{ listing.price }}</div>
                {% elif listing.listing_type == 'swap' and listing.swap_for %}
                <div class="mt-4 text-[22px] font-extrabold flex items-baseline gap-2">
                    <span class="text-slate-700 shrink-0">Looking for:</span>
                    {% if listing.swap_for|length > 15 %}
                    <div class="looking-scroll-container flex-1 min-w-0">
                        <div class="looking-scroll-text whitespace-nowrap">
                            <span class="text-brand-leaf inline-block">{{ listing.swap_for }}</span>
                            <span class="looking-spacer text-brand-leaf inline-block"
                                aria-hidden="true">{{listing.swap_for }}</span>
                        </div>
                    </div>
                    {% else %}
                    <span class="text-brand-leaf truncate flex-1 min-w-0">{{ listing.swap_for }}</span>
                    {% endif %}
                </div>
                {% elif listing.listing_type == 'buy' and listing.budget %}
                <div class="mt-4 text-[22px] font-extrabold"><span class="text-slate-700">Budget:</span> <span
                        class="text-brand-leaf">₱{{ listing.budget }}</span></div>
                {% endif %}

                <div class="mt-2 flex items-center justify-between text-sm text-slate-500 font-medium">
                    <span class="flex items-center gap-1 max-w-[60%]">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        {% if listing.location|length > 20 %}
                        <div class="location-scroll-container">
                            <div class="location-scroll-text whitespace-nowrap">
                                <span class="inline-block">{{ listing.location }}</span>
                                <span class="location-spacer inline-block" aria-hidden="true">{{
                                    listing.location}}</span>
                            </div>
                        </div>
                        {% else %}
                        <span class="truncate">{{ listing.location }}</span>
                        {% endif %}
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ listing.date|date:"m/d/Y" }}
                    </span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    {% if is_my_listings %}
                    <button onclick="openEditModal{{ listing.id }}()"
                        class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">Edit
                        Details</button>
                    <button onclick="openDeleteListingModal('{{ listing.id }}')"
                        class="text-center rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5">Delete</button>
                    {% else %}
                    <button onclick="openListingDetailsModal('{{ listing.id }}')"
                        class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View
                        Details</button>
                    <button onclick="openBookNowModal('{{ listing.id }}')"
                        class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book
                        Now</button>
                    {% endif %}
                </div>
            </article>

            <!-- Individual Edit Modal for Listing {{ listing.id }} -->
            {% if is_my_listings %}
            <script>
                function openEditModal{{ listing.id }}() {
                    document.getElementById('editModal{{ listing.id }}').classList.remove('hidden');
                    document.getElementById('editModal{{ listing.id }}').classList.add('flex');
                }
                function closeEditModal{{ listing.id }}() {
                    document.getElementById('editModal{{ listing.id }}').classList.add('hidden');
                    document.getElementById('editModal{{ listing.id }}').classList.remove('flex');
                }
                let editNewImagesData{{ listing.id }} = [];

                function handleImagePreview{{ listing.id }}(input) {
                    const previewContainer = document.getElementById('imagePreview{{ listing.id }}');
                    const photoCounter = document.getElementById('photoCounter{{ listing.id }}');
                    const existingCount = {{ listing.images.count }};
                    const fileInput = input;

                    if (input.files && input.files.length > 0) {
                        const currentNewCount = editNewImagesData{{ listing.id }}.length;
                        const availableSlots = 5 - existingCount - currentNewCount;

                        if (availableSlots <= 0) {
                            alert('Maximum 5 images allowed. You have reached the limit.');
                            fileInput.value = '';
                            return;
                        }

                        const filesToAdd = Math.min(input.files.length, availableSlots);
                        if (input.files.length > availableSlots) {
                            alert(`You can only add ${availableSlots} more image(s). Only the first ${availableSlots} will be added.`);
                        }

                        // Add new files to our array
                        for (let i = 0; i < filesToAdd; i++) {
                            editNewImagesData{{ listing.id }}.push(input.files[i]);

                            const reader = new FileReader();
                            const fileIndex = currentNewCount + i;
                            reader.onload = function(e) {
                                const previewDiv = document.createElement('div');
                                previewDiv.className = 'relative group new-image-preview';
                                previewDiv.setAttribute('data-index', fileIndex);
                                previewDiv.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                                    <div class="absolute top-1 right-1 bg-brand-sky text-white text-xs px-1.5 py-0.5 rounded">New</div>
                                    <button type="button" onclick="removeNewImage{{ listing.id }}(${fileIndex})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity">×</button>
                                `;
                                previewContainer.appendChild(previewDiv);
                            };
                            reader.readAsDataURL(input.files[i]);
                        }

                        const totalCount = existingCount + editNewImagesData{{ listing.id }}.length;
                        photoCounter.textContent = `Photos: ${totalCount}/5`;

                        // Clear the file input so the same file can be selected again
                        fileInput.value = '';
                    }
                }

                function removeNewImage{{ listing.id }}(index) {
                    // Remove from array
                    editNewImagesData{{ listing.id }}.splice(index, 1);

                    // Update preview container
                    const previewContainer = document.getElementById('imagePreview{{ listing.id }}');
                    const allNewPreviews = previewContainer.querySelectorAll('.new-image-preview');
                    allNewPreviews.forEach(preview => preview.remove());

                    // Re-render remaining new images with updated indices
                    editNewImagesData{{ listing.id }}.forEach((file, newIndex) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'relative group new-image-preview';
                            previewDiv.setAttribute('data-index', newIndex);
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                                <div class="absolute top-1 right-1 bg-brand-sky text-white text-xs px-1.5 py-0.5 rounded">New</div>
                                <button type="button" onclick="removeNewImage{{ listing.id }}(${newIndex})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity">×</button>
                            `;
                            previewContainer.appendChild(previewDiv);
                        };
                        reader.readAsDataURL(file);
                    });

                    // Update counter
                    const existingCount = {{ listing.images.count }};
                    const totalCount = existingCount + editNewImagesData{{ listing.id }}.length;
                    document.getElementById('photoCounter{{ listing.id }}').textContent = `Photos: ${totalCount}/5`;
                }

                function submitEditForm{{ listing.id }}(form) {
                    // Create a new DataTransfer object to hold our files
                    const dataTransfer = new DataTransfer();

                    // Add all new images to the file input
                    editNewImagesData{{ listing.id }}.forEach(file => {
                        dataTransfer.items.add(file);
                    });

                    // Update the file input with our collected files
                    const fileInput = form.querySelector('input[type="file"]');
                    fileInput.files = dataTransfer.files;

                    return true; // Allow form submission
                }
            </script>
            <div id="editModal{{ listing.id }}" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="if(event.target === this) closeEditModal{{ listing.id }}()">
                <div class="flex items-center justify-center min-h-screen p-4 w-full">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-slate-900">Edit Listing</h2>
                                <button onclick="closeEditModal{{ listing.id }}()" type="button" class="text-slate-400 hover:text-slate-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <form method="post" action="{% url 'thryve_app:edit_listing' listing.id %}" enctype="multipart/form-data" onsubmit="return submitEditForm{{ listing.id }}(this)">
                                {% csrf_token %}

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="sale" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'sale' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">For Sale</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="swap" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'swap' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">For Swap</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="buy" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'buy' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">Looking to Buy</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Category *</label>
                                    <input type="hidden" name="category" value="{% if listing.subcategory %}{{ listing.category }}-{{ listing.subcategory }}{% else %}{{ listing.category }}{% endif %}">
                                    <div class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-slate-100 text-slate-700">
                                        {{ listing.category_display }}{% if listing.subcategory_display %} - {{ listing.subcategory_display }}{% endif %}
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Title *</label>
                                    <input type="text" name="title" value="{{ listing.title }}" placeholder="Enter listing title" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Description *</label>
                                    <textarea name="description" rows="4" placeholder="Describe your item or service" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 resize-y" required>{{ listing.description }}</textarea>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">
                                        {% if listing.listing_type == 'sale' %}Price *
                                        {% elif listing.listing_type == 'swap' %}Looking to Swap For *
                                        {% elif listing.listing_type == 'buy' %}Budget *
                                        {% endif %}
                                    </label>
                                    {% if listing.listing_type == 'sale' %}
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                        <input type="text" name="price" value="{{ listing.price }}" placeholder="0.00" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    </div>
                                    {% elif listing.listing_type == 'swap' %}
                                    <input type="text" name="swap_for" value="{{ listing.swap_for }}" placeholder="What are you looking to swap for?" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    {% elif listing.listing_type == 'buy' %}
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                        <input type="text" name="budget" value="{{ listing.budget }}" placeholder="0.00" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Location *</label>
                                    <input type="text" name="location" value="{{ listing.location }}" placeholder="City, State/Country" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Date *</label>
                                    <input type="date" name="date" value="{{ listing.date|date:'Y-m-d' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Listing Images</label>

                                    <!-- Image Preview Section -->
                                    <div id="imagePreview{{ listing.id }}" class="flex flex-wrap gap-2 mb-3">
                                        {% for image in listing.images.all %}
                                        <div class="relative group">
                                            <img src="{{ image.image.url }}" alt="Listing image" class="w-20 h-20 object-cover rounded-lg border-2 border-slate-300">
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors bg-slate-50 relative">
                                        <div class="flex flex-col items-center justify-center space-y-4">
                                            <div class="w-12 h-12 text-slate-400">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                                <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                                            </div>
                                            <p id="photoCounter{{ listing.id }}" class="text-sm font-medium text-slate-600">Photos: {{ listing.images.count }}/5</p>
                                        </div>
                                        <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer pointer-events-auto" onchange="handleImagePreview{{ listing.id }}(this)">
                                    </div>
                                    <div class="mt-2 text-sm text-slate-500">
                                        <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-3">
                                    <button type="button" onclick="closeEditModal{{ listing.id }}()" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                                    <button type="submit" class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update Listing</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% empty %}
            <article class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col">
                <div class="col-span-full text-center py-12">
                    <p class="text-slate-500 text-lg">No listings created</p>
                </div>
            </article>
            {% endfor %}
            {% endif %}
        </section>
    </main>

    <!-- Listing Details Modal -->
    <div id="listing-details-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900" id="details-modal-title">Listing Details</h2>
                    <button id="close-details-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Main Image -->
                <div class="w-full h-64 bg-slate-100 rounded-lg overflow-hidden mb-6" id="details-main-image-container">
                    <img id="details-main-image" src="" alt="Listing image" class="w-full h-full object-cover">
                </div>

                <!-- Listing Type and Category Badges -->
                <div class="flex items-center gap-2 mb-4" id="details-badges">
                    <!-- Badges will be populated by JavaScript -->
                </div>

                <!-- Title (wrapped, no overflow) -->
                <h3 class="text-2xl font-bold text-slate-900 mb-2 break-words whitespace-normal" id="details-title">
                </h3>

                <!-- Seller Info -->
                <div class="flex items-center gap-2 text-slate-600 font-medium mb-4" id="details-seller">
                    <!-- Seller info will be populated by JavaScript -->
                </div>

                <!-- Description -->
                <div class="text-slate-700 mb-6" id="details-description">
                    <!-- Description will be populated by JavaScript -->
                </div>

                <!-- Price/Swap/Budget (wrapped, with non-overflowing swap text) -->
                <div class="text-3xl font-extrabold text-brand-leaf mb-6 break-words whitespace-normal"
                    id="details-price">
                    <!-- Price info will be populated by JavaScript -->
                </div>

                <!-- Location and Date -->
                <div class="flex items-center justify-between text-sm text-slate-500 mb-6" id="details-meta">
                    <!-- Meta info will be populated by JavaScript -->
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button
                        class="flex-1 text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-3">Book
                        Now</button>
                    <button id="view-gallery-btn"
                        class="flex-1 text-center rounded-lg border border-brand-sky text-brand-sky font-semibold py-3 hover:bg-brand-sky/10">View
                        Gallery</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="image-gallery-modal"
        class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center">
        <div class="relative w-full max-w-4xl mx-4 flex flex-col items-center">
            <!-- Close button -->
            <button id="close-gallery"
                class="absolute -top-12 right-0 text-white hover:text-slate-300 text-2xl font-bold z-10">
                ✕
            </button>

            <!-- Main image container -->
            <div
                class="relative w-full h-[70vh] flex items-center justify-center bg-transparent rounded-lg overflow-hidden">
                <img id="gallery-main-image" src="" alt=""
                    class="max-w-full max-h-full object-contain rounded-lg transition-transform duration-300 ease-out cursor-grab"
                    style="transform: scale(1) translate(0, 0); transform-origin: center center;"
                    onwheel="handleWheelZoom(event)">

                <!-- Navigation arrows -->
                <button id="prev-image"
                    class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ‹
                </button>
                <button id="next-image"
                    class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ›
                </button>

                <!-- Zoom controls -->
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                    <button id="zoom-out"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all"
                        title="Zoom Out">
                        −
                    </button>
                    <button id="zoom-reset"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm transition-all"
                        title="Reset Zoom">
                        1:1
                    </button>
                    <button id="zoom-in"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all"
                        title="Zoom In">
                        +
                    </button>
                </div>
            </div>

            <!-- Image counter -->
            <div class="text-center mt-4">
                <span id="image-counter"
                    class="text-white text-sm bg-black bg-opacity-50 px-3 py-1 rounded-full"></span>
            </div>

            <!-- Thumbnail strip -->
            <div id="thumbnail-strip" class="flex justify-center gap-2 mt-4 max-w-full overflow-x-auto">
                <!-- Thumbnails will be populated by JavaScript -->
            </div>
        </div>
    </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-listing-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Delete Listing</h2>
                    <button id="close-delete-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-slate-700">Are you sure you want to delete this listing? This action cannot be
                        undone.</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button id="cancel-delete-btn"
                        class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                    <button id="confirm-delete-btn"
                        class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition">Delete
                        Listing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div id="edit-listing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Edit Listing</h2>
                        <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="edit-listing-form" method="post" action="" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_category" class="block text-slate-700 font-semibold mb-2">Category
                                *</label>
                            <div class="relative">
                                <input type="hidden" name="category" id="edit_id_category" value="">
                                <div id="edit-category-selector-trigger"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="edit-category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">▾</span>
                                </div>

                                <div id="edit-category-selector"
                                    class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES
                                                </div>
                                                <div id="edit-main-categories" class="space-y-1">
                                                    {% for key, data in categories.items %}
                                                    <button type="button"
                                                        class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn"
                                                        data-category="{{ key }}">{{ data.label }}</button>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES
                                                </div>
                                                <div id="edit-subcategories" class="space-y-1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_title" class="block text-slate-700 font-semibold mb-2">Title *</label>
                            <input type="text" name="title"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                placeholder="Enter listing title" id="edit_id_title">
                            {% if form.title.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.title.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_description" class="block text-slate-700 font-semibold mb-2">Description
                                *</label>
                            <textarea name="description" id="edit_id_description"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 resize-y overflow-y-auto"
                                rows="4" placeholder="Describe your item or service"></textarea>
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4" id="edit-dynamic-field-container">
                            <label id="edit-dynamic-field-label" for="edit_id_price"
                                class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="edit-price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="price"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="0.00" id="edit_id_price">
                            </div>
                            <div class="hidden" id="edit-swap-container">
                                <input type="text" name="swap_for"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="What are you looking to swap for?" id="edit_id_swap_for">
                            </div>
                            <div class="relative hidden" id="edit-budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="budget"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="0.00" id="edit_id_budget">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_location" class="block text-slate-700 font-semibold mb-2">Location
                                *</label>
                            <div class="relative">
                                <input type="text" name="location" id="edit_id_location"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="City, State/Country">
                            </div>
                            {% if form.location.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.location.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_date" class="block text-slate-700 font-semibold mb-2">Date *</label>
                            <input type="date" name="date" id="edit_id_date"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                            {% if form.date.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_images" class="block text-slate-700 font-semibold mb-2">Listing
                                Images</label>

                            <!-- All Images Display (Current + New) -->
                            <div id="edit-all-images" class="mb-4">
                                <!-- Current images will be populated by JavaScript -->
                            </div>

                            <!-- Upload Area -->
                            <div id="edit-upload-area"
                                class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="edit-upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                    </div>
                                    <div id="edit-upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span
                                                class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="edit-image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp"
                                    id="edit_id_images" multiple
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            </div>

                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="edit-cancel-btn"
                                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="button" id="edit-submit-btn" onclick="submitEditListingForm()"
                                class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update
                                Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="add-listing-modal"
        class="fixed inset-0 bg-black bg-opacity-50 {% if show_modal %}flex{% else %}hidden{% endif %} z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Create New Listing</h2>
                        <button id="close-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="listing-form" method="post" action="{% url 'thryve_app:create_listing' %}"
                        enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <!-- Display non-field errors -->
                        {% if form.non_field_errors %}
                        <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            {% for error in form.non_field_errors %}
                            <p class="text-sm">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'sale' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'swap' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'buy' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                            {% if form.listing_type.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.listing_type.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.category.id_for_label }}"
                                class="block text-slate-700 font-semibold mb-2">Category *</label>
                            <div class="relative">
                                <!-- Hidden input to store the selected value -->
                                <input type="hidden" name="category" id="id_category" value="{{ form.category.value|default:'' }}">

                                <!-- Custom category selector trigger -->
                                <div id="category-selector-trigger"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">▾</span>
                                </div>

                                <!-- Two-column category selector -->
                                <div id="category-selector"
                                    class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <!-- Left Column: Main Categories -->
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES
                                                </div>
                                                <div id="main-categories" class="space-y-1">
                                                    {% for key, data in categories.items %}
                                                    <button type="button"
                                                        class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn{% if forloop.first %} active{% endif %}"
                                                        data-category="{{ key }}">{{ data.label }}</button>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Subcategories -->
                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES
                                                </div>
                                                <div id="subcategories" class="space-y-1">
                                                    <!-- Subcategories will be populated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if form.category.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.category.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}"
                                class="block text-slate-700 font-semibold mb-2">Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.title.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_description" class="block text-slate-700 font-semibold mb-2">Description
                                *</label>
                            <textarea name="description" id="id_description" rows="4"
                                placeholder="Describe your item or service"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 whitespace-normal break-words resize-y"></textarea>
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4" id="dynamic-field-container">
                            <label id="dynamic-field-label" for="id_price"
                                class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="price"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="0.00" id="id_price" value="{{ form.price.value|default:'' }}">
                                {% if form.price.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.price.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div class="hidden" id="swap-container">
                                <input type="text" name="swap_for"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="What are you looking to swap for?" id="id_swap_for" value="{{ form.swap_for.value|default:'' }}">
                                {% if form.swap_for.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.swap_for.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div class="relative hidden" id="budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="budget"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="0.00" id="id_budget" value="{{ form.budget.value|default:'' }}">
                                {% if form.budget.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.budget.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>


                        <div class="mb-4">
                            <label for="id_location" class="block text-slate-700 font-semibold mb-2">Location *</label>
                            <div class="relative">
                                <input type="text" name="location" id="id_location"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="City, State/Country">
                            </div>
                            {% if form.location.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.location.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_date" class="block text-slate-700 font-semibold mb-2">Date *</label>
                            <input type="date" name="date" id="id_date"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                            {% if form.date.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_images" class="block text-slate-700 font-semibold mb-2">Listing
                                Images</label>

                            <!-- Image Previews Container (New Images Only) -->
                            <div id="create-image-previews" class="mb-3 flex flex-wrap gap-2">
                                <!-- New image thumbnails will be rendered here -->
                            </div>

                            <!-- Drag and Drop Upload Area -->
                            <div id="upload-area"
                                class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                    </div>
                                    <div id="upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span
                                                class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="create-image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp"
                                    id="id_images" multiple
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    onchange="handleCreateImagePreview(this)">
                            </div>

                            <!-- Upload Info -->
                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="cancel-btn"
                                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="submit" id="submit-btn"
                                class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Create
                                Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Nominatim Geocoder Implementation - OPTIMIZED
        function initLocationAutocomplete() {
            const locationInput = document.getElementById('id_location');

            if (!locationInput || locationInput.dataset.geocoderInitialized === 'true') {
                return;
            }

            locationInput.dataset.geocoderInitialized = 'true';

            // Cache for previous searches
            const searchCache = new Map();

            // Common Philippine locations for instant results
            const commonLocations = {
                'cebu': [
                    { display_name: 'Cebu City, Cebu, Philippines' },
                    { display_name: 'Mandaue City, Cebu, Philippines' },
                    { display_name: 'Lapu-Lapu City, Cebu, Philippines' },
                    { display_name: 'Talisay City, Cebu, Philippines' }
                ],
                'manila': [
                    { display_name: 'Manila, Metro Manila, Philippines' },
                    { display_name: 'Quezon City, Metro Manila, Philippines' },
                    { display_name: 'Makati, Metro Manila, Philippines' },
                    { display_name: 'Taguig, Metro Manila, Philippines' }
                ],
                'davao': [
                    { display_name: 'Davao City, Davao del Sur, Philippines' }
                ],
                'cebu city': [
                    { display_name: 'Cebu City, Cebu, Philippines' }
                ]
            };

            let geocodeTimeout;
            let currentDropdown = null;
            let lastQuery = '';

            locationInput.addEventListener('input', function () {
                clearTimeout(geocodeTimeout);
                const query = this.value.trim();

                // Don't search if same query or too short
                if (query === lastQuery || query.length < 2) {
                    removeDropdown();
                    return;
                }

                lastQuery = query;

                // Reduced debounce for faster response
                geocodeTimeout = setTimeout(() => {
                    searchLocations(query, locationInput);
                }, 150); // Much faster response
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!locationInput.parentNode.contains(e.target)) {
                    removeDropdown();
                }
            });

            function searchLocations(query, input) {
                const lowerQuery = query.toLowerCase();

                // 1. Check common locations first (INSTANT)
                if (commonLocations[lowerQuery]) {
                    showLocationSuggestions(commonLocations[lowerQuery], input);
                    return;
                }

                // 2. Check cache
                if (searchCache.has(query)) {
                    showLocationSuggestions(searchCache.get(query), input);
                    return;
                }

                // 3. API call with optimized parameters
                const searchUrl = `https://nominatim.openstreetmap.org/search?` +
                    `format=json&` +
                    `q=${encodeURIComponent(query)}+Philippines&` + // Add Philippines for better results
                    `countrycodes=ph&` +
                    `limit=4&` + // Fewer results = faster
                    `addressdetails=1&` +
                    `dedupe=1`;

                fetch(searchUrl)
                    .then(response => response.json())
                    .then(data => {
                        searchCache.set(query, data);
                        showLocationSuggestions(data, input);
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        removeDropdown();
                    });
            }

            function showLocationSuggestions(suggestions, input) {
                removeDropdown();

                if (suggestions.length === 0) return;

                const dropdown = document.createElement('div');
                dropdown.className = 'suggestions-dropdown absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg z-50 mt-1 max-h-48 overflow-y-auto';

                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'px-3 py-2 hover:bg-slate-100 cursor-pointer text-sm border-b border-slate-100 last:border-b-0 transition-colors';

                    const displayName = formatDisplayName(suggestion.display_name);
                    item.textContent = displayName;

                    item.addEventListener('click', () => {
                        input.value = displayName;
                        removeDropdown();
                    });
                    dropdown.appendChild(item);
                });

                input.parentNode.appendChild(dropdown);
                currentDropdown = dropdown;
            }

            function formatDisplayName(fullName) {
                const parts = fullName.split(',');
                if (parts.length > 3) {
                    return parts.slice(0, 3).join(', ').trim();
                }
                return fullName;
            }

            function removeDropdown() {
                if (currentDropdown) {
                    currentDropdown.remove();
                    currentDropdown = null;
                }
            }
        }

        // Delete listing modal variables
        let currentDeleteListingId = null;

        // Create listing image handling – simple, uses the real file input
        function handleCreateImagePreview(input) {
            const previewContainer = document.getElementById('create-image-previews');
            const photoCounter = document.getElementById('create-image-counter');
            if (!previewContainer || !photoCounter) return;

            // No files selected – reset
            if (!input.files || input.files.length === 0) {
                previewContainer.innerHTML = '';
                photoCounter.textContent = 'Photos: 0/5';
                return;
            }

            // Enforce max 5
            if (input.files.length > 5) {
                alert('Maximum 5 images allowed. Only the first 5 will be used.');
            }

            const files = Array.from(input.files).slice(0, 5);

            // Clear and render previews
            previewContainer.innerHTML = '';
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });

            // Update counter based on actual selected files
            photoCounter.textContent = `Photos: ${files.length}/5`;
        }

        // Edit listing modal variables
        let currentEditListingId = null;
        let editExistingImagesCount = 0;
        let editNewImages = [];

        // Edit category selector functionality
        const editCategorySelector = {
            trigger: document.getElementById('edit-category-selector-trigger'),
            selector: document.getElementById('edit-category-selector'),
            displayText: document.getElementById('edit-category-display-text'),
            hiddenInput: document.getElementById('edit_id_category'),
            mainCategories: document.getElementById('edit-main-categories'),
            subcategories: document.getElementById('edit-subcategories'),
            activeCategory: null,
            selectedSubcategory: null,

            subcategoriesData: {
                {% for key, data in categories.items %}
        '{{ key }}': [
            {% for sub in data.subcategories %}
        { value: '{{ sub.value }}', label: '{{ sub.label }}' } {% if not forloop.last %}, {% endif %}
        {% endfor %}
                ]{% if not forloop.last %}, {% endif %}
        {% endfor %}
            },

        init() {
            if (this.trigger && this.selector) {
                this.setupEventListeners();
            }
        },

        setupEventListeners() {
            this.trigger.addEventListener('click', () => {
                this.toggleSelector();
            });

            document.addEventListener('click', (e) => {
                if (!this.trigger.contains(e.target) && !this.selector.contains(e.target)) {
                    this.closeSelector();
                }
            });

            this.mainCategories.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const category = e.target.dataset.category;
                    this.selectCategory(category);
                }
            });

            this.subcategories.addEventListener('click', (e) => {
                if (e.target.classList.contains('subcategory-btn')) {
                    const value = e.target.dataset.value;
                    const label = e.target.textContent;
                    this.selectSubcategory(value, label);
                }
            });
        },

        selectCategory(category) {
            this.mainCategories.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-brand-sky', 'text-white');
                btn.classList.add('hover:bg-brand-sky/10');
            });

            const activeBtn = this.mainCategories.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-brand-sky', 'text-white');
                activeBtn.classList.remove('hover:bg-brand-sky/10');
            }

            this.activeCategory = category;
            this.updateSubcategories(category);
        },

        updateSubcategories(category) {
            this.subcategories.innerHTML = '';
            const subs = this.subcategoriesData[category] || [];

            subs.forEach(sub => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded subcategory-btn';
                btn.dataset.value = `${category}-${sub.value}`;
                btn.textContent = sub.label;
                this.subcategories.appendChild(btn);
            });
        },

        selectSubcategory(value, label) {
            this.subcategories.querySelectorAll('.subcategory-btn').forEach(btn => {
                btn.classList.remove('bg-brand-leaf', 'text-white');
                btn.classList.add('hover:bg-brand-sky/10');
            });

            const selectedBtn = this.subcategories.querySelector(`[data-value="${value}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('bg-brand-leaf', 'text-white');
                selectedBtn.classList.remove('hover:bg-brand-sky/10');
            }

            this.displayText.textContent = label;
            this.displayText.classList.remove('text-slate-500');
            this.displayText.classList.add('text-slate-900');
            this.hiddenInput.value = value;

            this.selectedSubcategory = value.split('-')[1];
            this.closeSelector();
        },

        toggleSelector() {
            if (this.selector.classList.contains('hidden')) {
                this.openSelector();
            } else {
                this.closeSelector();
            }
        },

        openSelector() {
            this.selector.classList.remove('hidden');
            this.selector.classList.add('flex');
            this.trigger.classList.add('ring-2', 'ring-brand-sky');
        },

        closeSelector() {
            this.selector.classList.add('hidden');
            this.selector.classList.remove('flex');
            this.trigger.classList.remove('ring-2', 'ring-brand-sky');
        },

        setCategory(category, subcategory) {
            this.activeCategory = category;
            this.selectedSubcategory = subcategory;

            // Update visual state
            this.selectCategory(category);
            if (subcategory) {
                const subcategoryValue = `${category}-${subcategory}`;
                const label = this.getSubcategoryLabel(subcategory);
                this.selectSubcategory(subcategoryValue, label);
            }
        },

        getSubcategoryLabel(subcategory) {
            const subs = this.subcategoriesData[this.activeCategory] || [];
            const sub = subs.find(s => s.value === subcategory);
            return sub ? sub.label : subcategory;
        }
        };

        // Delete modal event listeners
        document.getElementById('close-delete-modal').addEventListener('click', closeDeleteListingModal);
        document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteListingModal);
        document.getElementById('confirm-delete-btn').addEventListener('click', function () {
            if (currentDeleteListingId) {
                // Create a form to submit DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/listings/delete-listing/${currentDeleteListingId}/`;

                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken.value;
                    form.appendChild(csrfInput);
                }

                document.body.appendChild(form);
                form.submit();
            }
        });

        // Close delete modal when clicking outside
        document.getElementById('delete-listing-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('delete-listing-modal')) {
                closeDeleteListingModal();
            }
        });

        // Edit modal event listeners
        document.getElementById('close-edit-modal').addEventListener('click', closeEditListingModal);
        document.getElementById('edit-cancel-btn').addEventListener('click', closeEditListingModal);

        // Close edit modal when clicking outside
        document.getElementById('edit-listing-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('edit-listing-modal')) {
                closeEditListingModal();
            }
        });

        // Edit listing type change handler
        document.querySelectorAll('#edit-listing-modal input[name="listing_type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateEditDynamicField(e.target.value);
            });
        });

        // Create listing multi-pick image handling
        let createSelectedFiles = [];

        function handleCreateImagePreview(input) {
            const previewContainer = document.getElementById('create-image-previews');
            const photoCounter = document.getElementById('create-image-counter');
            if (!previewContainer || !photoCounter) return;

            if (input.files && input.files.length > 0) {
                const currentCount = createSelectedFiles.length;
                const availableSlots = 5 - currentCount;

                if (availableSlots <= 0) {
                    alert('Maximum 5 images allowed. You have reached the limit.');
                    input.value = '';
                    return;
                }

                const filesToAdd = Array.from(input.files).slice(0, availableSlots);

                filesToAdd.forEach(file => {
                    createSelectedFiles.push(file);
                });

                // Re-render previews from accumulated files
                previewContainer.innerHTML = '';
                createSelectedFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'relative group';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                        `;
                        previewContainer.appendChild(previewDiv);
                    };
                    reader.readAsDataURL(file);
                });

                photoCounter.textContent = `Photos: ${createSelectedFiles.length}/5`;

                // Clear the input so user can pick more
                input.value = '';
            }
        }

        function syncCreateFilesToInput() {
            const fileInput = document.getElementById('id_images');
            if (!fileInput) return;

            const dataTransfer = new DataTransfer();
            createSelectedFiles.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        // Modal functionality
        const modal = document.getElementById('add-listing-modal');
        const addListingBtn = document.getElementById('add-listing-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const submitBtn = document.getElementById('submit-btn');
        const form = document.getElementById('listing-form');

        // Open modal
        addListingBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Initialize geocoder after a short delay to ensure DOM is ready
            setTimeout(() => {
                console.log('Modal opened, initializing geocoder...');
                initLocationAutocomplete();
            }, 300);
        });

        // Auto-open modal if there are form errors
        {% if show_create_modal %}
        document.addEventListener('DOMContentLoaded', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                initLocationAutocomplete();
            }, 300);
        });
        {% endif %}

        // Close modal functions
        const closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // Reset the form completely
            form.reset();

            // Clear all error messages
            form.querySelectorAll('.text-red-500').forEach(error => error.remove());
            form.querySelectorAll('.bg-red-100').forEach(error => error.remove());

            // Clear image previews and reset counter
            createSelectedFiles = [];
            document.getElementById('create-image-previews').innerHTML = '';
            document.getElementById('create-image-counter').textContent = 'Photos: 0/5';

            // Reset category selector
            document.getElementById('id_category').value = '';
            document.getElementById('category-display-text').textContent = 'Choose Category';
            document.getElementById('category-display-text').classList.add('text-slate-400');

            // Reset dynamic fields to default (For Sale / Price)
            const saleRadio = form.querySelector('input[name="listing_type"][value="sale"]');
            if (saleRadio) {
                saleRadio.checked = true;
                updateDynamicField('sale');
            }
        };

        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Before submit, make sure accumulated files are attached
        form.addEventListener('submit', () => {
            syncCreateFilesToInput();
        });

        // Dynamic form fields based on listing type
        const listingTypeRadios = form.querySelectorAll('input[name="listing_type"]');
        const dynamicFieldLabel = document.getElementById('dynamic-field-label');
        const priceContainer = document.getElementById('price-container');
        const swapContainer = document.getElementById('swap-container');
        const budgetContainer = document.getElementById('budget-container');

        function updateDynamicField(selectedType) {
            // Clear any existing errors for dynamic fields
            document.querySelectorAll('.error-message').forEach(el => {
                if (el.closest('#dynamic-field-container')) {
                    el.remove();
                }
            });

            // Hide all containers first
            priceContainer.classList.add('hidden');
            swapContainer.classList.add('hidden');
            budgetContainer.classList.add('hidden');

            // Show the appropriate container and update label
            if (selectedType === 'sale') {
                priceContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Price *';
                dynamicFieldLabel.setAttribute('for', 'id_price');
            } else if (selectedType === 'swap') {
                swapContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Looking to Swap For *';
                dynamicFieldLabel.setAttribute('for', 'id_swap_for');
            } else if (selectedType === 'buy') {
                budgetContainer.classList.remove('hidden');
                dynamicFieldLabel.textContent = 'Budget *';
                dynamicFieldLabel.setAttribute('for', 'id_budget');
            }
        }

        listingTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                updateDynamicField(e.target.value);
            });
        });


        // Category selector functionality
        const categorySelector = {
            trigger: document.getElementById('category-selector-trigger'),
            selector: document.getElementById('category-selector'),
            displayText: document.getElementById('category-display-text'),
            hiddenInput: document.getElementById('id_category'),
            mainCategories: document.getElementById('main-categories'),
            subcategories: document.getElementById('subcategories'),
            activeCategory: null,
            selectedSubcategory: null,

            subcategoriesData: {
                {% for key, data in categories.items %}
        '{{ key }}': [
            {% for sub in data.subcategories %}
        { value: '{{ sub.value }}', label: '{{ sub.label }}' } {% if not forloop.last %}, {% endif %}
        {% endfor %}
                ]{% if not forloop.last %}, {% endif %}
        {% endfor %}
            },

        init() {
            this.setupEventListeners();
            this.setDefaultCategory();
        },

        setupEventListeners() {
            // Toggle selector visibility
            this.trigger.addEventListener('click', () => {
                this.toggleSelector();
            });

            // Close selector when clicking outside
            document.addEventListener('click', (e) => {
                if (!this.trigger.contains(e.target) && !this.selector.contains(e.target)) {
                    this.closeSelector();
                }
            });

            // Category button clicks
            this.mainCategories.addEventListener('click', (e) => {
                if (e.target.classList.contains('category-btn')) {
                    const category = e.target.dataset.category;
                    this.selectCategory(category);
                }
            });

            // Subcategory selection
            this.subcategories.addEventListener('click', (e) => {
                if (e.target.classList.contains('subcategory-btn')) {
                    const value = e.target.dataset.value;
                    const label = e.target.textContent;
                    this.selectSubcategory(value, label);
                }
            });

            // Keyboard navigation
            this.selector.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeSelector();
                }
            });
        },

        setDefaultCategory() {
            // Default to first category (Electronics)
            const firstCategory = this.mainCategories.querySelector('.category-btn');
            if (firstCategory) {
                this.selectCategory(firstCategory.dataset.category);
            }
        },

        selectCategory(category) {
            // Update active category visual
            this.mainCategories.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-brand-sky', 'text-white');
                btn.classList.add('hover:bg-brand-sky/10');
            });

            const activeBtn = this.mainCategories.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-brand-sky', 'text-white');
                activeBtn.classList.remove('hover:bg-brand-sky/10');
            }

            this.activeCategory = category;
            this.updateSubcategories(category);
        },

        updateSubcategories(category) {
            this.subcategories.innerHTML = '';
            const subs = this.subcategoriesData[category] || [];

            subs.forEach(sub => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded subcategory-btn';
                btn.dataset.value = `${category}-${sub.value}`;
                btn.textContent = sub.label;
                this.subcategories.appendChild(btn);
            });
        },

        selectSubcategory(value, label) {
            // Update selected subcategory visual
            this.subcategories.querySelectorAll('.subcategory-btn').forEach(btn => {
                btn.classList.remove('bg-brand-leaf', 'text-white');
                btn.classList.add('hover:bg-brand-sky/10');
            });

            const selectedBtn = this.subcategories.querySelector(`[data-value="${value}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('bg-brand-leaf', 'text-white');
                selectedBtn.classList.remove('hover:bg-brand-sky/10');
            }

            // Update display and hidden input
            this.displayText.textContent = label;
            this.displayText.classList.remove('text-slate-500');
            this.displayText.classList.add('text-slate-900');
            this.hiddenInput.value = value;

            this.selectedSubcategory = value;

            // Clear category error if exists
            clearFieldError('category');

            // Close selector after selection
            setTimeout(() => this.closeSelector(), 150);
        },

        toggleSelector() {
            if (this.selector.classList.contains('hidden')) {
                this.openSelector();
            } else {
                this.closeSelector();
            }
        },

        openSelector() {
            this.selector.classList.remove('hidden');
            this.selector.classList.add('flex');
            this.trigger.classList.add('ring-2', 'ring-brand-sky');
        },

        closeSelector() {
            this.selector.classList.add('hidden');
            this.selector.classList.remove('flex');
            this.trigger.classList.remove('ring-2', 'ring-brand-sky');
        }
        };

        // Initialize category selector
        categorySelector.init();

        // Image Gallery Modal functionality
        var currentGalleryImages = [];
        var currentImageIndex = 0;

        function openImageGallery(listingId) {
            // Get all images for this listing dynamically
            currentGalleryImages = [];
            // We'll populate this from data attributes on the listing cards
            const listingCard = document.querySelector(`[data-listing-id="${listingId}"]`);
            if (listingCard) {
                const imagesData = listingCard.dataset.images;
                if (imagesData) {
                    // Split by comma and create image objects
                    const imageUrls = imagesData.split(',');
                    currentGalleryImages = imageUrls.map(url => ({
                        url: url.trim(),
                        alt: 'Listing image'
                    }));
                }
            }

            if (currentGalleryImages.length === 0) {
                // Fallback: show placeholder
                currentGalleryImages = [{
                    url: '{% static "thryve_app/images/listing-placeholder.png" %}',
                    alt: 'No image available'
                }];
            }

            currentImageIndex = 0;
            updateGalleryDisplay();
            document.getElementById('image-gallery-modal').classList.remove('hidden');
            document.getElementById('image-gallery-modal').classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        let currentZoom = 1;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        const minZoom = 0.5;
        const maxZoom = 3;
        const zoomStep = 0.1;
        let isDragging = false;
        let startX, startY, startTranslateX, startTranslateY;

        function updateGalleryDisplay() {
            const mainImage = document.getElementById('gallery-main-image');
            const counter = document.getElementById('image-counter');
            const thumbnailStrip = document.getElementById('thumbnail-strip');

            // Reset zoom and position when changing images
            currentZoom = 1;
            currentTranslateX = 0;
            currentTranslateY = 0;
            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
            mainImage.style.cursor = 'grab';

            // Update main image
            mainImage.src = currentGalleryImages[currentImageIndex].url;
            mainImage.alt = currentGalleryImages[currentImageIndex].alt;

            // Update counter
            counter.textContent = `${currentImageIndex + 1} / ${currentGalleryImages.length}`;

            // Update navigation buttons
            const prevBtn = document.getElementById('prev-image');
            const nextBtn = document.getElementById('next-image');

            prevBtn.style.opacity = currentImageIndex === 0 ? '0.3' : '1';
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.style.opacity = currentImageIndex === currentGalleryImages.length - 1 ? '0.3' : '1';
            nextBtn.disabled = currentImageIndex === currentGalleryImages.length - 1;

            // Update thumbnails
            thumbnailStrip.innerHTML = '';
            currentGalleryImages.forEach((image, index) => {
                const thumb = document.createElement('img');
                thumb.src = image.url;
                thumb.alt = image.alt;
                thumb.className = `w-16 h-16 object-cover rounded cursor-pointer border-2 ${index === currentImageIndex ? 'border-brand-sky' : 'border-transparent'} hover:border-slate-400 transition-all`;
                thumb.onclick = () => {
                    currentImageIndex = index;
                    updateGalleryDisplay();
                };
                thumbnailStrip.appendChild(thumb);
            });
        }

        function zoomImage(direction, event = null) {
            const mainImage = document.getElementById('gallery-main-image');
            const container = mainImage.parentElement;
            const containerRect = container.getBoundingClientRect();

            if (direction === 'reset') {
                currentZoom = 1;
                currentTranslateX = 0;
                currentTranslateY = 0;
                mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
                mainImage.style.cursor = 'grab';
                return;
            }

            // Calculate mouse position relative to container center
            let originX = 50; // percentage from left
            let originY = 50; // percentage from top

            if (event) {
                const mouseX = event.clientX - containerRect.left;
                const mouseY = event.clientY - containerRect.top;
                originX = (mouseX / containerRect.width) * 100;
                originY = (mouseY / containerRect.height) * 100;
            }

            // Set transform origin
            mainImage.style.transformOrigin = `${originX}% ${originY}%`;

            const oldZoom = currentZoom;

            if (direction === 'in' && currentZoom < maxZoom) {
                currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
            } else if (direction === 'out' && currentZoom > minZoom) {
                currentZoom = Math.max(currentZoom - zoomStep, minZoom);
            }

            // Update cursor
            mainImage.style.cursor = currentZoom > 1 ? 'grab' : 'grab';

            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
        }

        function handleMouseDown(e) {
            if (currentZoom <= 1) return;

            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startTranslateX = currentTranslateX;
            startTranslateY = currentTranslateY;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.style.cursor = 'grabbing';
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!isDragging || currentZoom <= 1) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            currentTranslateX = startTranslateX + deltaX;
            currentTranslateY = startTranslateY + deltaY;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.style.transform = `scale(${currentZoom}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
        }

        function handleMouseUp() {
            if (isDragging) {
                isDragging = false;
                const mainImage = document.getElementById('gallery-main-image');
                mainImage.style.cursor = currentZoom > 1 ? 'grab' : 'grab';
            }
        }

        function handleWheelZoom(event) {
            event.preventDefault();

            const direction = event.deltaY > 0 ? 'out' : 'in';
            zoomImage(direction, event);
        }

        function closeImageGallery() {
            document.getElementById('image-gallery-modal').classList.add('hidden');
            document.getElementById('image-gallery-modal').classList.remove('flex');
            document.body.style.overflow = ''; // Restore scrolling
        }

        function navigateImage(direction) {
            if (direction === 'prev' && currentImageIndex > 0) {
                currentImageIndex--;
            } else if (direction === 'next' && currentImageIndex < currentGalleryImages.length - 1) {
                currentImageIndex++;
            }
            updateGalleryDisplay();
        }

        // Event listeners for gallery modal
        document.getElementById('close-gallery').addEventListener('click', closeImageGallery);
        document.getElementById('prev-image').addEventListener('click', () => navigateImage('prev'));
        document.getElementById('next-image').addEventListener('click', () => navigateImage('next'));

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', (e) => zoomImage('in', e));
        document.getElementById('zoom-out').addEventListener('click', (e) => zoomImage('out', e));
        document.getElementById('zoom-reset').addEventListener('click', () => zoomImage('reset'));

        // Pan/drag functionality
        const mainImage = document.getElementById('gallery-main-image');
        mainImage.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        // Close gallery on background click
        document.getElementById('image-gallery-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('image-gallery-modal')) {
                closeImageGallery();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('image-gallery-modal').classList.contains('flex')) {
                if (e.key === 'Escape') {
                    closeImageGallery();
                } else if (e.key === 'ArrowLeft') {
                    navigateImage('prev');
                } else if (e.key === 'ArrowRight') {
                    navigateImage('next');
                }
            }
        });

        // Listing Details Modal functionality
        function openListingDetailsModal(listingId) {
            const listingCard = document.querySelector(`[data-listing-id="${listingId}"]`);
            if (!listingCard) return;

            // Get data from attributes
            const title = listingCard.dataset.title;
            const description = listingCard.dataset.description;
            const price = listingCard.dataset.price;
            const swapFor = listingCard.dataset.swapFor;
            const budget = listingCard.dataset.budget;
            const location = listingCard.dataset.location;
            const date = listingCard.dataset.date;
            const yourName = listingCard.dataset.yourName;
            const company = listingCard.dataset.company;
            const listingType = listingCard.dataset.listingType;
            const category = listingCard.dataset.category;
            const subcategory = listingCard.dataset.subcategory;
            const images = listingCard.dataset.images;

            // Populate modal content
            document.getElementById('details-title').textContent = title;
            document.getElementById('details-description').innerHTML = description;

            // Seller info
            const sellerElement = document.getElementById('details-seller');
            sellerElement.innerHTML = `
                <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <strong>${yourName}</strong> | ${company}
            `;

            // Price/Swap/Budget
            const priceElement = document.getElementById('details-price');
            if (listingType === 'sale' && price) {
                priceElement.textContent = price;
            } else if (listingType === 'swap' && swapFor) {
                priceElement.innerHTML = `<span class="text-slate-700 text-lg md:text-xl font-semibold">Looking for:</span> <span class="text-brand-leaf text-lg md:text-xl font-semibold">${swapFor}</span>`;
            } else if (listingType === 'buy' && budget) {
                priceElement.innerHTML = `<span class="text-slate-700 text-lg md:text-xl font-semibold">Budget:</span> <span class="text-brand-leaf text-lg md:text-xl font-semibold">${budget}</span>`;
            } else {
                priceElement.textContent = '';
            }

            // Meta info
            const metaElement = document.getElementById('details-meta');
            metaElement.innerHTML = `
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    ${location}
                </span>
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"></path>
                    </svg>
                    ${date}
                </span>
            `;

            // Badges
            const badgesElement = document.getElementById('details-badges');
            badgesElement.innerHTML = '';

            // Listing type badge
            let typeBadge = '';
            if (listingType === 'sale') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>SALE</span>';
            } else if (listingType === 'swap') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>SWAP</span>';
            } else if (listingType === 'buy') {
                typeBadge = '<span class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>BUY</span>';
            }
            badgesElement.innerHTML += typeBadge;

            // Category badge
            if (category) {
                let categoryDisplay = '';
                if (subcategory) {
                    if (category === 'electronics') {
                        if (subcategory === 'computers') categoryDisplay = 'Computers';
                        else if (subcategory === 'phones') categoryDisplay = 'Phones';
                        else if (subcategory === 'tablets') categoryDisplay = 'Tablets';
                        else if (subcategory === 'audio_video') categoryDisplay = 'Audio/Video Equipment';
                        else if (subcategory === 'cameras') categoryDisplay = 'Cameras';
                        else categoryDisplay = 'Other Electronics';
                    } else if (category === 'furniture') {
                        if (subcategory === 'office_chairs') categoryDisplay = 'Office Chairs';
                        else if (subcategory === 'desks') categoryDisplay = 'Desks';
                        else if (subcategory === 'cabinets') categoryDisplay = 'Cabinets';
                        else if (subcategory === 'tables') categoryDisplay = 'Tables';
                        else if (subcategory === 'seating') categoryDisplay = 'Seating';
                        else categoryDisplay = 'Other Furniture';
                    } else if (category === 'tools_equipment') {
                        if (subcategory === 'power_tools') categoryDisplay = 'Power Tools';
                        else if (subcategory === 'hand_tools') categoryDisplay = 'Hand Tools';
                        else if (subcategory === 'machinery') categoryDisplay = 'Machinery';
                        else if (subcategory === 'safety_equipment') categoryDisplay = 'Safety Equipment';
                        else if (subcategory === 'measuring_tools') categoryDisplay = 'Measuring Tools';
                        else categoryDisplay = 'Other Tools & Equipment';
                    } else if (category === 'raw_materials') {
                        if (subcategory === 'metals') categoryDisplay = 'Metals';
                        else if (subcategory === 'plastics') categoryDisplay = 'Plastics';
                        else if (subcategory === 'woods') categoryDisplay = 'Woods';
                        else if (subcategory === 'chemicals') categoryDisplay = 'Chemicals';
                        else if (subcategory === 'fabrics') categoryDisplay = 'Fabrics';
                        else categoryDisplay = 'Other Raw Materials';
                    } else if (category === 'services') {
                        if (subcategory === 'consulting') categoryDisplay = 'Consulting';
                        else if (subcategory === 'maintenance') categoryDisplay = 'Maintenance';
                        else if (subcategory === 'installation') categoryDisplay = 'Installation';
                        else if (subcategory === 'training') categoryDisplay = 'Training';
                        else if (subcategory === 'design') categoryDisplay = 'Design';
                        else categoryDisplay = 'Other Services';
                    } else {
                        categoryDisplay = 'Miscellaneous';
                    }
                } else {
                    if (category === 'electronics') categoryDisplay = 'Electronics';
                    else if (category === 'furniture') categoryDisplay = 'Furniture';
                    else if (category === 'tools_equipment') categoryDisplay = 'Tools & Equipment';
                    else if (category === 'raw_materials') categoryDisplay = 'Raw Materials';
                    else if (category === 'services') categoryDisplay = 'Services';
                    else categoryDisplay = 'Other';
                }

                badgesElement.innerHTML += `<span class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">${categoryDisplay}</span>`;
            }

            // Main image
            const mainImageContainer = document.getElementById('details-main-image-container');
            const mainImage = document.getElementById('details-main-image');
            if (images && images.split(',').length > 0) {
                mainImage.src = images.split(',')[0].trim();
                mainImageContainer.style.display = 'block';
            } else {
                mainImage.src = '{% static "thryve_app/images/listing-placeholder.png" %}';
                mainImageContainer.style.display = 'block';
            }

            // Show modal
            document.getElementById('listing-details-modal').classList.remove('hidden');
            document.getElementById('listing-details-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';

            // Store listing ID for gallery button
            document.getElementById('view-gallery-btn').onclick = () => {
                closeListingDetailsModal();
                openImageGallery(listingId);
            };
        }

        function closeListingDetailsModal() {
            document.getElementById('listing-details-modal').classList.add('hidden');
            document.getElementById('listing-details-modal').classList.remove('flex');
            document.body.style.overflow = '';
        }

        // Ensure DOM is loaded before adding event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Close modal event listeners
            document.getElementById('close-details-modal').addEventListener('click', closeListingDetailsModal);
            document.getElementById('listing-details-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('listing-details-modal')) {
                    closeListingDetailsModal();
                }
            });
        });

        // Keyboard navigation for details modal
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('listing-details-modal').classList.contains('flex')) {
                if (e.key === 'Escape') {
                    closeListingDetailsModal();
                }
            }
        });

        // Delete listing modal functions
        function openDeleteListingModal(listingId) {
            currentDeleteListingId = listingId;
            document.getElementById('delete-listing-modal').classList.remove('hidden');
            document.getElementById('delete-listing-modal').classList.add('flex');
        }

        function closeDeleteListingModal() {
            document.getElementById('delete-listing-modal').classList.add('hidden');
            document.getElementById('delete-listing-modal').classList.remove('flex');
            currentDeleteListingId = null;
        }

        // Edit listing modal functions
        function openEditListingModal(listingId) {
            currentEditListingId = listingId;

            // Fetch listing data and populate modal
            fetch(`/listings/edit-listing/${listingId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        populateEditModal(data.listing);
                        document.getElementById('edit-listing-modal').classList.remove('hidden');
                        document.getElementById('edit-listing-modal').classList.add('flex');
                    } else {
                        console.error('Server returned error:', data.error || 'Unknown error');
                        alert(data.error || 'Error loading listing data');
                    }
                })
                .catch(error => {
                    console.error('Error loading listing:', error);
                    alert('Error loading listing data. Please try again.');
                });
        }

        function openBookNowModal(listingId) {
            // For now, just show an alert. This would need to be implemented with a proper booking system
            alert('Booking functionality would need to be implemented with a proper booking system.');
        }

        function submitEditListingForm() {
            const form = document.getElementById('edit-listing-form');
            const formData = new FormData(form);

            // Add image order to form data
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (imagesGrid) {
                const imageIds = Array.from(imagesGrid.children)
                    .filter(child => child.dataset.imageType === 'existing')
                    .map(child => child.dataset.imageId).join(',');
                formData.append('image_order', imageIds);
            }

            // Remove commas from price and budget fields
            const priceInput = document.getElementById('edit_id_price');
            const budgetInput = document.getElementById('edit_id_budget');

            if (priceInput && priceInput.value) {
                formData.set('price', priceInput.value.replace(/,/g, ''));
            }
            if (budgetInput && budgetInput.value) {
                formData.set('budget', budgetInput.value.replace(/,/g, ''));
            }

            // Submit the form
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeEditListingModal();
                        // Reload the page to show updated listing
                        window.location.reload();
                    } else {
                        // Handle errors
                        console.error('Form errors:', data.errors);
                        alert('Error updating listing. Please check your inputs.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating listing.');
                });
        }

        function closeEditListingModal() {
            document.getElementById('edit-listing-modal').classList.add('hidden');
            document.getElementById('edit-listing-modal').classList.remove('flex');
            currentEditListingId = null;
        }

        function populateEditModal(listing) {
            try {
                // Populate form fields
                const listingTypeRadio = document.querySelector(`input[name="listing_type"][value="${listing.listing_type}"]`);
                if (listingTypeRadio) {
                    listingTypeRadio.checked = true;
                }

                // Set category using the edit category selector
                if (editCategorySelector && typeof editCategorySelector.setCategory === 'function') {
                    editCategorySelector.setCategory(listing.category, listing.subcategory);
                }

                const titleInput = document.getElementById('edit_id_title');
                if (titleInput) titleInput.value = listing.title || '';

                const descriptionInput = document.getElementById('edit_id_description');
                if (descriptionInput) descriptionInput.value = listing.description || '';

                // Set dynamic field
                if (listing.listing_type === 'sale' && listing.price) {
                    const priceInput = document.getElementById('edit_id_price');
                    if (priceInput) priceInput.value = listing.price;
                } else if (listing.listing_type === 'swap' && listing.swap_for) {
                    const swapInput = document.getElementById('edit_id_swap_for');
                    if (swapInput) swapInput.value = listing.swap_for;
                } else if (listing.listing_type === 'buy' && listing.budget) {
                    const budgetInput = document.getElementById('edit_id_budget');
                    if (budgetInput) budgetInput.value = listing.budget;
                }

                const locationInput = document.getElementById('edit_id_location');
                if (locationInput) locationInput.value = listing.location || '';

                const dateInput = document.getElementById('edit_id_date');
                if (dateInput) dateInput.value = listing.date || '';

                // Update form action
                const form = document.getElementById('edit-listing-form');
                if (form) form.action = `/listings/edit-listing/${listing.id}/`;

                // Trigger dynamic field update
                if (typeof updateEditDynamicField === 'function') {
                    updateEditDynamicField(listing.listing_type);
                }

                // Initialize edit category selector
                if (editCategorySelector && typeof editCategorySelector.init === 'function') {
                    editCategorySelector.init();
                }

                // Populate current images
                if (typeof populateEditCurrentImages === 'function') {
                    populateEditCurrentImages(listing.images || []);
                }
            } catch (error) {
                console.error('Error populating edit modal:', error);
                alert('Error loading some listing data. Please refresh and try again.');
            }
        }

        // Add event listener for edit modal image input (with null check)
        const editImageInput = document.getElementById('edit_id_images');
        if (editImageInput) {
            editImageInput.addEventListener('change', function (e) {
                const files = Array.from(e.target.files);

                // Add new images to the list
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        editNewImages.push(file);
                    }
                });

                // Update the display
                updateEditImagePreviews();
            });
        }

        function updateEditImagePreviews() {
            const allImagesContainer = document.getElementById('edit-all-images');
            const imagesGrid = document.getElementById('edit-all-images-grid');

            if (!imagesGrid) {
                // Create grid if it doesn't exist
                const newGrid = document.createElement('div');
                newGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4';
                newGrid.id = 'edit-all-images-grid';
                allImagesContainer.appendChild(newGrid);
            }

            const grid = document.getElementById('edit-all-images-grid');

            // Remove only the new image previews (keep existing ones)
            const newImageDivs = grid.querySelectorAll('[data-image-type="new"]');
            newImageDivs.forEach(div => div.remove());

            // Add new image previews
            editNewImages.forEach((file, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'relative group cursor-move';
                imageDiv.dataset.index = editExistingImagesCount + index;
                imageDiv.dataset.imageType = 'new';

                const img = document.createElement('img');
                img.className = 'w-full h-20 object-cover rounded-lg border border-slate-200';
                const url = URL.createObjectURL(file);
                img.src = url;
                img.alt = 'New image';

                // Add remove button
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    editNewImages.splice(index, 1);
                    updateEditImagePreviews();
                };

                imageDiv.appendChild(img);
                imageDiv.appendChild(removeBtn);
                grid.appendChild(imageDiv);
            });

            // Update counter
            const totalImages = editExistingImagesCount + editNewImages.length;
            const remainingSlots = 5 - editExistingImagesCount;
            document.getElementById('edit-image-counter').textContent = `Photos: ${editNewImages.length}/${remainingSlots}`;
        }

        function populateEditCurrentImages(images) {
            const allImagesContainer = document.getElementById('edit-all-images');
            allImagesContainer.innerHTML = '';

            // Reset the edit images state
            editExistingImagesCount = images.length;
            editNewImages = [];

            if (images.length > 0) {
                const imagesGrid = document.createElement('div');
                imagesGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4';
                imagesGrid.id = 'edit-all-images-grid';

                images.forEach((image, index) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative group cursor-move';
                    imageDiv.draggable = true;
                    imageDiv.dataset.index = index;
                    imageDiv.dataset.imageId = image.id;
                    imageDiv.dataset.imageType = 'existing';

                    const img = document.createElement('img');
                    img.src = image.image;
                    img.alt = 'Current listing image';
                    img.className = 'w-full h-20 object-cover rounded-lg border border-slate-200';

                    // Add "MAIN" indicator for main image
                    if (image.is_main) {
                        const mainBadge = document.createElement('div');
                        mainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                        mainBadge.textContent = 'MAIN';
                        imageDiv.appendChild(mainBadge);
                    }

                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeEditImage(image.id);
                    };

                    imageDiv.appendChild(img);
                    imageDiv.appendChild(removeBtn);
                    imagesGrid.appendChild(imageDiv);
                });

                allImagesContainer.appendChild(imagesGrid);

                // Add reorder instructions
                const reorderInstructions = document.createElement('div');
                reorderInstructions.className = 'text-xs text-slate-500 text-center mb-4';
                reorderInstructions.textContent = 'Drag to reorder • First image becomes the main photo';
                allImagesContainer.appendChild(reorderInstructions);

                // Initialize drag and drop for all images
                initializeEditImageDragDrop();

                // Update counter to reflect current images
                const remainingSlots = 5 - images.length;
                document.getElementById('edit-image-counter').textContent = `Photos: 0/${remainingSlots}`;
            } else {
                document.getElementById('edit-image-counter').textContent = 'Photos: 0/5';
            }
        }

        function initializeEditImageDragDrop() {
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (!imagesGrid) return;

            let draggedElement = null;

            imagesGrid.addEventListener('dragstart', function (e) {
                if (e.target.closest('.cursor-move')) {
                    draggedElement = e.target.closest('.cursor-move');
                    draggedElement.classList.add('opacity-50');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            imagesGrid.addEventListener('dragend', function (e) {
                if (draggedElement) {
                    draggedElement.classList.remove('opacity-50');
                    draggedElement = null;

                    // Clear all drag over styling
                    imagesGrid.querySelectorAll('.cursor-move').forEach(div => {
                        div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                    });
                }
            });

            imagesGrid.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const target = e.target.closest('.cursor-move');
                if (target && target !== draggedElement) {
                    // Clear feedback from all except the dragged element
                    imagesGrid.querySelectorAll('.cursor-move:not(.opacity-50)').forEach(div => {
                        div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                    });

                    // Add visual indicator to the element you are hovering over
                    target.classList.add('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                }
            });

            imagesGrid.addEventListener('drop', function (e) {
                e.preventDefault();

                const dropTarget = e.target.closest('.cursor-move');
                if (!dropTarget || dropTarget === draggedElement) return;

                // Remove the dragged element from its current position
                const draggedParent = draggedElement.parentNode;
                if (draggedParent) {
                    draggedParent.removeChild(draggedElement);
                }

                // Get all remaining elements to determine insertion point
                const allElements = Array.from(imagesGrid.children);
                const targetIndex = allElements.indexOf(dropTarget);

                // Determine if we should insert before or after the target
                const rect = dropTarget.getBoundingClientRect();
                const dropX = e.clientX;

                if (dropX < rect.left + rect.width / 2) {
                    // Insert before target
                    imagesGrid.insertBefore(draggedElement, dropTarget);
                } else {
                    // Insert after target
                    imagesGrid.insertBefore(draggedElement, dropTarget.nextSibling);
                }

                // Update indices and main image indicators
                updateEditImageOrder();

                // Clear drag styling
                imagesGrid.querySelectorAll('.cursor-move').forEach(div => {
                    div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
                });
            });
        }

        function updateEditImageOrder() {
            const imagesGrid = document.getElementById('edit-all-images-grid');
            if (!imagesGrid) return;

            const imageElements = imagesGrid.querySelectorAll('.cursor-move');

            imageElements.forEach((element, index) => {
                element.dataset.index = index;

                // Update main image indicator
                const mainBadge = element.querySelector('.bg-brand-leaf');
                if (index === 0) {
                    if (!mainBadge) {
                        const newMainBadge = document.createElement('div');
                        newMainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                        newMainBadge.textContent = 'MAIN';
                        element.insertBefore(newMainBadge, element.firstChild);
                    }
                } else {
                    if (mainBadge) {
                        mainBadge.remove();
                    }
                }
            });
        }

        function removeEditImage(imageId) {
            if (confirm('Are you sure you want to remove this image?')) {
                // This would need a separate view/URL for removing images
                // For now, just show an alert
                alert('Image removal functionality would need to be implemented with a separate endpoint.');
            }
        }


        function updateEditDynamicField(selectedType) {
            const priceContainer = document.getElementById('edit-price-container');
            const swapContainer = document.getElementById('edit-swap-container');
            const budgetContainer = document.getElementById('edit-budget-container');
            const label = document.getElementById('edit-dynamic-field-label');

            priceContainer.classList.add('hidden');
            swapContainer.classList.add('hidden');
            budgetContainer.classList.add('hidden');

            if (selectedType === 'sale') {
                priceContainer.classList.remove('hidden');
                label.textContent = 'Price *';
            } else if (selectedType === 'swap') {
                swapContainer.classList.remove('hidden');
                label.textContent = 'Looking to Swap For *';
            } else if (selectedType === 'buy') {
                budgetContainer.classList.remove('hidden');
                label.textContent = 'Budget *';
            }
        }

        // Initialize Quill Rich Text Editor (Add Listing) only if present
        const addEditorEl = document.querySelector('#description-editor-content');
        let quill;
        if (addEditorEl) {
            quill = new Quill('#description-editor-content', {
                theme: 'snow',
                placeholder: 'Describe your item or service',
                modules: {
                    toolbar: '#description-toolbar'
                }
            });

            // Sync Quill content to hidden input
            quill.on('text-change', function () {
                const html = quill.root.innerHTML;
                const hidden = document.getElementById('id_description');
                if (hidden) hidden.value = html;
            });
        }

        // Edit modal description now uses a simple textarea (no Quill needed)

        // Function to format number with commas
        function formatNumberWithCommas(value) {
            // Remove any existing commas and non-numeric characters except decimal point
            const numericValue = value.replace(/[^\d.]/g, '');
            // Split into integer and decimal parts
            const parts = numericValue.split('.');
            // Add commas to integer part
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            // Rejoin with decimal part if it exists
            return parts.join('.');
        }

        // Function to handle price input formatting
        function handlePriceInput(event) {
            const input = event.target;
            const cursorPosition = input.selectionStart;
            const originalValue = input.value;

            // Format the value
            const formattedValue = formatNumberWithCommas(originalValue);

            // Only update if the value changed
            if (formattedValue !== originalValue) {
                input.value = formattedValue;

                // Adjust cursor position to account for added commas
                const commaCountDiff = (formattedValue.match(/,/g) || []).length - (originalValue.match(/,/g) || []).length;
                input.setSelectionRange(cursorPosition + commaCountDiff, cursorPosition + commaCountDiff);
            }
        }

        // Add event listeners to price and budget inputs
        const priceInput = document.getElementById('id_price');
        const budgetInput = document.getElementById('id_budget');

        if (priceInput) {
            priceInput.addEventListener('input', handlePriceInput);
        }

        if (budgetInput) {
            budgetInput.addEventListener('input', handlePriceInput);
        }

        // Sync Quill content to hidden input
        quill.on('text-change', function () {
            const html = quill.root.innerHTML;
            document.getElementById('id_description').value = html;
            clearFieldError('description');
        });

        // Apply custom styling to match Thryve theme
        const style = document.createElement('style');
        style.textContent = `
            /* --- Base Quill Overrides (No changes needed for animation) --- */
            .ql-toolbar.ql-snow { border: none; padding: 0; background-color: transparent; border-radius: 0; }
            .ql-container.ql-snow { border: none; }
            .ql-snow .ql-toolbar:after { content: none; }
            .ql-snow .ql-toolbar button { padding: 6px 8px; border-radius: 0.25rem; border: none; background: transparent; transition: background-color 0.15s; min-height: 36px; }
            .ql-snow .ql-toolbar button svg { width: 24px; height: 24px; transform: none; }
            .ql-snow .ql-toolbar button:hover, .ql-snow .ql-toolbar button:focus { background-color: #e2e8f0 !important; color: #1e293b; }
            .ql-snow .ql-toolbar button.ql-active { background-color: #83e6f5 !important; color: #0f172a !important; }
            .ql-snow .ql-editor { font-size: 16px; line-height: 1.5; }
            .ql-snow .ql-editor ul, .ql-snow .ql-editor ol { padding-left: 1.5em; }
            .ql-snow .ql-editor.ql-blank::before { color: #94a3b8 !important; left: 0.75rem !important; padding-left: 0 !important; font-style: normal; font-size: 16px; }
            .ql-container .ql-editor { padding: 0; }
            .ql-editor strong, .ql-editor b { font-weight: 800; }
            .ql-editor em, .ql-editor i { font-style: italic; }
            .ql-editor a { color: #3b82f6; text-decoration: underline; }
            .suggestions-dropdown { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
            .suggestions-dropdown::-webkit-scrollbar { width: 6px; }
            .suggestions-dropdown::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 0 0 8px 0; }
            .suggestions-dropdown::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
            .suggestions-dropdown::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

            /* List styling for description display */
            #details-description ul, #details-description ol {
                padding-left: 1.5rem;
                margin: 0.5rem 0;
            }
            #details-description li {
                margin: 0.25rem 0;
                line-height: 1.4;
            }
            #details-description ul {
                list-style-type: disc;
            }
            #details-description ol {
                list-style-type: decimal;
            }
            #details-description strong, #details-description b {
                font-weight: 700;
            }
            #details-description em, #details-description i {
                font-style: italic;
            }

            /* List styling for card previews */
            .description-preview ul, .description-preview ol {
                padding-left: 1rem;
                margin: 0.25rem 0;
            }
            .description-preview li {
                margin: 0.125rem 0;
                line-height: 1.3;
            }
            .description-preview ul {
                list-style-type: disc;
            }
            .description-preview ol {
                list-style-type: decimal;
            }
            .description-preview strong, .description-preview b {
                font-weight: 600;
            }
            .description-preview em, .description-preview i {
                font-style: italic;
            }

            /* --- ENHANCED ANIMATION CONTAINERS --- */

            /* Title scrolling animation */
            .title-scroll-container {
                width: 100%;
                overflow: hidden;
                position: relative;
                max-width: 100%; /* Prevent container from expanding */
            }

            .title-spacer {
                margin-left: 2rem;
            }

            .title-scroll-text {
                display: inline-flex;
                width: max-content;
                transition: transform 0.5s ease-out;
                transform: translateX(0);
                -webkit-transform: translateX(0);
            }

            /* Trigger animation on parent article hover */
            article:hover .title-scroll-text {
                animation: scroll-left-title 8s linear infinite;
                -webkit-animation: scroll-left-title 8s linear infinite;
                animation-delay: 1s;
                -webkit-animation-delay: 1s;
            }

            /* Location scrolling animation */
            .location-scroll-container {
                width: 100%;
                overflow: hidden;
                position: relative;
                display: inline-block;
                max-width: 100%; /* Prevent container from expanding */
            }

            .location-spacer {
                margin-left: 3rem;
            }

            .location-scroll-text {
                display: inline-flex;
                width: max-content;
                transition: transform 0.5s ease-out;
                transform: translateX(0);
                -webkit-transform: translateX(0);
            }

            /* Trigger animation on parent article hover */
            article:hover .location-scroll-text {
                animation: scroll-left-location 15s linear infinite;
                -webkit-animation: scroll-left-location 15s linear infinite;
                animation-delay: 1s;
                -webkit-animation-delay: 1s;
            }

            /* Keyframes remain the same */
            @keyframes scroll-left-location {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1.5rem)); }
            }

            @-webkit-keyframes scroll-left-location {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1.5rem)); }
            }

            @keyframes scroll-left-title {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-title {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }

            /* Looking-for scrolling animation (handled in base <style> with JS-controlled duration) */

            /* CRITICAL FIX: Force containers to not expand beyond parent */
            article .title-scroll-container,
            article .location-scroll-container {
                max-width: 100%;
                overflow: hidden;
            }

            /* Ensure parent containers have proper width constraints */
            article h3,
            article .text-lg.font-bold {
                max-width: 100%;
            }

            article .flex.items-center.gap-1.max-w-\[60\%\] {
                overflow: hidden;
            }

            /* Separate keyframes for each animation type (CRITICAL: Needs prefixes) */
            @keyframes scroll-left-location {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1.5rem)); }
            }

            @-webkit-keyframes scroll-left-location {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1.5rem)); }
            }

            @keyframes scroll-left-title {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-title {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }

            @keyframes scroll-left-description {
                0% { transform: translateX(0); }
                100% { transform: translateX(calc(-50% - 1rem)); }
            }

            @-webkit-keyframes scroll-left-description {
                0% { -webkit-transform: translateX(0); }
                100% { -webkit-transform: translateX(calc(-50% - 1rem)); }
            }
        `;
        document.head.appendChild(style);

        // Real-time validation - clear errors when user starts typing
        function setupRealTimeValidation() {
            const allInputs = form.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                if (input.id !== 'id_category') { // Skip our custom category input
                    input.addEventListener('input', (e) => {
                        const fieldName = e.target.id.replace('id_', '');
                        clearFieldError(fieldName);
                    });
                }
            });
        }

        // Clear error for a specific field
        function clearFieldError(fieldName) {
            let fieldContainer;

            if (fieldName === 'listing_type') {
                fieldContainer = form.querySelector('.space-y-2').parentElement;
            } else if (fieldName === 'price' || fieldName === 'swap_for' || fieldName === 'budget') {
                fieldContainer = document.getElementById('dynamic-field-container');
            } else {
                const field = form.querySelector(`#id_${fieldName}`);
                if (field) {
                    fieldContainer = field.closest('.mb-4') || field.closest('.mb-6');
                }
            }

            if (fieldContainer) {
                const errorMsg = fieldContainer.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }

                // Remove red border
                const field = form.querySelector(`#id_${fieldName}`);
                if (field) {
                    field.classList.remove('border-red-500');
                }
            }
        }

        // Form validation on submit
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Always prevent default first

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            let hasErrors = false;

            // Check listing type
            const listingType = form.querySelector('input[name="listing_type"]:checked');
            if (!listingType) {
                showError('listing_type', 'Please select a listing type');
                hasErrors = true;
            }

            // Check category
            const category = form.querySelector('#id_category');
            if (!category || !category.value || category.value === '') {
                showError('category', 'Please select a category');
                hasErrors = true;
            }

            // Check required text fields
            const requiredFields = ['title', 'description', 'location'];
            requiredFields.forEach(field => {
                const input = form.querySelector(`#id_${field}`);
                if (!input.value.trim()) {
                    showError(field, `Please enter ${field.replace('_', ' ')}`);
                    hasErrors = true;
                }
            });

            // Check the dynamic field based on listing type
            const selectedType = form.querySelector('input[name="listing_type"]:checked');
            if (selectedType) {
                if (selectedType.value === 'sale') {
                    const priceInput = form.querySelector('#id_price');
                    const priceValue = parseFloat(priceInput.value.replace(/,/g, ''));
                    if (!priceInput.value.trim()) {
                        showError('price', 'Please enter price');
                        hasErrors = true;
                    } else if (priceValue <= 0) {
                        showError('price', 'Price must be greater than 0');
                        hasErrors = true;
                    }
                } else if (selectedType.value === 'swap') {
                    const swapInput = form.querySelector('#id_swap_for');
                    if (!swapInput.value.trim()) {
                        showError('swap_for', 'Please enter what you are looking to swap for');
                        hasErrors = true;
                    }
                } else if (selectedType.value === 'buy') {
                    const budgetInput = form.querySelector('#id_budget');
                    const budgetValue = parseFloat(budgetInput.value.replace(/,/g, ''));
                    if (!budgetInput.value.trim()) {
                        showError('budget', 'Please enter budget');
                        hasErrors = true;
                    } else if (budgetValue <= 0) {
                        showError('budget', 'Budget must be greater than 0');
                        hasErrors = true;
                    }
                }
            } else {
                // If no listing type is selected, default to checking price (since For Sale is default)
                const priceInput = form.querySelector('#id_price');
                const priceValue = parseFloat(priceInput.value.replace(/,/g, ''));
                if (!priceInput.value.trim()) {
                    showError('price', 'Please enter price');
                    hasErrors = true;
                } else if (priceValue <= 0) {
                    showError('price', 'Price must be greater than 0');
                    hasErrors = true;
                }
            }

            if (!hasErrors) {
                // Submit the form via AJAX instead of normal submission
                submitFormViaAjax();
            }
        });

        // Initialize real-time validation
        setupRealTimeValidation();

        // Function to submit form via AJAX
        function submitFormViaAjax() {
            const formData = new FormData(form);

            // Remove commas from price and budget fields before submission
            const priceInput = document.getElementById('id_price');
            const budgetInput = document.getElementById('id_budget');

            if (priceInput && priceInput.value) {
                formData.set('price', priceInput.value.replace(/,/g, ''));
            }
            if (budgetInput && budgetInput.value) {
                formData.set('budget', budgetInput.value.replace(/,/g, ''));
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Success: close modal and redirect to home page immediately
                        closeModal();
                        // Use replace to avoid adding to browser history
                        window.location.replace('/home/');
                    } else {
                        // Error: show form errors
                        showFormErrors(data.errors);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('general', 'An error occurred. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Listing';
                });
        }

        // Function to refresh listings section (no longer needed)
        function refreshListings() {
            // This function is no longer used since we redirect instead
        }

        // Function to show success message (no longer needed)
        function showSuccessMessage(message) {
            // This function is no longer used since we redirect instead
        }

        // Function to show form errors from AJAX response
        function showFormErrors(errors) {
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            // Show new errors
            for (const [field, messages] of Object.entries(errors)) {
                if (Array.isArray(messages)) {
                    messages.forEach(message => {
                        showError(field, message);
                    });
                } else {
                    showError(field, messages);
                }
            }
        }

        // Initialize drag-and-drop image upload
        const uploadArea = document.getElementById('upload-area');
        const imageInput = document.getElementById('id_images');
        const imageCounter = document.getElementById('image-counter');
        const imagePreviews = document.getElementById('image-previews');
        const reorderInstructions = document.getElementById('reorder-instructions');
        let selectedFiles = [];
        let draggedElement = null;

        // Add this new event listener
        // This prevents the browser from loading the dropped file directly in the window,
        // which is what causes the screen to go blank/images to vanish.
        document.addEventListener('drop', function (e) {
            e.preventDefault();
        }, false);

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('border-brand-sky', 'bg-brand-sky/5');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('border-brand-sky', 'bg-brand-sky/5');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // File input change
        imageInput.addEventListener('change', function (e) {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            // Convert FileList to Array and filter for images
            const imageFiles = Array.from(files).filter(file => {
                return file.type.startsWith('image/') &&
                    ['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type);
            });

            // Add new files to selectedFiles, avoiding duplicates
            imageFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            // Limit to 5 files
            if (selectedFiles.length > 5) {
                selectedFiles = selectedFiles.slice(0, 5);
            }

            updateImageDisplay();
        }

        function updateImageDisplay() {
            // Update counter
            const count = selectedFiles.length;
            imageCounter.textContent = `Photos: ${count}/5`;

            // Change color if over limit
            if (count > 5) {
                imageCounter.classList.add('text-red-500');
                imageCounter.classList.remove('text-slate-600');
            } else {
                imageCounter.classList.remove('text-red-500');
                imageCounter.classList.add('text-slate-600');
            }

            // Update upload area state when max reached
            if (count >= 5) {
                // Disable upload area
                uploadArea.classList.add('opacity-50', 'cursor-not-allowed');
                uploadArea.classList.remove('hover:border-brand-sky', 'hover:bg-slate-100/50', 'cursor-pointer');

                // Update text and icon
                const uploadText = document.getElementById('upload-text');
                const uploadIcon = document.getElementById('upload-icon');
                uploadText.innerHTML = `
                    <p class="text-lg font-medium text-slate-500">You have reached the maximum of 5 photos.</p>
                    <p class="text-sm text-slate-400">Delete a photo below to upload a new one.</p>
                `;
                uploadIcon.classList.add('text-slate-400');
                uploadIcon.classList.remove('text-slate-400'); // Keep it gray

                // Disable file input
                imageInput.disabled = true;
            } else {
                // Re-enable upload area
                uploadArea.classList.remove('opacity-50', 'cursor-not-allowed');
                uploadArea.classList.add('hover:border-brand-sky', 'hover:bg-slate-100/50', 'cursor-pointer');

                // Reset text and icon
                const uploadText = document.getElementById('upload-text');
                const uploadIcon = document.getElementById('upload-icon');
                uploadText.innerHTML = `
                    <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                    <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                `;
                uploadIcon.classList.remove('text-slate-400');
                uploadIcon.classList.add('text-slate-400');

                // Re-enable file input
                imageInput.disabled = false;
            }

            // Clear existing previews
            imagePreviews.innerHTML = '';

            // Create thumbnails
            selectedFiles.forEach((file, index) => {
                const thumbnail = createThumbnail(file, index);
                imagePreviews.appendChild(thumbnail);
            });

            // Show/hide reorder instructions
            if (selectedFiles.length > 1) {
                reorderInstructions.classList.remove('hidden');
            } else {
                reorderInstructions.classList.add('hidden');
            }

            // Update the actual file input with selected files
            updateFileInput();
        }

        function createThumbnail(file, index) {
            const div = document.createElement('div');
            div.className = 'relative group cursor-move';
            div.draggable = true;
            div.dataset.index = index;

            const img = document.createElement('img');
            img.className = 'w-full h-20 object-cover rounded-lg border border-slate-200';

            // Create object URL for preview
            const url = URL.createObjectURL(file);
            img.src = url;

            // Add "MAIN" indicator for first image
            if (index === 0) {
                const mainBadge = document.createElement('div');
                mainBadge.className = 'absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded';
                mainBadge.textContent = 'MAIN';
                div.appendChild(mainBadge);
            }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeImage(index);
            };

            div.appendChild(img);
            div.appendChild(removeBtn);

            // Add drag event listeners
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDropOnThumbnail);

            return div;
        }

        function removeImage(index) {
            selectedFiles.splice(index, 1);
            updateImageDisplay();
        }

        function updateFileInput() {
            // Create a new DataTransfer object to update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
        }

        // --- Start of CORRECTED DRAG & DROP REORDERING SECTION ---

        // Utility function to determine the closest element to drop AFTER
        function getDropAfterElement(container, clientX, clientY, draggedElement) {
            // Get all valid drop targets (thumbnails that aren't the one currently dragging)
            const draggableElements = [...container.querySelectorAll('.cursor-move:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();

                // Calculate the difference from the center line of the child element.
                // We use the center of the child element to define the drop zone boundary.
                const center_x = box.left + box.width / 2;
                const center_y = box.top + box.height / 2;

                // Calculate offset in both dimensions
                // Offset Y is the most important for multi-row grids
                const offset_y = clientY - center_y;

                // Only consider elements that are in the right direction (above/left of the drop point)
                if (offset_y < 0) {
                    // The drop is above the center of this element (valid place to insert before)
                    if (offset_y > closest.offset_y) {
                        return { offset_y: offset_y, element: child };
                    }
                } else if (offset_y >= 0 && clientX < center_x) {
                    // Drop is on the same row, to the left of the center, or past the last element on the row
                    // We rely more on Y, but X provides tie-breaking on the same row.
                    // This logic is complex in a dynamic grid, so we simplify to finding the closest "preceding" element.
                }

                return closest;
            }, { offset_y: Number.NEGATIVE_INFINITY, element: null }).element;
        }


        // Drag and drop reordering functions
        function handleDragStart(e) {
            // Store the original index of the file being dragged
            e.dataTransfer.setData('text/plain', e.currentTarget.dataset.index);
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('opacity-50', 'dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('opacity-50', 'dragging');
            draggedElement = null;

            // Clear all drag over styling
            document.querySelectorAll('#image-previews > div').forEach(div => {
                div.classList.remove('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const target = e.currentTarget;

            // Clear feedback from all except the dragged element
            document.querySelectorAll('#image-previews > div:not(.dragging)').forEach(div => {
                div.classList.remove('border-2', 'border-brand-sky', 'bg-brand-sky/10');
            });

            // Add visual indicator to the element you are hovering over
            if (target && target !== draggedElement) {
                target.classList.add('shadow-lg', 'shadow-brand-sky/50', 'bg-brand-sky/5', 'scale-90');
            }
        }


        function handleDropOnThumbnail(e) {
            e.preventDefault();
            e.stopPropagation();

            // The element that received the drop
            const dropTarget = e.currentTarget;

            // 1. Get initial indices and data
            const draggedFileOriginalIndex = parseInt(e.dataTransfer.getData('text/plain'));

            // Safety check for dropping on self or invalid file
            if (isNaN(draggedFileOriginalIndex) || draggedFileOriginalIndex < 0 || dropTarget === draggedElement) {
                handleDragEnd(e);
                return false;
            }

            const draggedFile = selectedFiles[draggedFileOriginalIndex];

            // Get the index of the target element in the CURRENT DOM NodeList
            // This correctly gives the visual position (0, 1, 2, 3...)
            const thumbnails = Array.from(imagePreviews.children);
            let targetVisualIndex = thumbnails.indexOf(dropTarget);

            // 2. Calculate Insertion Point
            let newInsertIndex = targetVisualIndex;

            // Use drop position to determine if we should insert BEFORE or AFTER the target thumbnail
            const rect = dropTarget.getBoundingClientRect();
            const dropX = e.clientX;

            // If dropped on the right half of the target, insert AFTER (targetVisualIndex + 1)
            if (dropX > rect.left + rect.width / 2) {
                newInsertIndex++;
            }

            // 3. Reorder the array using a more reliable approach

            // Create a new array without the dragged item
            const remainingFiles = selectedFiles.filter((_, index) => index !== draggedFileOriginalIndex);

            // Insert the dragged file at the new position
            remainingFiles.splice(newInsertIndex, 0, draggedFile);

            // Update the selectedFiles array
            selectedFiles.length = 0;
            selectedFiles.push(...remainingFiles);

            // 4. Re-render and cleanup
            updateImageDisplay();
            handleDragEnd(e);

            return false;
        }

        // --- End of CORRECTED DRAG & DROP REORDERING SECTION ---


        function showError(fieldName, message) {
            let field;
            let fieldContainer;

            if (fieldName === 'listing_type') {
                // For radio buttons, find the container div
                fieldContainer = form.querySelector('.space-y-2').parentElement;
                field = form.querySelector('input[name="listing_type"]'); // Just get first radio for styling
            } else if (fieldName === 'price' || fieldName === 'swap_for' || fieldName === 'budget') {
                // For dynamic fields, use the dynamic field container
                fieldContainer = document.getElementById('dynamic-field-container');
                field = form.querySelector(`#id_${fieldName}`);
            } else {
                field = form.querySelector(`#id_${fieldName}`);
                fieldContainer = field.closest('.mb-4') || field.closest('.mb-6');
            }

            // Remove existing error for this field
            const existingError = fieldContainer.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Add error message
            const errorDiv = document.createElement('p');
            errorDiv.className = 'error-message text-red-500 text-sm mt-1';
            errorDiv.textContent = message;
            fieldContainer.appendChild(errorDiv);

            // Add red border to field (skip for radio buttons)
            if (field && fieldName !== 'listing_type') {
                field.classList.add('border-red-500');
                setTimeout(() => field.classList.remove('border-red-500'), 3000);
            }
        }
        // No JS needed for marquees now; title, location, and looking-for
        // all scroll purely via CSS when rendered with their marquee markup.
    </script>

    {% include 'accounts/logout_modal.html' %}
</body>

</html>