{% extends 'thryve_app/base.html' %}
{% load static %}

{% block title %}Edit Listing - Thryve{% endblock %}

{% block extra_head %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        white-space: normal !important;
        min-height: 120px;
    }

    .ql-editor ol,
    .ql-editor ul {
        padding-left: 1.5em !important;
        margin: 0.5em 0 !important;
    }

    .ql-editor li {
        list-style-type: inherit !important;
    }

    .ql-editor ul>li {
        list-style-type: disc !important;
    }

    .ql-editor ol>li {
        list-style-type: decimal !important;
    }

    .ql-editor p {
        margin: 0.5em 0;
    }

    .ql-container {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Fallback include if base doesn't render extra_head -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<div class="max-w-4xl mx-auto px-5 py-8">
    <div class="mb-6">
        <a href="{% url 'marketplace:my_listings' %}"
            class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-800 transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to My Listings
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-soft border border-slate-100 p-8">
        <h1 class="text-3xl font-bold text-slate-900 mb-8">Edit Listing</h1>

        <form id="edit-listing-form" method="post" action="{% url 'marketplace:edit_listing' listing.id %}"
            enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Listing Type -->
                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                    <div class="space-y-2">
                        {% for lt in listing_types %}
                        <label class="flex items-center">
                            <input type="radio" name="listing_type" value="{{ lt.value }}"
                                class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == lt.value %}checked{% endif %} required>
                            <span class="ml-2 text-slate-700">{{ lt.label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Category -->
                <div>
                    <label for="id_category" class="block text-slate-700 font-semibold mb-2">Category *</label>
                    <div class="relative">
                        <input type="hidden" name="category" id="id_category" value="{{ category_value }}">
                        <div id="category-selector-trigger"
                            class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                            <span id="category-display-text" class="text-slate-900">{{ category_value|default:'Choose Category' }}</span>
                            <span class="text-slate-400">▾</span>
                        </div>

                        <div id="category-selector"
                            class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                            <div class="flex">
                                <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                    <div class="p-2">
                                        <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES</div>
                                        <div id="main-categories" class="space-y-1">
                                            {% for key, data in categories.items %}
                                            <button type="button"
                                                class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn {% if listing.category == key %}bg-brand-sky text-white{% endif %}"
                                                data-category="{{ key }}">{{ data.label }}</button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <div class="w-1/2 max-h-64 overflow-y-auto">
                                    <div class="p-2">
                                        <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES</div>
                                        <div id="subcategories" class="space-y-1">
                                            <!-- Subcategories will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div class="mb-6">
                <label for="{{ form.title.id_for_label }}" class="block text-slate-700 font-semibold mb-2">Title
                    *</label>
                {{ form.title }}
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label for="{{ form.description.id_for_label }}"
                    class="block text-slate-700 font-semibold mb-2">Description *</label>
                <div id="description-editor"
                    class="rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-brand-sky">
                    <div id="description-toolbar" class="bg-gray-50 border-b border-slate-200 p-1 rounded-t-lg">
                        <button type="button" class="ql-bold text-slate-700 hover:text-slate-900 px-2 py-1 rounded"
                            title="Bold"></button>
                        <button type="button" class="ql-italic text-slate-700 hover:text-slate-900 px-2 py-1 rounded"
                            title="Italicize"></button>
                        <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded"
                            value="bullet" title="Bullet List"></button>
                        <button type="button" class="ql-list text-slate-700 hover:text-slate-900 px-2 py-1 rounded"
                            value="ordered" title="Numbered List"></button>
                        <button type="button" class="ql-link text-slate-700 hover:text-slate-900 px-2 py-1 rounded"
                            title="Link"></button>
                    </div>
                    <div id="description-editor-content" class="min-h-[120px] p-3 font-medium text-slate-900"
                        style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;">
                    </div>
                </div>
                <input type="hidden" name="description" id="id_description" value="{{ listing.description|safe }}">
            </div>

            <!-- Dynamic Field -->
            <div class="mb-6" id="dynamic-field-container">
                <label id="dynamic-field-label" for="id_price" class="block text-slate-700 font-semibold mb-2">
                    {% if listing.listing_type == 'sale' %}Price *{% elif listing.listing_type == 'swap' %}Looking to
                    Swap For *{% elif listing.listing_type == 'buy' %}Budget *{% endif %}
                </label>
                <div class="relative {% if listing.listing_type != 'sale' %}hidden{% endif %}" id="price-container">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                    <input type="text" name="price"
                        class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                        placeholder="0.00" id="id_price" value="{% if listing.price %}{{ listing.price }}{% endif %}">
                </div>
                <div id="swap-container"
                    class="{% if listing.listing_type == 'swap' %}block{% else %}hidden{% endif %}">
                    <input type="text" name="swap_for"
                        class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                        placeholder="What are you looking to swap for?" id="id_swap_for"
                        value="{% if listing.swap_for %}{{ listing.swap_for }}{% endif %}">
                </div>
                <div class="relative {% if listing.listing_type != 'buy' %}hidden{% endif %}" id="budget-container">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                    <input type="text" name="budget"
                        class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                        placeholder="0.00" id="id_budget"
                        value="{% if listing.budget %}{{ listing.budget }}{% endif %}">
                </div>
            </div>

            <!-- Location -->
            <div class="mb-6">
                <label for="id_location" class="block text-slate-700 font-semibold mb-2">Location *</label>
                <div class="relative">
                    <input type="text" name="location" id="id_location"
                        class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                        placeholder="City, State/Country" value="{{ listing.location }}">
                </div>
            </div>

            <!-- Current Images -->
            {% if listing.images.all %}
            <div class="mb-6">
                <label class="block text-slate-700 font-semibold mb-2">Current Images</label>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    {% for image in listing.images.all %}
                    <div class="relative group">
                        <img src="{{ image.image.url }}" alt="Listing image"
                            class="w-full h-20 object-cover rounded-lg border border-slate-200">
                        {% if image.is_main %}
                        <div
                            class="absolute top-1 left-1 bg-brand-leaf text-white text-xs font-bold px-1.5 py-0.5 rounded">
                            MAIN</div>
                        {% endif %}
                        <button type="button"
                            class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 z-10"
                            onclick="removeImage({{ image.id }})" title="Remove image">&times;</button>
                    </div>
                    {% endfor %}
                </div>
                <p class="text-sm text-slate-500 mt-2">You can add up to {{ 5|add:listing.images.count }} more images.
                </p>
            </div>
            {% endif %}

            <!-- Add More Images -->
            <div class="mb-6">
                <label for="id_images" class="block text-slate-700 font-semibold mb-2">Add More Images</label>
                <div id="upload-area"
                    class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <div id="upload-icon" class="w-12 h-12 text-slate-400">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                </path>
                            </svg>
                        </div>
                        <div id="upload-text">
                            <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                            <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to
                                    browse</span></p>
                        </div>
                        <div id="image-counter" class="text-sm font-medium text-slate-600">
                            Photos: 0/{{ 5|add:listing.images.count }}
                        </div>
                    </div>
                    <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp" id="id_images"
                        multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                </div>

                <div class="mt-2 text-sm text-slate-500">
                    <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                </div>

                <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                <div id="reorder-instructions" class="mt-2 text-xs text-slate-500 text-center hidden">Drag thumbnails to
                    reorder • First image becomes the main photo</div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end gap-3">
                <a href="{% url 'marketplace:my_listings' %}"
                    class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</a>
                <button type="submit" id="submit-btn"
                    class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update
                    Listing</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Include the same JavaScript from home.html for category selector, form validation, etc.
    // For brevity, I'll include the essential parts

    // Category selector functionality (same as in home.html)
    const categorySelector = {
        trigger: document.getElementById('category-selector-trigger'),
        selector: document.getElementById('category-selector'),
        displayText: document.getElementById('category-display-text'),
        hiddenInput: document.getElementById('id_category'),
        mainCategories: document.getElementById('main-categories'),
        subcategories: document.getElementById('subcategories'),
        activeCategory: '{{ listing.category }}',
        selectedSubcategory: '{{ listing.subcategory }}',

        subcategoriesData: {
            {% for key, data in categories.items %}
    '{{ key }}': [
        {% for sub in data.subcategories %}
    { value: '{{ sub.value }}', label: '{{ sub.label }}' } {% if not forloop.last %}, {% endif %}
    {% endfor %}
            ]{% if not forloop.last %}, {% endif %}
    {% endfor %}
        },

    init() {
        this.setupEventListeners();
        this.setInitialState();
    },

    setupEventListeners() {
        this.trigger.addEventListener('click', () => {
            this.toggleSelector();
        });

        document.addEventListener('click', (e) => {
            if (!this.trigger.contains(e.target) && !this.selector.contains(e.target)) {
                this.closeSelector();
            }
        });

        this.mainCategories.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                const category = e.target.dataset.category;
                this.selectCategory(category);
            }
        });

        this.subcategories.addEventListener('click', (e) => {
            if (e.target.classList.contains('subcategory-btn')) {
                const value = e.target.dataset.value;
                const label = e.target.textContent;
                this.selectSubcategory(value, label);
            }
        });
    },

    setInitialState() {
        if (this.activeCategory) {
            this.selectCategory(this.activeCategory);
            if (this.selectedSubcategory) {
                const subcategoryValue = `${this.activeCategory}-${this.selectedSubcategory}`;
                this.hiddenInput.value = subcategoryValue;
                this.displayText.textContent = this.getSubcategoryLabel(this.selectedSubcategory);
            }
        }
    },

    getSubcategoryLabel(subcategory) {
        const subs = this.subcategoriesData[this.activeCategory] || [];
        const sub = subs.find(s => s.value === subcategory);
        return sub ? sub.label : subcategory;
    },

    selectCategory(category) {
        this.mainCategories.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('bg-brand-sky', 'text-white');
            btn.classList.add('hover:bg-brand-sky/10');
        });

        const activeBtn = this.mainCategories.querySelector(`[data-category="${category}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-brand-sky', 'text-white');
            activeBtn.classList.remove('hover:bg-brand-sky/10');
        }

        this.activeCategory = category;
        this.updateSubcategories(category);
    },

    updateSubcategories(category) {
        this.subcategories.innerHTML = '';
        const subs = this.subcategoriesData[category] || [];

        subs.forEach(sub => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded subcategory-btn';
            btn.dataset.value = `${category}-${sub.value}`;
            btn.textContent = sub.label;

            if (this.selectedSubcategory === sub.value && this.activeCategory === category) {
                btn.classList.add('bg-brand-leaf', 'text-white');
                btn.classList.remove('hover:bg-brand-sky/10');
            }

            this.subcategories.appendChild(btn);
        });
    },

    selectSubcategory(value, label) {
        this.subcategories.querySelectorAll('.subcategory-btn').forEach(btn => {
            btn.classList.remove('bg-brand-leaf', 'text-white');
            btn.classList.add('hover:bg-brand-sky/10');
        });

        const selectedBtn = this.subcategories.querySelector(`[data-value="${value}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('bg-brand-leaf', 'text-white');
            selectedBtn.classList.remove('hover:bg-brand-sky/10');
        }

        this.displayText.textContent = label;
        this.displayText.classList.remove('text-slate-500');
        this.displayText.classList.add('text-slate-900');
        this.hiddenInput.value = value;

        this.selectedSubcategory = value.split('-')[1];

        setTimeout(() => this.closeSelector(), 150);
    },

    toggleSelector() {
        if (this.selector.classList.contains('hidden')) {
            this.openSelector();
        } else {
            this.closeSelector();
        }
    },

    openSelector() {
        this.selector.classList.remove('hidden');
        this.selector.classList.add('flex');
        this.trigger.classList.add('ring-2', 'ring-brand-sky');
    },

    closeSelector() {
        this.selector.classList.add('hidden');
        this.selector.classList.remove('flex');
        this.trigger.classList.remove('ring-2', 'ring-brand-sky');
    }
    };

    // Initialize category selector
    categorySelector.init();

    // Dynamic form fields based on listing type
    const listingTypeRadios = document.querySelectorAll('input[name="listing_type"]');
    const dynamicFieldLabel = document.getElementById('dynamic-field-label');
    const priceContainer = document.getElementById('price-container');
    const swapContainer = document.getElementById('swap-container');
    const budgetContainer = document.getElementById('budget-container');

    function updateDynamicField(selectedType) {
        priceContainer.classList.add('hidden');
        swapContainer.classList.add('hidden');
        budgetContainer.classList.add('hidden');

        if (selectedType === 'sale') {
            priceContainer.classList.remove('hidden');
            dynamicFieldLabel.textContent = 'Price *';
        } else if (selectedType === 'swap') {
            swapContainer.classList.remove('hidden');
            dynamicFieldLabel.textContent = 'Looking to Swap For *';
        } else if (selectedType === 'buy') {
            budgetContainer.classList.remove('hidden');
            dynamicFieldLabel.textContent = 'Budget *';
        }
    }

    listingTypeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            updateDynamicField(e.target.value);
        });
    });

    // Initialize Quill editor
    const quill = new Quill('#description-editor-content', {
        theme: 'snow',
        placeholder: 'Describe your item or service',
        modules: {
            toolbar: '#description-toolbar'
        }
    });

    // Set initial content from the listing using clipboard API for proper parsing
    const initialDescription = document.getElementById('id_description').value;
    if (initialDescription && initialDescription.trim() !== '') {
        // Use Quill's clipboard to properly parse and insert HTML content
        const delta = quill.clipboard.convert(initialDescription);
        quill.setContents(delta, 'silent');
    }

    // Sync Quill content to hidden input
    quill.on('text-change', function () {
        const html = quill.root.innerHTML;
        document.getElementById('id_description').value = html;
    });

    // Image upload functionality (simplified version)
    // ... (same as in home.html)

    function removeImage(imageId) {
        if (confirm('Are you sure you want to remove this image?')) {
            // This would need a separate view/URL for removing images
            // For now, just show an alert
            alert('Image removal functionality would need to be implemented with a separate endpoint.');
        }
    }
</script>
{% endblock %}