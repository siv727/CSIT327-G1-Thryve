{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thryve • Marketplace</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="{% static 'marketplace_app/styles.css' %}" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            sky: '#83e6f5', /* landing page sky blue */
                            leaf: '#3ac363', /* landing page light green */
                            ink: '#0f172a'
                        }
                    },
                    boxShadow: {
                        soft: '0 10px 28px rgba(2, 8, 23, .06)'
                    },
                    fontFamily: {
                        inter: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    borderRadius: {
                        xl2: '1rem'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-inter bg-[#f7fbfd] text-brand-ink">

    <header class="bg-[#23d3ee] text-white shadow">
        <div class="max-w-7xl mx-auto h-16 px-6 flex items-center justify-between">

            <a href="{% url 'marketplace:home' %}" class="flex items-center gap-2">
                <span
                    class="inline-flex items-center justify-center w-8 h-8 rounded-md bg-white font-black text-[#23d3ee]">T</span>
                <span class="text-[22px] font-extrabold tracking-tight">Thryve</span>
            </a>

            {% with active=request.resolver_match.url_name %}
            <nav class="flex items-center gap-6 text-[14px] font-medium">
                <a href="{% url 'thryve_app:dashboard' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                    </svg>
                    <span class="leading-none">Dashboard</span>
                    {% if active == 'dashboard' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'marketplace:home' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h18l-1.68 9.39a2 2 0 01-1.98 1.61H6.66a2 2 0 01-1.98-1.61L3 3zM16 16a3 3 0 11-6 0">
                        </path>
                    </svg>
                    <span class="leading-none">Marketplace</span>
                    {% if active == 'marketplace:home' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'marketplace:my_listings' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span class="leading-none">My Listings</span>
                    {% if active == 'my_listings' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'thryve_app:connections' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span class="leading-none">Connections</span>
                    {% if active == 'connections' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="#" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5V4H2v16h5M17 8l-5 5-5-5" />
                    </svg>
                    <span class="leading-none">Community</span>
                    {% if active == 'community' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'bookings' %}" class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z" />
                    </svg>
                    <span class="leading-none">Bookings</span>
                    {% if active == 'bookings' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>

                <a href="{% url 'business_profile' %}"
                    class="relative flex items-center gap-2 pb-1 hover:text-white transition-all text-white/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 21a8 8 0 10-16 0m8-9a4 4 0 100-8 4 4 0 000 8z" />
                    </svg>
                    <span class="leading-none">Profile</span>
                    {% if active == 'business_profile' %}
                    <span class="absolute left-0 -bottom-1 h-[2px] w-full bg-white"></span>
                    {% endif %}
                </a>
            </nav>
            {% endwith %}

            <button onclick="openLogoutModal()" type="button"
                class="flex items-center gap-2 font-medium text-white/90 hover:text-white transition-all text-[15px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H5a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1" />
                </svg>
                <span class="leading-none">Logout</span>
            </button>

        </div>
    </header>


    <main class="max-w-[1200px] mx-auto px-5 py-8">
        <div class="flex items-start justify-between gap-4 mb-6">
            <div>
                <h1 class="text-[38px] leading-[1.1] font-extrabold">
                    {% if is_my_listings %}
                    My Listings
                    {% else %}
                    Marketplace
                    {% endif %}
                </h1>
                <p class="text-slate-600 mt-1">
                    {% if is_my_listings %}
                    Manage your equipment and service listings.
                    {% else %}
                    Buy, sell, or swap equipment and services with confidence.
                    {% endif %}
                </p>
            </div>
            {% if not is_my_listings %}
            <button id="add-listing-btn"
                class="inline-flex items-center gap-2 rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold px-4 py-2.5 shadow-soft transition">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-width="2" d="M12 5v14M5 12h14" />
                </svg>
                Add Listing
            </button>
            {% endif %}
        </div>

        <section class="bg-white/90 backdrop-blur rounded-xl shadow-soft border border-slate-100 p-5 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Search</label>
                    <form id="filter-form" method="get" action="{% url 'marketplace:home' %}">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="11" cy="11" r="7" stroke-width="2" />
                                    <path stroke-width="2" d="M21 21l-4.3-4.3" />
                                </svg>
                            </span>
                            <input
                                class="w-full rounded-lg border border-slate-200 pl-10 pr-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                type="text" name="q" value="{{ search_query }}"
                                placeholder="Search items, services, or locations…" />
                        </div>
                        <!-- Hidden inputs to preserve selected category and type -->
                        <input type="hidden" name="category" id="filter-category-input" value="{{ category_filter }}">
                        <input type="hidden" name="type" id="filter-type-input" value="{{ type_filter }}">
                    </form>
                </div>

                <div>
                    <label class="block text-slate-700 font-semibold mb-2">Category</label>
                    <div class="relative">
                        <select
                            class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium appearance-none focus:outline-none focus:ring-2 focus:ring-brand-sky"
                            id="filter-category-select" onchange="document.getElementById('filter-category-input').value=this.value; document.getElementById('filter-form').submit();">
                            <option value="">All Categories</option>
                            {% for key, data in categories.items %}
                            <option value="{{ key }}" {% if category_filter == key %}selected{% endif %}>{{ data.label }}</option>
                            {% endfor %}
                        </select>
                        <span
                            class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">▾</span>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="text-slate-700 font-semibold mb-3">Type</div>
                <div class="flex flex-wrap items-center gap-2">
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {{ ''|yesno:'bg-brand-sky text-slate-900 hover:brightness-105,border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10' }}"
                        onclick="document.getElementById('filter-type-input').value=''; document.getElementById('filter-form').submit();">
                        All
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'sale' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='sale'; document.getElementById('filter-form').submit();">
                        For Sale
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'swap' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='swap'; document.getElementById('filter-form').submit();">
                        Swap
                    </button>
                    <button type="button"
                        class="px-4 py-2 rounded-full font-semibold transition {% if type_filter == 'buy' %}bg-brand-sky text-slate-900 hover:brightness-105{% else %}border border-brand-sky/60 text-slate-700 hover:bg-brand-sky/10{% endif %}"
                        onclick="document.getElementById('filter-type-input').value='buy'; document.getElementById('filter-form').submit();">
                        Wanted
                    </button>
                </div>
            </div>
        </section>

        <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% if not listings %}
            <div class="col-span-full text-center py-16">
                <p class="text-lg font-semibold text-slate-700 mb-2">No matching results</p>
                <p class="text-sm text-slate-500">Try adjusting your search, category, or type filters.</p>
            </div>
            {% else %}
            {% for listing in listings %}
            <article
                class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col hover:-translate-y-2 hover:shadow-lg transition-all duration-300"
                data-listing-id="{{ listing.id }}"
                data-images="{% for image in listing.images.all %}{{ image.image.url }}{% if not forloop.last %},{% endif %}{% endfor %}"
                data-title="{{ listing.title }}" data-description="{{ listing.description|safe }}"
                data-price="{% if listing.listing_type == 'sale' and listing.price %}₱{{ listing.price }}{% endif %}"
                data-swap-for="{% if listing.listing_type == 'swap' and listing.swap_for %}{{ listing.swap_for }}{% endif %}"
                data-budget="{% if listing.listing_type == 'buy' and listing.budget %}₱{{ listing.budget }}{% endif %}"
                data-location="{{ listing.location }}" data-date="{{ listing.date|date:'m/d/Y' }}"
                data-your-name="{{ listing.your_name }}" data-company="{{ listing.company }}"
                data-listing-type="{{ listing.listing_type }}"
                data-category="{% if listing.category %}{{ listing.category }}{% endif %}"
                data-subcategory="{% if listing.subcategory %}{{ listing.subcategory }}{% endif %}">
                <div class="w-full h-48 bg-slate-100 rounded-lg overflow-hidden mb-4 cursor-pointer"
                    onclick="openImageGallery('{{ listing.id }}')">
                    {% if listing.main_image %}
                    <img src="{{ listing.main_image.image.url }}" alt="{{ listing.title }}"
                        class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                    {% else %}
                    <img src="{% static 'thryve_app/images/listing-placeholder.png' %}" alt="No image available"
                        class="w-full h-full object-cover">
                    {% endif %}
                </div>

                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        {% if listing.listing_type == 'sale' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-800 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                </path>
                            </svg>
                            SALE
                        </span>
                        {% elif listing.listing_type == 'swap' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-emerald-600 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            SWAP
                        </span>
                        {% elif listing.listing_type == 'buy' %}
                        <span
                            class="inline-flex items-center gap-1 text-[11px] tracking-wide font-bold text-white bg-slate-700 px-2.5 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            BUY
                        </span>
                        {% endif %}
                        {% if listing.category %}
                        {% if listing.subcategory %}
                        <span
                            class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                            {% if listing.category == 'electronics' %}
                            {% if listing.subcategory == 'computers' %}Computers
                            {% elif listing.subcategory == 'phones' %}Phones
                            {% elif listing.subcategory == 'tablets' %}Tablets
                            {% elif listing.subcategory == 'audio_video' %}Audio/Video Equipment
                            {% elif listing.subcategory == 'cameras' %}Cameras
                            {% else %}Other Electronics{% endif %}
                            {% elif listing.category == 'furniture' %}
                            {% if listing.subcategory == 'office_chairs' %}Office Chairs
                            {% elif listing.subcategory == 'desks' %}Desks
                            {% elif listing.subcategory == 'cabinets' %}Cabinets
                            {% elif listing.subcategory == 'tables' %}Tables
                            {% elif listing.subcategory == 'seating' %}Seating
                            {% else %}Other Furniture{% endif %}
                            {% elif listing.category == 'tools_equipment' %}
                            {% if listing.subcategory == 'power_tools' %}Power Tools
                            {% elif listing.subcategory == 'hand_tools' %}Hand Tools
                            {% elif listing.subcategory == 'machinery' %}Machinery
                            {% elif listing.subcategory == 'safety_equipment' %}Safety Equipment
                            {% elif listing.subcategory == 'measuring_tools' %}Measuring Tools
                            {% else %}Other Tools & Equipment{% endif %}
                            {% elif listing.category == 'raw_materials' %}
                            {% if listing.subcategory == 'metals' %}Metals
                            {% elif listing.subcategory == 'plastics' %}Plastics
                            {% elif listing.subcategory == 'woods' %}Woods
                            {% elif listing.subcategory == 'chemicals' %}Chemicals
                            {% elif listing.subcategory == 'fabrics' %}Fabrics
                            {% else %}Other Raw Materials{% endif %}
                            {% elif listing.category == 'services' %}
                            {% if listing.subcategory == 'consulting' %}Consulting
                            {% elif listing.subcategory == 'maintenance' %}Maintenance
                            {% elif listing.subcategory == 'installation' %}Installation
                            {% elif listing.subcategory == 'training' %}Training
                            {% elif listing.subcategory == 'design' %}Design
                            {% else %}Other Services{% endif %}
                            {% else %}
                            Miscellaneous
                            {% endif %}
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center text-[11px] font-semibold text-slate-700 bg-slate-100 px-2.5 py-1 rounded-full">
                            {% if listing.category == 'electronics' %}Electronics
                            {% elif listing.category == 'furniture' %}Furniture
                            {% elif listing.category == 'tools_equipment' %}Tools & Equipment
                            {% elif listing.category == 'raw_materials' %}Raw Materials
                            {% elif listing.category == 'services' %}Services
                            {% else %}Other{% endif %}
                        </span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <span
                        class="inline-flex items-center gap-1 text-[11px] font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-1 rounded-full">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Available
                    </span>
                </div>
                {% if listing.title|length > 25 %}
                <div class="title-scroll-container relative">
                    <div class="title-scroll-text whitespace-nowrap">
                        <h3 class="text-lg font-bold inline-block">{{ listing.title }}</h3>
                        <span class="title-spacer text-lg font-bold inline-block"
                            aria-hidden="true">{{listing.title}}</span>
                    </div>
                </div>
                {% else %}
                <h3 class="text-lg font-bold truncate">{{ listing.title }}</h3>
                {% endif %}
                <div class="mt-0.5 text-slate-500 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <strong>{{ listing.your_name }}</strong> | {{ listing.company }}
                </div>
                <div class="relative mt-3 text-slate-700 card-description">
                    {% with stripped_desc=listing.description|striptags %}
                    {% if stripped_desc|length > 120 %}
                    <p class="pr-16 break-words whitespace-normal line-clamp-2">
                        {{ stripped_desc|slice:":200" }}
                    </p>
                    <span class="absolute right-0 bottom-0 bg-white pl-2 z-10 cursor-pointer"
                        onclick="openListingDetailsModal('{{ listing.id }}')">
                        <span
                            class="font-semibold text-slate-700 hover:text-brand-leaf transition-colors duration-200">...
                            See More</span>
                    </span>
                    {% else %}
                    <div class="description-preview break-words whitespace-normal line-clamp-2">
                        {{ listing.description|safe }}
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>

                {% if listing.listing_type == 'sale' and listing.price %}
                <div class="mt-4 text-[22px] font-extrabold text-brand-leaf">₱{{ listing.price }}</div>
                {% elif listing.listing_type == 'swap' and listing.swap_for %}
                <div class="mt-4 text-[22px] font-extrabold flex items-baseline gap-2">
                    <span class="text-slate-700 shrink-0">Looking for:</span>
                    {% if listing.swap_for|length > 15 %}
                    <div class="looking-scroll-container flex-1 min-w-0">
                        <div class="looking-scroll-text whitespace-nowrap">
                            <span class="text-brand-leaf inline-block">{{ listing.swap_for }}</span>
                            <span class="looking-spacer text-brand-leaf inline-block"
                                aria-hidden="true">{{listing.swap_for }}</span>
                        </div>
                    </div>
                    {% else %}
                    <span class="text-brand-leaf truncate flex-1 min-w-0">{{ listing.swap_for }}</span>
                    {% endif %}
                </div>
                {% elif listing.listing_type == 'buy' and listing.budget %}
                <div class="mt-4 text-[22px] font-extrabold"><span class="text-slate-700">Budget:</span> <span
                        class="text-brand-leaf">₱{{ listing.budget }}</span></div>
                {% endif %}

                <div class="mt-2 flex items-center justify-between text-sm text-slate-500 font-medium">
                    <span class="flex items-center gap-1 max-w-[60%]">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        {% if listing.location|length > 20 %}
                        <div class="location-scroll-container">
                            <div class="location-scroll-text whitespace-nowrap">
                                <span class="inline-block">{{ listing.location }}</span>
                                <span class="location-spacer inline-block" aria-hidden="true">{{listing.location}}</span>
                            </div>
                        </div>
                        {% else %}
                        <span class="truncate">{{ listing.location }}</span>
                        {% endif %}
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ listing.date|date:"m/d/Y" }}
                    </span>
                </div>
                <div class="mt-5 grid grid-cols-2 gap-3">
                    {% if is_my_listings %}
                    <button onclick="openEditModal{{ listing.id }}()"
                        class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">Edit
                        Details</button>
                    <button onclick="openDeleteListingModal('{{ listing.id }}')"
                        class="text-center rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5">Delete</button>
                    {% else %}
                    <button onclick="openListingDetailsModal('{{ listing.id }}')"
                        class="text-center rounded-lg border font-semibold py-2.5 hover:bg-slate-50">View
                        Details</button>
                    <button onclick="openBookNowModal('{{ listing.id }}')"
                        class="text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-2.5">Book
                        Now</button>
                    {% endif %}
                </div>
            </article>

            <!-- Individual Edit Modal for Listing {{ listing.id }} -->
            {% if is_my_listings %}
            <script>
                function openEditModal{{ listing.id }}() {
                    document.getElementById('editModal{{ listing.id }}').classList.remove('hidden');
                    document.getElementById('editModal{{ listing.id }}').classList.add('flex');
                }
                function closeEditModal{{ listing.id }}() {
                    document.getElementById('editModal{{ listing.id }}').classList.add('hidden');
                    document.getElementById('editModal{{ listing.id }}').classList.remove('flex');
                }
                let editNewImagesData{{ listing.id }} = [];

                function handleImagePreview{{ listing.id }}(input) {
                    const previewContainer = document.getElementById('imagePreview{{ listing.id }}');
                    const photoCounter = document.getElementById('photoCounter{{ listing.id }}');
                    const existingCount = {{ listing.images.count }};
                    const fileInput = input;

                    if (input.files && input.files.length > 0) {
                        const currentNewCount = editNewImagesData{{ listing.id }}.length;
                        const availableSlots = 5 - existingCount - currentNewCount;

                        if (availableSlots <= 0) {
                            alert('Maximum 5 images allowed. You have reached the limit.');
                            fileInput.value = '';
                            return;
                        }

                        const filesToAdd = Math.min(input.files.length, availableSlots);
                        if (input.files.length > availableSlots) {
                            alert(`You can only add ${availableSlots} more image(s). Only the first ${availableSlots} will be added.`);
                        }

                        // Add new files to our array
                        for (let i = 0; i < filesToAdd; i++) {
                            editNewImagesData{{ listing.id }}.push(input.files[i]);

                            const reader = new FileReader();
                            const fileIndex = currentNewCount + i;
                            reader.onload = function(e) {
                                const previewDiv = document.createElement('div');
                                previewDiv.className = 'relative group new-image-preview';
                                previewDiv.setAttribute('data-index', fileIndex);
                                previewDiv.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                                    <div class="absolute top-1 right-1 bg-brand-sky text-white text-xs px-1.5 py-0.5 rounded">New</div>
                                    <button type="button" onclick="removeNewImage{{ listing.id }}(${fileIndex})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity">×</button>
                                `;
                                previewContainer.appendChild(previewDiv);
                            };
                            reader.readAsDataURL(input.files[i]);
                        }

                        const totalCount = existingCount + editNewImagesData{{ listing.id }}.length;
                        photoCounter.textContent = `Photos: ${totalCount}/5`;

                        // Clear the file input so the same file can be selected again
                        fileInput.value = '';
                    }
                }

                function removeNewImage{{ listing.id }}(index) {
                    // Remove from array
                    editNewImagesData{{ listing.id }}.splice(index, 1);

                    // Update preview container
                    const previewContainer = document.getElementById('imagePreview{{ listing.id }}');
                    const allNewPreviews = previewContainer.querySelectorAll('.new-image-preview');
                    allNewPreviews.forEach(preview => preview.remove());

                    // Re-render remaining new images with updated indices
                    editNewImagesData{{ listing.id }}.forEach((file, newIndex) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'relative group new-image-preview';
                            previewDiv.setAttribute('data-index', newIndex);
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-brand-sky">
                                <div class="absolute top-1 right-1 bg-brand-sky text-white text-xs px-1.5 py-0.5 rounded">New</div>
                                <button type="button" onclick="removeNewImage{{ listing.id }}(${newIndex})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity">×</button>
                            `;
                            previewContainer.appendChild(previewDiv);
                        };
                        reader.readAsDataURL(file);
                    });

                    // Update counter
                    const existingCount = {{ listing.images.count }};
                    const totalCount = existingCount + editNewImagesData{{ listing.id }}.length;
                    document.getElementById('photoCounter{{ listing.id }}').textContent = `Photos: ${totalCount}/5`;
                }

                function submitEditForm{{ listing.id }}(form) {
                    // Create a new DataTransfer object to hold our files
                    const dataTransfer = new DataTransfer();

                    // Add all new images to the file input
                    editNewImagesData{{ listing.id }}.forEach(file => {
                        dataTransfer.items.add(file);
                    });

                    // Update the file input with our collected files
                    const fileInput = form.querySelector('input[type="file"]');
                    fileInput.files = dataTransfer.files;

                    return true; // Allow form submission
                }
            </script>
            <div id="editModal{{ listing.id }}" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="if(event.target === this) closeEditModal{{ listing.id }}()">
                <div class="flex items-center justify-center min-h-screen p-4 w-full">
                    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-slate-900">Edit Listing</h2>
                                <button onclick="closeEditModal{{ listing.id }}()" type="button" class="text-slate-400 hover:text-slate-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <form method="post" action="{% url 'marketplace:edit_listing' listing.id %}" enctype="multipart/form-data" onsubmit="return submitEditForm{{ listing.id }}(this)">
                                {% csrf_token %}

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="sale" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'sale' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">For Sale</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="swap" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'swap' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">For Swap</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="listing_type" value="buy" class="text-brand-sky focus:ring-brand-sky" {% if listing.listing_type == 'buy' %}checked{% endif %} required>
                                            <span class="ml-2 text-slate-700">Looking to Buy</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Category *</label>
                                    <input type="hidden" name="category" value="{% if listing.subcategory %}{{ listing.category }}-{{ listing.subcategory }}{% else %}{{ listing.category }}{% endif %}">
                                    <div class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-slate-100 text-slate-700">
                                        {{ listing.category_display }}{% if listing.subcategory_display %} - {{ listing.subcategory_display }}{% endif %}
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Title *</label>
                                    <input type="text" name="title" value="{{ listing.title }}" placeholder="Enter listing title" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Description *</label>
                                    <textarea name="description" rows="4" placeholder="Describe your item or service" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 resize-y" required>{{ listing.description }}</textarea>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">
                                        {% if listing.listing_type == 'sale' %}Price *
                                        {% elif listing.listing_type == 'swap' %}Looking to Swap For *
                                        {% elif listing.listing_type == 'buy' %}Budget *
                                        {% endif %}
                                    </label>
                                    {% if listing.listing_type == 'sale' %}
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                        <input type="text" name="price" value="{{ listing.price }}" placeholder="0.00" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    </div>
                                    {% elif listing.listing_type == 'swap' %}
                                    <input type="text" name="swap_for" value="{{ listing.swap_for }}" placeholder="What are you looking to swap for?" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    {% elif listing.listing_type == 'buy' %}
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                        <input type="text" name="budget" value="{{ listing.budget }}" placeholder="0.00" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Location *</label>
                                    <input type="text" name="location" value="{{ listing.location }}" placeholder="City, State/Country" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Date *</label>
                                    <input type="date" name="date" value="{{ listing.date|date:'Y-m-d' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400" required>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-slate-700 font-semibold mb-2">Listing Images</label>

                                    <!-- Image Preview Section -->
                                    <div id="imagePreview{{ listing.id }}" class="flex flex-wrap gap-2 mb-3">
                                        {% for image in listing.images.all %}
                                        <div class="relative group">
                                            <img src="{{ image.image.url }}" alt="Listing image" class="w-20 h-20 object-cover rounded-lg border-2 border-slate-300">
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors bg-slate-50 relative">
                                        <div class="flex flex-col items-center justify-center space-y-4">
                                            <div class="w-12 h-12 text-slate-400">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                                <p class="text-sm text-slate-500">or <span class="text-brand-sky font-medium">click to browse</span></p>
                                            </div>
                                            <p id="photoCounter{{ listing.id }}" class="text-sm font-medium text-slate-600">Photos: {{ listing.images.count }}/5</p>
                                        </div>
                                        <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer pointer-events-auto" onchange="handleImagePreview{{ listing.id }}(this)">
                                    </div>
                                    <div class="mt-2 text-sm text-slate-500">
                                        <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-3">
                                    <button type="button" onclick="closeEditModal{{ listing.id }}()" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                                    <button type="submit" class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update Listing</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% empty %}
            <article class="bg-white rounded-xl shadow-soft border border-slate-100 p-5 flex flex-col">
                <div class="col-span-full text-center py-12">
                    <p class="text-slate-500 text-lg">No listings created</p>
                </div>
            </article>
            {% endfor %}
            {% endif %}
        </section>
    </main>

    <!-- Listing Details Modal -->
    <div id="listing-details-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-slate-900" id="details-modal-title">Listing Details</h2>
                    <button id="close-details-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Main Image -->
                <div class="w-full h-64 bg-slate-100 rounded-lg overflow-hidden mb-6" id="details-main-image-container">
                    <img id="details-main-image" src="" alt="Listing image" class="w-full h-full object-cover">
                </div>

                <!-- Listing Type and Category Badges -->
                <div class="flex items-center gap-2 mb-4" id="details-badges">
                    <!-- Badges will be populated by JavaScript -->
                </div>

                <!-- Title (wrapped, no overflow) -->
                <h3 class="text-2xl font-bold text-slate-900 mb-2 break-words whitespace-normal" id="details-title">
                </h3>

                <!-- Seller Info -->
                <div class="flex items-center gap-2 text-slate-600 font-medium mb-4" id="details-seller">
                    <!-- Seller info will be populated by JavaScript -->
                </div>

                <!-- Description -->
                <div class="text-slate-700 mb-6" id="details-description">
                    <!-- Description will be populated by JavaScript -->
                </div>

                <!-- Price/Swap/Budget (wrapped, with non-overflowing swap text) -->
                <div class="text-3xl font-extrabold text-brand-leaf mb-6 break-words whitespace-normal"
                    id="details-price">
                    <!-- Price info will be populated by JavaScript -->
                </div>

                <!-- Location and Date -->
                <div class="flex items-center justify-between text-sm text-slate-500 mb-6" id="details-meta">
                    <!-- Meta info will be populated by JavaScript -->
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button
                        class="flex-1 text-center rounded-lg bg-brand-leaf hover:bg-[#33b459] text-white font-semibold py-3">Book
                        Now</button>
                    <button id="view-gallery-btn"
                        class="flex-1 text-center rounded-lg border border-brand-sky text-brand-sky font-semibold py-3 hover:bg-brand-sky/10">View
                        Gallery</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="image-gallery-modal"
        class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center">
        <div class="relative w-full max-w-4xl mx-4 flex flex-col items-center">
            <!-- Close button -->
            <button id="close-gallery"
                class="absolute -top-12 right-0 text-white hover:text-slate-300 text-2xl font-bold z-10">
                ✕
            </button>

            <!-- Main image container -->
            <div
                class="relative w-full h-[70vh] flex items-center justify-center bg-transparent rounded-lg overflow-hidden">
                <img id="gallery-main-image" src="" alt=""
                    class="max-w-full max-h-full object-contain rounded-lg transition-transform duration-300 ease-out cursor-grab"
                    style="transform: scale(1) translate(0, 0); transform-origin: center center;"
                    onwheel="handleWheelZoom(event)">

                <!-- Navigation arrows -->
                <button id="prev-image"
                    class="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ‹
                </button>
                <button id="next-image"
                    class="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl transition-all z-10">
                    ›
                </button>

                <!-- Zoom controls -->
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10">
                    <button id="zoom-out"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all"
                        title="Zoom Out">
                        −
                    </button>
                    <button id="zoom-reset"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm transition-all"
                        title="Reset Zoom">
                        1:1
                    </button>
                    <button id="zoom-in"
                        class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-lg transition-all"
                        title="Zoom In">
                        +
                    </button>
                </div>
            </div>

            <!-- Image counter -->
            <div class="text-center mt-4">
                <span id="image-counter"
                    class="text-white text-sm bg-black bg-opacity-50 px-3 py-1 rounded-full"></span>
            </div>

            <!-- Thumbnail strip -->
            <div id="thumbnail-strip" class="flex justify-center gap-2 mt-4 max-w-full overflow-x-auto">
                <!-- Thumbnails will be populated by JavaScript -->
            </div>
        </div>
    </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-listing-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Delete Listing</h2>
                    <button id="close-delete-modal" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-slate-700">Are you sure you want to delete this listing? This action cannot be
                        undone.</p>
                </div>

                <div class="flex justify-end gap-3">
                    <button id="cancel-delete-btn"
                        class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                    <button id="confirm-delete-btn"
                        class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition">Delete
                        Listing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div id="edit-listing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Edit Listing</h2>
                        <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="edit-listing-form" method="post" action="" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy"
                                        class="text-brand-sky focus:ring-brand-sky" required>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_category" class="block text-slate-700 font-semibold mb-2">Category
                                *</label>
                            <div class="relative">
                                <input type="hidden" name="category" id="edit_id_category" value="">
                                <div id="edit-category-selector-trigger"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="edit-category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">▾</span>
                                </div>

                                <div id="edit-category-selector"
                                    class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES
                                                </div>
                                                <div id="edit-main-categories" class="space-y-1">
                                                    {% for key, data in categories.items %}
                                                    <button type="button"
                                                        class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn"
                                                        data-category="{{ key }}">{{ data.label }}</button>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES
                                                </div>
                                                <div id="edit-subcategories" class="space-y-1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_title" class="block text-slate-700 font-semibold mb-2">Title *</label>
                            <input type="text" name="title"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                placeholder="Enter listing title" id="edit_id_title">
                            {% if form.title.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.title.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_description" class="block text-slate-700 font-semibold mb-2">Description
                                *</label>
                            <textarea name="description" id="edit_id_description"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 resize-y overflow-y-auto"
                                rows="4" placeholder="Describe your item or service"></textarea>
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4" id="edit-dynamic-field-container">
                            <label id="edit-dynamic-field-label" for="edit_id_price"
                                class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="edit-price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="price"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="0.00" id="edit_id_price">
                            </div>
                            <div class="hidden" id="edit-swap-container">
                                <input type="text" name="swap_for"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="What are you looking to swap for?" id="edit_id_swap_for">
                            </div>
                            <div class="relative hidden" id="edit-budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="budget"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="0.00" id="edit_id_budget">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_location" class="block text-slate-700 font-semibold mb-2">Location
                                *</label>
                            <div class="relative">
                                <input type="text" name="location" id="edit_id_location"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="City, State/Country">
                            </div>
                            {% if form.location.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.location.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_date" class="block text-slate-700 font-semibold mb-2">Date *</label>
                            <input type="date" name="date" id="edit_id_date"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                            {% if form.date.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="edit_id_images" class="block text-slate-700 font-semibold mb-2">Listing
                                Images</label>

                            <!-- All Images Display (Current + New) -->
                            <div id="edit-all-images" class="mb-4">
                                <!-- Current images will be populated by JavaScript -->
                            </div>

                            <!-- Upload Area -->
                            <div id="edit-upload-area"
                                class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="edit-upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                    </div>
                                    <div id="edit-upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span
                                                class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="edit-image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp"
                                    id="edit_id_images" multiple
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            </div>

                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="edit-cancel-btn"
                                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="button" id="edit-submit-btn" onclick="submitEditListingForm()"
                                class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Update
                                Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="add-listing-modal"
        class="fixed inset-0 bg-black bg-opacity-50 {% if show_modal %}flex{% else %}hidden{% endif %} z-50">
        <div class="flex items-center justify-center min-h-screen p-4 w-full">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-slate-900">Create New Listing</h2>
                        <button id="close-modal" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="listing-form" method="post" action="{% url 'marketplace:create_listing' %}"
                        enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <!-- Display non-field errors -->
                        {% if form.non_field_errors %}
                        <div class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            {% for error in form.non_field_errors %}
                            <p class="text-sm">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label class="block text-slate-700 font-semibold mb-2">Listing Type *</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="sale"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'sale' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">For Sale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="swap"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'swap' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">For Swap</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="listing_type" value="buy"
                                        class="text-brand-sky focus:ring-brand-sky" required
                                        {% if form.listing_type.value == 'buy' %}checked{% endif %}>
                                    <span class="ml-2 text-slate-700">Looking to Buy</span>
                                </label>
                            </div>
                            {% if form.listing_type.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.listing_type.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.category.id_for_label }}"
                                class="block text-slate-700 font-semibold mb-2">Category *</label>
                            <div class="relative">
                                <!-- Hidden input to store the selected value -->
                                <input type="hidden" name="category" id="id_category" value="{{ form.category.value|default:'' }}">

                                <!-- Custom category selector trigger -->
                                <div id="category-selector-trigger"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium bg-white cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-sky flex items-center justify-between">
                                    <span id="category-display-text" class="text-slate-400">Choose Category</span>
                                    <span class="text-slate-400">▾</span>
                                </div>

                                <!-- Two-column category selector -->
                                <div id="category-selector"
                                    class="absolute top-full left-0 mt-1 w-full bg-white border border-slate-200 rounded-lg shadow-lg z-10 hidden">
                                    <div class="flex">
                                        <!-- Left Column: Main Categories -->
                                        <div class="w-1/2 border-r border-slate-200 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">CATEGORIES
                                                </div>
                                                <div id="main-categories" class="space-y-1">
                                                    {% for key, data in categories.items %}
                                                    <button type="button"
                                                        class="w-full text-left px-3 py-2 text-sm hover:bg-brand-sky/10 rounded category-btn{% if forloop.first %} active{% endif %}"
                                                        data-category="{{ key }}">{{ data.label }}</button>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Subcategories -->
                                        <div class="w-1/2 max-h-64 overflow-y-auto">
                                            <div class="p-2">
                                                <div class="text-xs text-slate-500 font-medium mb-2 px-2">SUBCATEGORIES
                                                </div>
                                                <div id="subcategories" class="space-y-1">
                                                    <!-- Subcategories will be populated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if form.category.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.category.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}"
                                class="block text-slate-700 font-semibold mb-2">Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.title.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_description" class="block text-slate-700 font-semibold mb-2">Description
                                *</label>
                            <textarea name="description" id="id_description" rows="4"
                                placeholder="Describe your item or service"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400 whitespace-normal break-words resize-y"></textarea>
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4" id="dynamic-field-container">
                            <label id="dynamic-field-label" for="id_price"
                                class="block text-slate-700 font-semibold mb-2">Price *</label>
                            <div class="relative" id="price-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="price"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="0.00" id="id_price" value="{{ form.price.value|default:'' }}">
                                {% if form.price.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.price.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div class="hidden" id="swap-container">
                                <input type="text" name="swap_for"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="What are you looking to swap for?" id="id_swap_for" value="{{ form.swap_for.value|default:'' }}">
                                {% if form.swap_for.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.swap_for.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div class="relative hidden" id="budget-container">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-900">₱</span>
                                <input type="text" name="budget"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 pl-7 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky"
                                    placeholder="0.00" id="id_budget" value="{{ form.budget.value|default:'' }}">
                                {% if form.budget.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.budget.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>


                        <div class="mb-4">
                            <label for="id_location" class="block text-slate-700 font-semibold mb-2">Location *</label>
                            <div class="relative">
                                <input type="text" name="location" id="id_location"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400"
                                    placeholder="City, State/Country">
                            </div>
                            {% if form.location.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.location.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_date" class="block text-slate-700 font-semibold mb-2">Date *</label>
                            <input type="date" name="date" id="id_date"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 font-medium focus:outline-none focus:ring-2 focus:ring-brand-sky placeholder:text-slate-400">
                            {% if form.date.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="id_images" class="block text-slate-700 font-semibold mb-2">Listing
                                Images</label>

                            <!-- Image Previews Container (New Images Only) -->
                            <div id="create-image-previews" class="mb-3 flex flex-wrap gap-2">
                                <!-- New image thumbnails will be rendered here -->
                            </div>

                            <!-- Drag and Drop Upload Area -->
                            <div id="upload-area"
                                class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-sky transition-colors cursor-pointer bg-slate-50 hover:bg-slate-100/50">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div id="upload-icon" class="w-12 h-12 text-slate-400">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                    </div>
                                    <div id="upload-text">
                                        <p class="text-lg font-medium text-slate-700">Drag and drop your images here</p>
                                        <p class="text-sm text-slate-500">or <span
                                                class="text-brand-sky font-medium">click to browse</span></p>
                                    </div>
                                    <div id="create-image-counter" class="text-sm font-medium text-slate-600">
                                        Photos: 0/5
                                    </div>
                                </div>
                                <input type="file" name="images" accept="image/jpeg,image/png,image/gif,image/webp"
                                    id="id_images" multiple
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    onchange="handleCreateImagePreview(this)">
                            </div>

                            <!-- Upload Info -->
                            <div class="mt-2 text-sm text-slate-500">
                                <p>Supported formats: JPEG, PNG, GIF, WebP (max 5MB each)</p>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3">
                            <button type="button" id="cancel-btn"
                                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                            <button type="submit" id="submit-btn"
                                class="px-6 py-2 bg-brand-leaf hover:bg-[#33b459] text-white font-semibold rounded-lg transition">Create
                                Listing</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    {{ categories|json_script:"categories-data" }}

    <script>
        window.MARKETPLACE_CONFIG = {
            placeholderImage: "{% static 'thryve_app/images/listing-placeholder.png' %}",
            showCreateModal: {{ show_create_modal|yesno:"true,false" }}
        };
    </script>

    <script src="{% static 'marketplace_app/script.js' %}"></script>

    {% include 'accounts/logout_modal.html' %}
</body>

</html>