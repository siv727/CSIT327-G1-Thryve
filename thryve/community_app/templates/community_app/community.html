{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thryve • Community Feed</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Your existing Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#26a8e6', 600: '#199ad7', 700: '#148cc5' },
                        ink: '#0f172a',
                        line: '#e7edf4',
                        bg: '#f7fbfd'
                    },
                    boxShadow: { soft: '0 10px 28px rgba(2,8,23,.06)' },
                    fontFamily: { inter: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* General body style from your business_logo.html */
        .font-inter {
            font-family: 'Inter', sans-serif;
        }

        .bg-\[\#f7fbfd\] {
            background-color: #f7fbfd;
        }

        .text-brand-ink {
            color: #0f172a;
        }

        /* Styles to match the look of the SME Exchange example */
        .feed-wrapper {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .feed-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .post-card {
            /* Tailwind equivalent for card + soft border/shadow */
            border: 1px solid #e7edf4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
        }

        .btn-action-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #6c757d;
            transition: color 0.2s;
        }

        /* Style for post meta info (company name and date) */
        .post-info-text {
            display: inline-flex;
            align-items: center;
            font-size: 0.875rem;
        }

        .post-info-text i {
            margin-right: 3px;
        }

        /* Styling the Django Form Field (TextArea) to look good */
        .add-comment-form textarea {
            width: 100%;
            border: 1px solid #e7edf4;
            border-radius: 0.25rem 0 0 0.25rem;
            /* Match the input-group styling */
            padding: 0.5rem 0.75rem;
            resize: none;
        }
    </style>
</head>

<body class="font-inter bg-[#f7fbfd] text-brand-ink">

    {% include 'thryve_app/navbar.html' %}

    <div class="feed-wrapper mt-4">

        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-semibold">Community Feed</h2>
                <p class="text-gray-500">Share experiences and connect with other SMEs</p>
            </div>
            <button class="bg-brand-500 hover:bg-brand-600 text-white font-medium py-2 px-4 rounded-md shadow"
                data-modal-target="#createPostModal">
                <i class="fas fa-plus-circle mr-1"></i> Create Post
            </button>
        </div>

        <div id="createPostModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto"
            aria-modal="true" role="dialog" tabindex="-1">
            <div class="relative w-full max-w-lg mx-auto mt-10 p-6 bg-white rounded-lg shadow-xl">
                <div class="flex justify-between items-center pb-3 border-b border-line">
                    <h5 class="text-xl font-semibold" id="createPostLabel">Create New Post</h5>
                    <button type="button" class="text-gray-400 hover:text-gray-600" data-modal-close>
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="POST" action="{% url 'community_app:create_community_post' %}">
                    {% csrf_token %}
                    <div class="py-4">
                        {{ form.content }}
                        {% if form.content.errors %}
                        <div class="text-red-600 mt-2 text-sm">{{ form.content.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="flex justify-end pt-3 border-t border-line">
                        <button type="button"
                            class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md mr-2 hover:bg-gray-300"
                            data-modal-close>Cancel</button>
                        <button type="submit"
                            class="bg-brand-500 hover:bg-brand-600 text-white font-medium py-2 px-4 rounded-md">Post</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="feed-container">
            {% for post in posts %}
            <div class="post-card bg-white p-4 rounded-lg mb-4" data-post-card-id="{{ post.id }}">

                <div class="post-header mb-2 flex justify-between items-start">
                    <div>
                        <h5 class="text-lg font-semibold mb-1">
                            {% with display_name=post.user.userprofile.display_name %}
                            {% if display_name %}
                            {{ display_name }}
                            {% else %}
                            {{ post.user.username }}
                            {% endif %}
                            {% endwith %}
                        </h5>
                        <p class="text-gray-500 text-sm mb-0">
                            <span class="post-info-text">
                                <i class="fas fa-building"></i>
                                {{ post.user.businessprofile.company_name|default:"SME User" }} </span>
                            <span class="mx-1">•</span>
                            <span class="post-info-text">
                                <i class="fas fa-clock"></i>
                                {{ post.created_at|date:"n/j/Y" }}
                            </span>
                        </p>
                    </div>

                    {% if post.user == user %}
                    <div class="relative">
                        <button class="text-gray-500 hover:text-ink p-1 -mt-1"
                            onclick="toggleDropdown('post-menu-{{ post.id }}')">
                            <i class="fas fa-ellipsis-h text-xl"></i>
                        </button>

                        <div id="post-menu-{{ post.id }}"
                            class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 hidden border border-line">
                            <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100"
                                onclick="confirmDeletePost({{ post.id }})">
                                <i class="fas fa-trash mr-2"></i> Delete Post
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <p class="text-ink break-words">{{ post.content|linebreaksbr }}</p>

                <div class="border-t border-line my-3"></div>

                <div class="post-actions flex items-center">
                    <button class="like-btn btn-action-icon {% if post.id in liked_posts_ids %}text-red-500{% endif %}"
                        data-post-id="{{ post.id }}">
                        <i class="{% if post.id in liked_posts_ids %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="like-count ml-1">{{ post.likes_count }}</span>
                    </button>

                    <button class="comment-btn btn-action-icon ml-3 text-gray-500"
                        onclick="toggleComments({{ post.id }})" data-post-id="{{ post.id }}">
                        <i class="far fa-comment"></i>
                        <span class="comment-count ml-1">{{ post.comments_count }}</span>
                    </button>
                </div>

                <div class="comments-section mt-4 hidden" id="comments-{{ post.id }}">

                    <form class="add-comment-form mt-2" data-post-id="{{ post.id }}"
                        action="{% url 'community_app:add_comment' post.id %}" method="POST">
                        {% csrf_token %}
                        <div class="flex">
                            {{ comment_form.content }}
                            <div class="flex-shrink-0">
                                <button type="submit"
                                    class="bg-brand-500 hover:bg-brand-600 text-white font-medium py-2 px-3 rounded-r-md h-full">Post</button>
                            </div>
                        </div>
                    </form>

                    <div class="existing-comments-{{ post.id }} mt-4">
                        {% for comment in post.comments.all %}
                        <div class="comment-item border-l-2 border-gray-200 pl-3 py-1 mb-2 flex justify-between items-start"
                            data-comment-id="{{ comment.id }}" data-post-id="{{ post.id }}">
                            <div>
                                <p class="mb-0 text-sm font-semibold">
                                    {% with display_name=comment.user.userprofile.display_name %}
                                    {% if display_name %}
                                    {{ display_name }}
                                    {% else %}
                                    {{ comment.user.username }}
                                    {% endif %}
                                    {% endwith %}
                                </p>
                                <p class="mb-0 text-xs text-gray-500">
                                    {# Removed <i class="fas fa-building mr-1"></i> #}
                                    {{ comment.user.businessprofile.company_name|default:"SME User" }}
                                    <span class="mx-1">•</span>
                                    {{ comment.created_at|date:"n/j/Y" }}
                                </p>
                                <p class="mb-0 text-ink">{{ comment.content|linebreaksbr }}</p>
                            </div>

                            {% if comment.user == user %}
                            <button class="text-red-500 hover:text-red-700 p-1 text-sm flex-shrink-0"
                                onclick="confirmDeleteComment({{ post.id }}, {{ comment.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="no-comments-{{ post.id }} text-center text-gray-500 text-sm py-2">
                            No comments yet.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            {% endfor %}
        </div>
    </div>

    <script>
        // --- CSRF Token Utility ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- Post Delete Functions ---

        // Toggles the visibility of the three-dot menu
        function toggleDropdown(menuId) {
            event.stopPropagation(); // Prevent the click from immediately propagating to the document listener
            const menu = document.getElementById(menuId);

            // Hide all other open menus first
            document.querySelectorAll('[id^="post-menu-"]').forEach(otherMenu => {
                if (otherMenu.id !== menuId) {
                    otherMenu.classList.add('hidden');
                }
            });
            // Toggle the current menu
            menu.classList.toggle('hidden');
        }

        // Handles the post delete action confirmation and AJAX request
        function confirmDeletePost(postId) {
            event.preventDefault(); // Stop the default link behavior
            // Hide the dropdown menu immediately
            document.getElementById(`post-menu-${postId}`).classList.add('hidden');

            if (!confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
                return;
            }

            const url = `/community/${postId}/delete/`;
            const csrftoken = getCookie('csrftoken');

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
            })
                .then(response => {
                    if (response.ok) {
                        // Find and remove the post card from the DOM
                        const postCard = document.querySelector(`.post-card[data-post-card-id="${postId}"]`);
                        if (postCard) {
                            postCard.remove();
                            console.log(`Post ${postId} deleted successfully.`);
                        }
                    } else {
                        // Handle error response (e.g., unauthorized, post not found)
                        response.json().then(errorData => {
                            alert('Failed to delete post: ' + (errorData.message || 'Unknown error.'));
                        });
                    }
                })
                .catch(error => {
                    console.error('Error deleting post:', error);
                    alert('An error occurred while trying to delete the post.');
                });
        }

        // Handles the comment delete action confirmation and AJAX request
        function confirmDeleteComment(postId, commentId) {
            if (!confirm("Are you sure you want to delete this comment?")) {
                return;
            }

            const url = `/community/${postId}/comment/${commentId}/delete/`;
            const csrftoken = getCookie('csrftoken');

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
            })
                .then(response => {
                    if (response.ok) {
                        // Remove the comment item from the DOM
                        const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
                        if (commentItem) {
                            commentItem.remove();
                        }

                        // Decrement comment count on the post
                        const postCard = document.querySelector(`.post-card[data-post-card-id="${postId}"]`);
                        if (postCard) {
                            const commentCountSpan = postCard.querySelector('.comment-count');
                            let currentCount = parseInt(commentCountSpan.textContent) || 0;
                            commentCountSpan.textContent = currentCount > 0 ? currentCount - 1 : 0;
                        }

                        console.log(`Comment ${commentId} deleted successfully.`);

                        // If the last comment was deleted, display the "No comments yet" message
                        const commentsContainer = document.querySelector(`.existing-comments-${postId}`);
                        if (commentsContainer && commentsContainer.children.length === 0) {
                            // Check if the placeholder already exists to avoid duplication
                            if (!commentsContainer.querySelector(`.no-comments-${postId}`)) {
                                commentsContainer.insertAdjacentHTML('beforeend', `
                                <div class="no-comments-${postId} text-center text-gray-500 text-sm py-2">
                                    No comments yet.
                                </div>
                                `);
                            }
                        }
                    } else {
                        // Handle error response (e.g., unauthorized)
                        response.json().then(errorData => {
                            alert('Failed to delete comment: ' + (errorData.message || 'Unknown error.'));
                        });
                    }
                })
                .catch(error => {
                    console.error('Error deleting comment:', error);
                    alert('An error occurred while trying to delete the comment.');
                });
        }

        // Close post dropdown when clicking outside
        document.addEventListener('click', function (event) {
            // Check if the click was outside of any dropdown button or menu
            if (!event.target.closest('[onclick^="toggleDropdown"]') && !event.target.closest('[id^="post-menu-"]')) {
                document.querySelectorAll('[id^="post-menu-"]').forEach(menu => {
                    if (!menu.classList.contains('hidden')) {
                        menu.classList.add('hidden');
                    }
                });
            }
        });
        // --- End Delete Functions ---

        // Toggles the visibility of the comments section
        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.classList.toggle('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const csrftoken = getCookie('csrftoken');

            // --- MODAL JS (Tailwind Modal Logic) ---
            const modal = document.getElementById('createPostModal');
            const openModalButton = document.querySelector('[data-modal-target="#createPostModal"]');
            const closeModalButtons = document.querySelectorAll('[data-modal-close]');

            if (openModalButton) {
                openModalButton.addEventListener('click', function () {
                    modal.classList.remove('hidden');
                });
            }

            closeModalButtons.forEach(button => {
                button.addEventListener('click', function () {
                    modal.classList.add('hidden');
                });
            });

            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }


            // --- Existing LIKE Logic ---
            const likeButtons = document.querySelectorAll('.like-btn');

            likeButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const postId = this.getAttribute('data-post-id');
                    const likeIcon = this.querySelector('i');
                    const likeCountSpan = this.querySelector('.like-count');

                    const url = `/community/${postId}/like/`;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                likeCountSpan.textContent = data.new_count;
                                if (data.action === 'liked') {
                                    likeIcon.classList.remove('far', 'text-gray-500');
                                    likeIcon.classList.add('fas', 'text-red-500');
                                } else {
                                    likeIcon.classList.remove('fas', 'text-red-500');
                                    likeIcon.classList.add('far', 'text-gray-500');
                                }
                            }
                        })
                        .catch(error => console.error('Error toggling like:', error));
                });
            });

            // --- NEW COMMENT Logic ---
            const commentForms = document.querySelectorAll('.add-comment-form');

            commentForms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const postId = this.getAttribute('data-post-id');
                    const url = this.getAttribute('action');
                    const contentInput = this.querySelector('textarea[name="content"]');
                    const content = contentInput.value.trim();

                    if (!content) {
                        alert('Comment content is required.');
                        return;
                    }

                    const formData = new FormData(form);

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData,
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errorData => {
                                    throw new Error(errorData.message || 'Validation Failed');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                contentInput.value = '';

                                // CRITICAL FIX: The updated HTML no longer includes the building icon in the comment meta data.
                                const newCommentHTML = `
                                <div class="comment-item border-l-2 border-gray-200 pl-3 py-1 mb-2 flex justify-between items-start" 
                                    data-comment-id="${data.comment_id}" data-post-id="${postId}">
                                    <div>
                                        <p class="mb-0 text-sm font-semibold">
                                            ${data.user_display_name} 
                                        </p>
                                        <p class="mb-0 text-xs text-gray-500">
                                            ${data.business_name}
                                            <span class="mx-1">•</span>
                                            ${data.created_at}
                                        </p>
                                        <p class="mb-0 text-ink">${data.content.replace(/\n/g, '<br>')}</p>
                                    </div>
                                    <button class="text-red-500 hover:text-red-700 p-1 text-sm flex-shrink-0"
                                            onclick="confirmDeleteComment(${postId}, ${data.comment_id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                `;

                                const commentsContainer = document.querySelector(`.existing-comments-${postId}`);
                                // Prepend or Append based on your required sort order, here we append.
                                commentsContainer.insertAdjacentHTML('beforeend', newCommentHTML);

                                const postCard = form.closest('.post-card');
                                const commentCountSpan = postCard.querySelector('.comment-count');
                                commentCountSpan.textContent = data.new_count;

                                const noCommentsMessage = document.querySelector(`.no-comments-${postId}`);
                                if (noCommentsMessage) {
                                    noCommentsMessage.remove();
                                }

                                const commentsSection = document.getElementById(`comments-${postId}`);
                                if (commentsSection.classList.contains('hidden')) {
                                    commentsSection.classList.remove('hidden');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error adding comment:', error);
                            alert('Failed to post comment. ' + error.message);
                        });
                });
            });
            // --- End New Comment Logic ---
        });
    </script>

    {% include 'accounts/logout_modal.html' %}

</body>

</html>